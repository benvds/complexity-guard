---
phase: 10.1-performance-benchmarks-and-fta-comparison
plan: 02
subsystem: infra
tags: [benchmarks, zig, subsystem-profiling, timing, pipeline-analysis]

# Dependency graph
requires:
  - phase: 10.1-01
    provides: Benchmark directory structure (benchmarks/src, scripts, results) and setup.sh
  - phase: 10-html-reports
    provides: Completed core product with all metrics (cyclomatic, cognitive, halstead, structural, health score)
provides:
  - Zig subsystem benchmark module (complexity-bench binary) profiling all 9 pipeline stages
  - src/lib.zig: CG library interface exposing pipeline namespaces via single module root
  - bench-subsystems.sh: shell wrapper running benchmark across project suites
  - Baseline subsystem timing results for 7 quick-suite projects (parsing identified as hotspot)
  - bench-build step in build.zig for compile-without-run workflow
affects:
  - "10.1-03 (metric accuracy comparison)"
  - "Phase 12 (parallelization design) — parsing identified as primary bottleneck"

# Tech tracking
tech-stack:
  added:
    - "std.time.Timer (nanosecond-precision monotonic timer for subsystem profiling)"
  patterns:
    - "Single cg module root (src/lib.zig): all src/ modules compiled together to avoid 'file exists in multiple modules' error"
    - "bench-build step: compile-only artifact install step separate from bench run step"
    - "dieWithMsg helper: unbuffered stderr write + process.exit for arg parser errors"
    - "Arena allocator for full benchmark lifecycle (short-lived process)"

key-files:
  created:
    - "benchmarks/src/benchmark.zig"
    - "src/lib.zig"
    - "benchmarks/scripts/bench-subsystems.sh"
    - "benchmarks/results/baseline-2026-02-21/*-subsystems.json (7 files)"
  modified:
    - "build.zig (bench + bench-build steps)"
    - "src/discovery/walker.zig (added pub FilterConfig re-export)"

key-decisions:
  - "Single cg module from src/lib.zig: Zig 0.15 forbids files reachable via multiple module paths ('file exists in modules X and Y'). All src/ files form one transitive dependency graph via relative imports, so they must be in one named module."
  - "bench-build step separate from bench: shell scripts call zig build bench-build to compile the binary, then invoke it directly with their own args, avoiding the bench step's run+args behavior"
  - "tree-sitter include paths on cg_mod: @cImport in tree_sitter.zig needs vendor/tree-sitter/lib/include — must be added to the module object, not just the compile step"
  - "walker.FilterConfig re-export: benchmark needs FilterConfig type from walker module; adding pub alias avoids creating a separate filter module that would cause file-in-multiple-modules error"
  - "Parsing identified as dominant hotspot: 40-64% of total pipeline time across all 7 quick-suite projects"

patterns-established:
  - "Zig benchmark pattern: std.time.Timer.start() + timer.reset() + timer.read() for nanosecond subsystem timing"
  - "9-stage pipeline measurement: file_discovery, file_read, parsing, cyclomatic, cognitive, halstead, structural, scoring, json_output"
  - "Statistical output: mean/stddev/min/max per subsystem across N iterations"
  - "Hotspot identification: largest mean time, shown as % of total pipeline"

requirements-completed:
  - "BENCH-SUBSYS: Zig-built benchmark module for subsystem profiling (parsing, analysis, output)"

# Metrics
duration: 16min
completed: 2026-02-21
---

# Phase 10.1 Plan 02: Zig Subsystem Benchmark Summary

**Zig complexity-bench binary profiling 9 pipeline stages (file discovery through JSON output) with nanosecond precision, revealing parsing as the dominant bottleneck at 40-64% of total time across all 7 quick-suite projects**

## Performance

- **Duration:** 16 min
- **Started:** 2026-02-21T07:32:03Z
- **Completed:** 2026-02-21T07:48:00Z
- **Tasks:** 2
- **Files modified:** 3 created + 1 modified for Task 1; 1 script + 7 JSON + build.zig for Task 2

## Accomplishments

- Created `benchmarks/src/benchmark.zig`: 9-stage pipeline profiler using `std.time.Timer` with N-iteration statistics (mean/stddev/min/max), structured table output, and optional JSON export matching the spec schema
- Created `src/lib.zig`: thin library interface re-exporting all pipeline namespaces; solves Zig 0.15 "file exists in multiple modules" constraint when benchmark needs multiple src/ modules
- Created `benchmarks/scripts/bench-subsystems.sh`: runs complexity-bench across quick/full/stress suite projects, generates per-project `*-subsystems.json`, prints aggregate hotspot summary
- Executed baseline subsystem benchmark on 7 quick-suite projects: parsing is hotspot in all 7 (40-64% of total), confirming Phase 12 parallelization should prioritize the parser

## Subsystem Timing Baseline (ReleaseFast, 2 runs)

| Project | Files | Parsing (ms) | Total (ms) | Hotspot % |
|---------|-------|-------------|------------|-----------|
| zod | 172 | 135.9 | 287.4 | 47.3% |
| got | 68 | 68.9 | 131.7 | 52.3% |
| dayjs | 283 | 102.1 | 217.8 | 46.9% |
| vite | 1182 | 283.0 | 491.8 | 57.6% |
| nestjs | 1653 | 376.4 | 592.1 | 63.6% |
| webpack | 6889 | 967.6 | 1759.7 | 55.0% |
| vscode | 5071 | 7939.7 | 19623.4 | 40.5% |

**Parsing dominates the pipeline in all projects.** Analysis metrics (cyclomatic/cognitive/halstead/structural) each take 10-20% individually but combined exceed parsing in total. Scoring and JSON output are negligible (<0.1%).

## Task Commits

Each task was committed atomically:

1. **Task 1: Create Zig subsystem benchmark module and build.zig bench step** - `adb3663` (feat)
2. **Task 2: Create bench-subsystems.sh and add bench-build step** - `562c0fb` (feat)

## Files Created/Modified

- `benchmarks/src/benchmark.zig` - 9-stage pipeline profiler with std.time.Timer, statistical analysis, tabular output, optional JSON export
- `src/lib.zig` - CG library interface re-exporting walker, parse, cyclomatic, cognitive, halstead, structural, scoring namespaces
- `src/discovery/walker.zig` - Added `pub const FilterConfig = filter.FilterConfig` re-export
- `build.zig` - Added bench step (compile+run), bench-build step (compile only), cg module with tree-sitter include paths and toml import
- `benchmarks/scripts/bench-subsystems.sh` - Shell wrapper: builds complexity-bench in ReleaseFast, runs against each suite project, aggregates hotspot summary
- `benchmarks/results/baseline-2026-02-21/*-subsystems.json` - Baseline timing data for 7 projects

## Decisions Made

- **Single cg module (src/lib.zig)**: Zig 0.15 enforces that a source file can belong to only one named module. All `src/` files share relative imports (e.g. `cyclomatic.zig` imports `../parser/tree_sitter.zig`), forming one transitive graph. Exposing them as multiple separate named modules causes "file exists in modules X and Y" compilation errors. Solution: one `cg` module rooted at `src/lib.zig`.
- **bench-build step**: Shell scripts need to compile the binary without running it (they invoke with their own args). Added `bench-build` as a compile-install step separate from the `bench` run step.
- **walker.FilterConfig re-export**: The benchmark imports `walker` as a named module and needs `FilterConfig` for `discoverFiles`. Creating a separate `filter` module would re-expose `filter.zig` in two modules. Adding a `pub const FilterConfig` alias to `walker.zig` solves this cleanly.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Zig module system conflict: "file exists in multiple modules"**
- **Found during:** Task 1 (first compile attempt)
- **Issue:** Plan proposed adding each `src/` file as a separate named module dependency. Zig 0.15 forbids a source file from belonging to multiple named modules when they share transitive relative imports (tree_sitter.zig is imported by both parse.zig and cyclomatic.zig via different paths).
- **Fix:** Created `src/lib.zig` as a single module root re-exporting all pipeline namespaces. One `cg` module instead of 8 separate ones.
- **Files modified:** `src/lib.zig` (created), `build.zig` (cg_mod instead of per-file modules)
- **Verification:** `zig build bench` compiles without errors
- **Committed in:** adb3663 (Task 1 commit)

**2. [Rule 1 - Bug] tree-sitter @cImport header not found in cg_mod**
- **Found during:** Task 1 (second compile attempt after module fix)
- **Issue:** `tree_sitter.zig` uses `@cImport(<tree_sitter/api.h>)`. The include path was added via `addTreeSitterSources(b, bench_exe)` (applied to the compile step), but the `cg` module object also needed its own include path registration for `@cImport` to resolve.
- **Fix:** Added `cg_mod.addIncludePath(...)` for all three tree-sitter include directories.
- **Files modified:** `build.zig`
- **Verification:** `zig build bench` compiles without errors; `@cImport` resolves correctly
- **Committed in:** adb3663 (Task 1 commit)

**3. [Rule 1 - Bug] `try X catch {}` invalid Zig syntax; flush() return type**
- **Found during:** Task 1 (compile errors in benchmark.zig)
- **Issue:** I wrote `try stdout.flush() catch {}` which is invalid Zig — cannot combine `try` and `catch` on the same expression. Also wrote `try stderr.flush() catch {}` which also fails. Additionally, arg parser error paths called `std.process.exit()` without flushing the buffered stderr writer, producing silent errors.
- **Fix:** Replaced with `stdout.flush() catch {}` (remove `try`). Created `dieWithMsg()` helper that uses `File.write()` (unbuffered) + `bufPrint` for immediate stderr writes before exit.
- **Files modified:** `benchmarks/src/benchmark.zig`
- **Verification:** Binary prints correct error messages to stderr on missing/invalid args
- **Committed in:** adb3663 (Task 1 commit)

**4. [Rule 3 - Blocking] `zig build bench` runs the benchmark; scripts need compile-only**
- **Found during:** Task 2 (script called `zig build bench -Doptimize=ReleaseFast` which triggered the run step with no args, causing exit 1)
- **Issue:** The `bench` step compiles AND runs the benchmark binary. Shell scripts need to compile the binary first, then invoke it directly with their own arguments. Using `zig build bench` causes the build system to run the binary with no args.
- **Fix:** Added `bench-build` step in `build.zig` that only installs the artifact without running. Updated `bench-subsystems.sh` to use `zig build bench-build -Doptimize=ReleaseFast`.
- **Files modified:** `build.zig`, `benchmarks/scripts/bench-subsystems.sh`
- **Verification:** `bash benchmarks/scripts/bench-subsystems.sh --runs 2` completes successfully
- **Committed in:** 562c0fb (Task 2 commit)

---

**Total deviations:** 4 auto-fixed (3 Rule 1 bugs, 1 Rule 3 blocking)
**Impact on plan:** All fixes necessary for correct operation. The Zig module system constraint (deviation 1) required a small architectural adjustment (src/lib.zig) that actually improves the codebase structure. No scope creep.

## Issues Encountered

- Zig 0.15.2 module system is stricter than documented: a source file cannot be transitively reachable via multiple named module paths. This required discovering the single-module-root pattern (src/lib.zig) rather than the per-file module approach the plan suggested. The final approach is cleaner and more maintainable.

## Next Phase Readiness

- Subsystem benchmark infrastructure is complete: `zig build bench-build -Doptimize=ReleaseFast` + direct binary invocation pattern works
- Key finding for Phase 12: parsing dominates at 40-64% of total pipeline time in all tested projects; parallelization design should prioritize parallel parsing
- Plan 03 (metric accuracy comparison) can proceed using existing benchmark infrastructure
- The 7 baseline JSON files provide before/after comparison points for Phase 12 parallelization work

## Self-Check: PASSED

All key files verified to exist:
- benchmarks/src/benchmark.zig - FOUND
- src/lib.zig - FOUND
- benchmarks/scripts/bench-subsystems.sh - FOUND
- benchmarks/results/baseline-2026-02-21/zod-subsystems.json - FOUND
- benchmarks/results/baseline-2026-02-21/vscode-subsystems.json - FOUND
- .planning/phases/10.1-performance-benchmarks-and-fta-comparison/10.1-02-SUMMARY.md - FOUND (this file)

All commits verified:
- adb3663 (Task 1: Zig benchmark module and bench step) - FOUND
- 562c0fb (Task 2: bench-subsystems.sh and bench-build step) - FOUND

---
*Phase: 10.1-performance-benchmarks-and-fta-comparison*
*Completed: 2026-02-21*
