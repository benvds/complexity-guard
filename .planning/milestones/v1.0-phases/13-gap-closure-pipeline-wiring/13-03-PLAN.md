---
phase: 13-gap-closure-pipeline-wiring
plan: "03"
type: execute
wave: 2
depends_on: ["13-02"]
files_modified:
  - src/cli/init.zig
  - docs/cli-reference.md
autonomous: true
requirements: [CFG-04]
gap_closure: true

must_haves:
  truths:
    - "--init generates config with ALL 12 threshold categories"
    - "--init generates config with duplication thresholds (file_warning, file_error, project_warning, project_error)"
    - "--init generates config with files.include patterns"
    - "--init generates config with duplication weight 0.20 in weights"
    - "--init generates config with all standard options (output, analysis, files, weights, baseline)"
  artifacts:
    - path: "src/cli/init.zig"
      provides: "Complete config generation for JSON and TOML"
      contains: "halstead_volume"
    - path: "src/cli/init.zig"
      provides: "Complete config generation for JSON and TOML"
      contains: "nesting_depth"
  key_links:
    - from: "src/cli/init.zig"
      to: "src/cli/config.zig"
      via: "Generated config covers all ThresholdsConfig fields"
      pattern: "all 12 threshold categories from ThresholdsConfig"
---

<objective>
Expand --init config generation to emit ALL available options with sensible defaults.

Purpose: Currently generateJsonConfig and generateTomlConfig only emit cyclomatic and cognitive thresholds (2 of 12 categories). Users need a complete reference config to discover and customize all available options. The generated config should serve as documentation-by-example.
Output: Complete config generation covering all threshold categories, include patterns, baseline placeholder, and all weights.
</objective>

<execution_context>
@/home/ben/.claude/get-shit-done/workflows/execute-plan.md
@/home/ben/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-gap-closure-pipeline-wiring/13-UAT.md
@.planning/debug/save-baseline-init-config.md
@.planning/phases/13-gap-closure-pipeline-wiring/13-01-SUMMARY.md
@src/cli/config.zig
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand generateJsonConfig and generateTomlConfig to emit complete config</name>
  <files>
    src/cli/init.zig
  </files>
  <action>
Rewrite `generateJsonConfig` in src/cli/init.zig to produce a complete config that covers ALL configurable options. The function signature can change -- the ThresholdPreset struct is no longer needed since we're hardcoding ALL defaults directly.

Remove the ThresholdPreset struct entirely (lines 10-15) and the getThresholdPreset function (lines 18-42). They only covered cyclomatic/cognitive and are no longer needed.

The new generateJsonConfig should produce this exact JSON structure (hand-write the output string, same approach as current code):

```json
{
  "output": {
    "format": "console"
  },
  "analysis": {
    "metrics": ["cyclomatic", "cognitive", "halstead", "nesting", "line_count", "params_count"],
    "thresholds": {
      "cyclomatic": { "warning": 10, "error": 20 },
      "cognitive": { "warning": 15, "error": 25 },
      "halstead_volume": { "warning": 500, "error": 1000 },
      "halstead_difficulty": { "warning": 10, "error": 20 },
      "halstead_effort": { "warning": 5000, "error": 10000 },
      "halstead_bugs": { "warning": 1, "error": 2 },
      "nesting_depth": { "warning": 3, "error": 5 },
      "line_count": { "warning": 25, "error": 50 },
      "params_count": { "warning": 3, "error": 6 },
      "file_length": { "warning": 300, "error": 600 },
      "export_count": { "warning": 15, "error": 30 },
      "duplication": {
        "file_warning": 15.0,
        "file_error": 25.0,
        "project_warning": 5.0,
        "project_error": 10.0
      }
    }
  },
  "files": {
    "include": ["**/*.ts", "**/*.tsx", "**/*.js", "**/*.jsx"],
    "exclude": ["node_modules", "dist", "build", ".git"]
  },
  "weights": {
    "cognitive": 0.30,
    "cyclomatic": 0.20,
    "duplication": 0.20,
    "halstead": 0.15,
    "structural": 0.15
  },
  "baseline": null
}
```

Key points:
- halstead_bugs uses integer defaults (1, 2) matching ThresholdPair u32 schema (not the f64 0.5/2.0 from the metric module)
- duplication thresholds use the DuplicationThresholds format with file_warning/file_error/project_warning/project_error as floats
- files.include is added with the four standard TS/JS glob patterns
- baseline is included as null (placeholder for users to set)
- No --save-baseline reference anywhere
- Weights include duplication: 0.20

Update runInit to call generateJsonConfig with simplified arguments (just allocator and filename, since we no longer need preset or exclude_patterns params -- all defaults are hardcoded in the function).

Similarly update `generateTomlConfig` to emit the complete config in TOML format:

```toml
# ComplexityGuard Configuration

[output]
format = "console"

[analysis]
metrics = ["cyclomatic", "cognitive", "halstead", "nesting", "line_count", "params_count"]

[analysis.thresholds.cyclomatic]
warning = 10
error = 20

[analysis.thresholds.cognitive]
warning = 15
error = 25

[analysis.thresholds.halstead_volume]
warning = 500
error = 1000

[analysis.thresholds.halstead_difficulty]
warning = 10
error = 20

[analysis.thresholds.halstead_effort]
warning = 5000
error = 10000

[analysis.thresholds.halstead_bugs]
warning = 1
error = 2

[analysis.thresholds.nesting_depth]
warning = 3
error = 5

[analysis.thresholds.line_count]
warning = 25
error = 50

[analysis.thresholds.params_count]
warning = 3
error = 6

[analysis.thresholds.file_length]
warning = 300
error = 600

[analysis.thresholds.export_count]
warning = 15
error = 30

[analysis.thresholds.duplication]
file_warning = 15.0
file_error = 25.0
project_warning = 5.0
project_error = 10.0

[files]
include = ["**/*.ts", "**/*.tsx", "**/*.js", "**/*.jsx"]
exclude = ["node_modules", "dist", "build", ".git"]

[weights]
cognitive = 0.30
cyclomatic = 0.20
duplication = 0.20
halstead = 0.15
structural = 0.15

# baseline = 75.0
```

Note: In TOML, baseline is commented out as a placeholder showing the syntax.

Update existing tests:
- The "getThresholdPreset returns all strictness levels" and "moderate preset has expected values" tests should be removed (ThresholdPreset is gone).
- Update "generateJsonConfig produces valid JSON structure" test to also check for new threshold keys: "halstead_volume", "nesting_depth", "file_length", "duplication", "include", "baseline".
- Update "generateTomlConfig produces valid TOML structure" test to also check for new threshold sections: "halstead_volume", "nesting_depth", "file_length", "duplication", "include".
- Update the generateJsonConfig and generateTomlConfig calls in tests to use the new simplified function signatures.
  </action>
  <verify>
Run `zig build test` -- all tests pass.
Run the binary with --init in a temp dir to verify the generated config: `cd /tmp && /path/to/complexity-guard --init && cat .complexityguard.json && rm .complexityguard.json`
Verify the output includes all 12 threshold categories, files.include, duplication weight, and baseline.
  </verify>
  <done>
generateJsonConfig produces complete config with all 12 ThresholdsConfig categories, duplication thresholds, files.include patterns, all 5 weights (including duplication 0.20), and baseline null. generateTomlConfig produces equivalent TOML. ThresholdPreset struct and getThresholdPreset function removed. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CLI reference docs for --init</name>
  <files>
    docs/cli-reference.md
  </files>
  <action>
In docs/cli-reference.md, update the --init flag description (around line 54-62) to mention that the generated config includes all available threshold categories:

Change the description from:
"Generate a `.complexityguard.json` configuration file with default thresholds and weights."

To:
"Generate a `.complexityguard.json` configuration file with all available options and sensible defaults. The generated file includes every threshold category, file patterns, metric weights, and a baseline placeholder â€” edit it to customize for your project."

Also update the short description after the code example. Change:
"Creates a config file with standard thresholds, default metric weights, and common exclude patterns. Edit the generated file to customize for your project."

To:
"Creates a comprehensive config file covering all 12 threshold categories (cyclomatic, cognitive, Halstead, structural, duplication), file include/exclude patterns, metric weights, and a baseline placeholder. Edit the generated file to customize for your project."
  </action>
  <verify>
Read the updated cli-reference.md --init section to verify it accurately describes the new complete config output.
Verify no broken links or formatting issues in the surrounding text.
  </verify>
  <done>
The --init documentation accurately describes that the generated config includes all available options. No reference to ThresholdPreset or presets. The description matches what the code actually produces.
  </done>
</task>

</tasks>

<verification>
1. `zig build test` passes with no errors
2. `complexity-guard --init` in a temp dir produces JSON with all 12 threshold categories
3. Generated config includes files.include, duplication weight 0.20, and baseline null
4. Generated config is valid JSON (parseable by the tool's own config loader)
5. docs/cli-reference.md --init description matches actual output
</verification>

<success_criteria>
--init generates a complete, comprehensive config file that serves as documentation-by-example for all available options. Users can immediately see and customize every threshold, weight, and setting without consulting external docs. The generated config includes all 12 ThresholdsConfig categories, duplication thresholds, files.include patterns, duplication weight 0.20, and a baseline placeholder.
</success_criteria>

<output>
After completion, create `.planning/phases/13-gap-closure-pipeline-wiring/13-03-SUMMARY.md`
</output>
