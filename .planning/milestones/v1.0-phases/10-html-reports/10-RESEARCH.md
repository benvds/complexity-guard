# Phase 10: HTML Reports - Research

**Researched:** 2026-02-18
**Domain:** Self-contained HTML report generation from Zig — string building, CSS/SVG visualizations, pure-JS interactivity
**Confidence:** HIGH

## Summary

Phase 10 adds a `--format html` output mode that generates a single self-contained HTML file with all CSS and JavaScript inlined. The existing output pipeline (console/json/sarif) follows a clear pattern: a dedicated `src/output/X_output.zig` module with builder and serializer functions, wired into `main.zig` via a format-dispatch `else if` branch. The HTML module will follow the identical structure.

The primary challenge is not integration — the pattern is proven and well-understood — but rather producing quality HTML from Zig's string-building primitives. Zig's `std.ArrayList(u8)` used as a string buffer with its `.writer()` method is the standard approach for this kind of templated output generation. The HTML template itself will be non-trivial: dashboard hotspot cards, expandable file rows, sortable metric tables, a CSS/SVG treemap, and a distribution bar. All of this must be inlined into one file with no external runtime dependencies.

The decisions in CONTEXT.md lock in all major architectural choices: PicoCSS-inspired minimal styling, `prefers-color-scheme` for light/dark, pure CSS/SVG for visualizations (treemap + metric bars), JavaScript only for sort and expand/collapse, no charting libraries. Research focuses on how to execute these locked decisions well, plus discretionary details (treemap SVG algorithm, sort implementation, expand/collapse pattern, typography).

**Primary recommendation:** Generate the HTML using a single `buildHtmlReport` function that writes to an `std.ArrayList(u8)` via its `.writer()`. Embed all CSS and JS as string literals directly in the Zig source file. Compute the SVG treemap coordinates in Zig at generation time using a squarified algorithm (Bruls et al.) to avoid needing JavaScript for layout. Use JavaScript only for table sorting and expand/collapse.

---

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions

#### Dashboard layout
- Hotspot-first design: top 5 worst functions displayed as cards with context (function name, file, all metric scores, violated thresholds)
- Health score + file breakdown shown alongside hotspots: project health score with visual distribution bar showing healthy/warning/error file proportions
- Summary stats include: total files, total functions, files with errors, files with warnings, plus distribution bar

#### File/function drill-down
- Expandable rows: file list below dashboard, click to expand and see functions inline
- Collapsed file rows show: file path + health score with color indicator (minimal, scan-friendly)
- Expanded function detail: metric table with columns for each metric (cyclomatic, cognitive, Halstead volume, etc.)
- File list sortable by clicking column headers (health score, function count, worst violation)

#### Visual style & branding
- Respect system color scheme preference (CSS prefers-color-scheme for auto light/dark)
- Minimal branding: small "Generated by ComplexityGuard" footer with timestamp
- Progressive density: scannable at first glance (dashboard), dense when drilling down (function tables)
- Threshold colors: muted/neutral for healthy, subtle yellow for warnings, strong red for errors — emphasis on problems, not noise
- PicoCSS-inspired: semantic HTML, class-light, clean and minimal styling

#### Data visualizations
- Rich visualizations using pure CSS/SVG (no JS charting library dependency)
- Project overview: treemap (files as rectangles sized by function count, colored by health score) + bar chart (files ranked by health score)
- Function-level: inline metric bars next to each value showing proximity to threshold
- All visualizations self-contained — no external dependencies

#### Responsiveness
- Fully responsive: works on both mobile and desktop
- Single self-contained HTML file with all CSS and JavaScript inlined

### Claude's Discretion
- Exact treemap/bar chart SVG implementation approach
- Sorting algorithm for interactive column headers
- Expand/collapse animation style
- Typography and spacing choices within PicoCSS-inspired aesthetic
- Dark mode color palette specifics

### Deferred Ideas (OUT OF SCOPE)
None — discussion stayed within phase scope
</user_constraints>

---

<phase_requirements>
## Phase Requirements

| ID | Description | Research Support |
|----|-------------|-----------------|
| OUT-HTML-01 | Tool generates self-contained single-file HTML report (inline CSS/JS) | `std.ArrayList(u8)` writer pattern; all CSS/JS embedded as string literals in Zig source; no external file references in output |
| OUT-HTML-02 | Tool includes project summary dashboard with health score and grade | `project_score: f64` already computed in main.zig; grade derived from score (>=90=A, >=80=B, >=65=C, >=50=D, else=F); `FileThresholdResults` provides per-function data for hotspot cards |
| OUT-HTML-03 | Tool includes per-file breakdown with expandable function details | File row rendered from `FileThresholdResults`; expand/collapse via vanilla JS click handler toggling CSS class; per-function `ThresholdResult` fields populate metric table |
| OUT-HTML-04 | Tool includes sortable tables by any metric | Pure vanilla JS sort algorithm operating on DOM rows; no external dependency; column headers with `data-sort` attributes drive sort key selection |
</phase_requirements>

---

## Standard Stack

### Core

| Component | Version | Purpose | Why Standard |
|-----------|---------|---------|--------------|
| `std.ArrayList(u8)` | Zig 0.14.0 stdlib | String buffer for HTML generation | The standard Zig string builder pattern; `.writer()` gives a typed writer compatible with `std.fmt` |
| `std.fmt.bufPrint` / `.print()` on ArrayList writer | Zig 0.14.0 stdlib | Interpolate Zig values into HTML fragments | Already used throughout codebase; no new dependencies |
| Vanilla JavaScript (ES2020) | Browser native | Sort + expand/collapse interactivity | No CDN dependency; inlined in HTML; minimal and universally supported |
| Pure CSS + SVG | Browser native | All visualizations (treemap, metric bars, distribution bar) | Locked decision; eliminates JS charting library |

### Supporting

| Component | Version | Purpose | When to Use |
|-----------|---------|---------|-------------|
| CSS `prefers-color-scheme` media query | CSS Level 5 | Auto light/dark mode | Used in the single `<style>` block to define dark-mode color overrides |
| CSS custom properties (variables) | CSS Level 4 | Theme colors for health states | Define `--color-ok`, `--color-warning`, `--color-error` and override in dark mode |
| SVG `<rect>` + `<text>` elements | SVG 1.1 | Treemap tiles and file health bar chart | Coordinates computed in Zig at generation time |
| HTML `<details>` / `<summary>` | HTML5 | Expand/collapse (no-JS fallback) | Can be used for simpler cases; JS-driven approach gives more control |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Computing treemap in Zig | Compute in JS at runtime | JS approach avoids Zig arithmetic complexity but requires JS for visualization (against spirit of "pure CSS/SVG") — compute in Zig |
| Vanilla JS sort | `<details>/<summary>` for expand only | `<details>` cannot sort tables; vanilla JS needed for sortable columns |
| Embedding CSS/JS as raw string literals in Zig | External `.html` template file | Template files require build system embedding; raw literals in source are simpler and fully self-contained |

**Installation:** No new dependencies. The HTML output module is pure Zig using stdlib only.

---

## Architecture Patterns

### Recommended Project Structure

```
src/
├── output/
│   ├── console.zig          # existing
│   ├── json_output.zig      # existing
│   ├── sarif_output.zig     # existing
│   └── html_output.zig      # NEW — Phase 10
```

No new directories needed. Follows the exact same module pattern as sarif/json.

### Pattern 1: HTML Builder Function

**What:** Single public function `buildHtmlReport` that takes all needed data and returns a heap-allocated `[]u8` containing the complete HTML document.

**When to use:** Follows the exact signature pattern of `buildJsonOutput` / `buildSarifOutput`. Called in `main.zig` format dispatch. The caller owns the returned slice and calls `allocator.free()`.

**Example:**
```zig
// src/output/html_output.zig
pub fn buildHtmlReport(
    allocator: Allocator,
    file_results: []const console.FileThresholdResults,
    warning_count: u32,
    error_count: u32,
    project_score: f64,
    tool_version: []const u8,
) ![]u8 {
    var buf = std.ArrayList(u8).empty;
    defer buf.deinit(allocator);
    const w = buf.writer(allocator);

    try w.writeAll("<!DOCTYPE html>\n<html lang=\"en\">\n");
    try writeHead(w, allocator);
    try writeBody(w, allocator, file_results, warning_count, error_count, project_score, tool_version);
    try w.writeAll("</html>\n");

    return try allocator.dupe(u8, buf.items);
}
```

**Note on Zig 0.14 ArrayList API:** In Zig 0.14, `std.ArrayList` uses `.empty` for initialization and `.writer(allocator)` takes the allocator. Verify against existing codebase usage — `sarif_output.zig` uses `std.ArrayList(SarifResult).empty` and `defer rules.deinit(allocator)` with `try rules.append(allocator, ...)`.

### Pattern 2: Helper Writer Functions

**What:** Break HTML generation into private `write*` helpers that accept the writer and render one section of the page at a time.

**When to use:** Keeps the main builder readable. Each section (head, dashboard, hotspots, file list, footer) gets its own function.

**Example:**
```zig
fn writeDashboard(
    w: anytype,
    allocator: Allocator,
    project_score: f64,
    file_results: []const console.FileThresholdResults,
) !void {
    try w.writeAll("<section class=\"dashboard\">\n");
    try writeHealthScore(w, project_score);
    try writeDistributionBar(w, allocator, file_results);
    try writeHotspots(w, allocator, file_results);
    try w.writeAll("</section>\n");
}
```

### Pattern 3: Treemap SVG Computed in Zig

**What:** Implement Bruls et al. squarified treemap algorithm in Zig. Files are rectangles sized by function count, colored by health score. Output is SVG `<rect>` and `<text>` elements with computed x/y/width/height attributes.

**When to use:** Required by the locked decision "pure CSS/SVG, no JS charting library." Computing coordinates at generation time in Zig means the SVG is static HTML — no JavaScript needed for the visualization.

**Algorithm summary (squarified):**
1. Normalize file function counts to fractions of total SVG area.
2. Iterate through sorted list, place tiles into rows using the squarify criterion (minimize worst aspect ratio).
3. For each tile, emit `<rect x="{x}" y="{y}" width="{w}" height="{h}" fill="{color}" .../>`.
4. Overlay `<text>` with truncated filename centered in the tile.

**Color mapping for treemap tiles:**
```zig
fn healthScoreToColor(score: f64, dark_mode: bool) []const u8 {
    // Returns CSS variable reference — actual color resolved by browser
    if (score >= 80.0) return "var(--color-ok-bg)";
    if (score >= 50.0) return "var(--color-warning-bg)";
    return "var(--color-error-bg)";
}
```

Since dark/light mode is CSS-driven at runtime, the SVG `fill` should use CSS variables, not hardcoded hex. SVG `<rect fill="var(--color-ok-bg)">` works in modern browsers.

### Pattern 4: Grade Computation

**What:** Convert `project_score: f64` (0–100) to a letter grade string.

**Implementation:**
```zig
fn scoreToGrade(score: f64) []const u8 {
    if (score >= 90.0) return "A";
    if (score >= 80.0) return "B";
    if (score >= 65.0) return "C";
    if (score >= 50.0) return "D";
    return "F";
}
```

**Note:** The `grade` field exists on `core/types.zig:ProjectResult` as `?[]const u8` but is currently always `null`. The HTML module should compute grade locally without modifying types.zig.

### Pattern 5: main.zig Format Dispatch Wiring

**What:** Add `else if (std.mem.eql(u8, effective_format, "html"))` branch in `main.zig`, mirroring the json and sarif branches exactly. Handles `--output-file` and stdout.

**When to use:** Required by OUT-HTML-01. The "html" format string is already listed as a valid value in `config.zig:OutputConfig.format` comments.

### Pattern 6: File-Level Health Score Computation

**What:** The HTML report needs a per-file health score for hotspot cards and file rows. `FileThresholdResults` has no `health_score` field directly, but each `ThresholdResult` in `results` has `health_score: f64`. Average them.

**Implementation:**
```zig
fn computeFileHealthScore(results: []const cyclomatic.ThresholdResult) f64 {
    if (results.len == 0) return 100.0;
    var sum: f64 = 0.0;
    for (results) |r| sum += r.health_score;
    return sum / @as(f64, @floatFromInt(results.len));
}
```

This pattern is already used in `sarif_output.zig` lines 560-566.

### Pattern 7: Hotspot Selection

**What:** For the hotspot cards (top 5 worst functions by health score), collect all `ThresholdResult` items across all files, sort descending by `health_score` (ascending score = worst), take first 5.

**Note:** Sort in Zig: use `std.sort.sort(ThresholdResultWithPath, slice, {}, lessThanByScore)` with a custom comparator struct. Or collect into an ArrayList and sort with `std.mem.sort`.

### Anti-Patterns to Avoid

- **Generating the SVG treemap in JavaScript:** The locked decision requires pure CSS/SVG. Coordinate computation must happen in Zig at generation time. JavaScript must not be used for visualization layout.
- **Referencing external CSS frameworks (PicoCSS CDN):** The requirement is "inline CSS/JS." All styles must be embedded in `<style>` tags. Take *inspiration* from PicoCSS — do not `<link>` to it.
- **String escaping omissions:** HTML-escape all user-provided strings (function names, file paths) using `<`, `>`, `&`, `"` replacements. Function names from source code may contain characters that break HTML.
- **Large template strings with mixed Zig code:** Keep CSS and JS in clearly delimited `const` string blocks, not scattered inline. Easier to test and maintain.
- **Testing only the main function:** Test `scoreToGrade`, `computeFileHealthScore`, color mapping, and SVG coordinate logic as standalone functions with inline tests.

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Table sort algorithm | Custom comparator UI | ~20 lines of vanilla JS with `data-sort` attributes | Well-established pattern; sort by `parseFloat` for numeric columns, `localeCompare` for string columns |
| Expand/collapse animation | Custom CSS animation framework | CSS `max-height` transition on a `.expanded` class, toggled by JS click handler | Simple, no JS library needed |
| Treemap layout | Custom tile-packing algorithm | Squarified algorithm (Bruls 1999) — implement the ~40-line core in Zig | Squarified produces better aspect ratios than slice-and-dice; algorithm is small enough to implement in-module |
| HTML entity escaping | Custom regex/replace | Simple linear scan replacing `<`, `>`, `&`, `"` characters | No regex needed; straightforward iteration |
| Timestamp formatting | Custom date formatter | `std.time.timestamp()` gives Unix seconds; format as ISO-8601 with `std.fmt.allocPrint` | Already used for JSON output via `timestamp: i64` field |

**Key insight:** The whole module is "don't hand-roll" territory for its own domain — the HTML/CSS/JS template content is standard web development knowledge, not bespoke algorithms. The only genuinely novel piece is computing the squarified treemap layout in Zig.

---

## Common Pitfalls

### Pitfall 1: HTML Injection from Function Names or File Paths

**What goes wrong:** A function named `<T extends Record<string, unknown>>` or a file path containing `&` causes broken HTML or XSS.
**Why it happens:** Zig `std.fmt` writes values verbatim — no automatic HTML escaping.
**How to avoid:** Implement an `htmlEscape(allocator, s)` helper and call it on every user-provided string before writing to the HTML buffer.
**Warning signs:** Test with a fixture file containing a generic TypeScript function — the test will produce visually broken HTML.

### Pitfall 2: SVG CSS Variable Fill in Older Browsers

**What goes wrong:** `<rect fill="var(--color-ok-bg)">` does not work in very old browsers (IE, old Edge).
**Why it happens:** SVG `fill` did not support CSS custom properties in legacy browsers.
**How to avoid:** This is acceptable given ComplexityGuard targets developer tooling contexts. Document minimum browser requirement as "modern browsers (Chrome 80+, Firefox 75+, Safari 13.1+)" where CSS variables in SVG work. No fallback needed.
**Warning signs:** If you test in IE11, tiles show no fill color.

### Pitfall 3: Zig 0.14 ArrayList API vs. Older Docs

**What goes wrong:** Online Zig resources often show `std.ArrayList(u8).init(allocator)` and `.writer()` without allocator arg.
**Why it happens:** Zig 0.14 changed ArrayList to use `.empty` initialization and allocator-passing to all methods.
**How to avoid:** Follow existing codebase patterns exactly. `sarif_output.zig` shows the correct 0.14 pattern: `std.ArrayList(SarifRule).empty`, `defer rules.deinit(allocator)`, `try rules.append(allocator, ...)`. For `ArrayList(u8)`, use `buf.writer(allocator)`.
**Warning signs:** Compiler error "no field 'init' in struct 'ArrayList'" — switch to `.empty` + allocator-passing pattern.

### Pitfall 4: File Score Computation Inconsistency

**What goes wrong:** The HTML report shows different file health scores than the console output.
**Why it happens:** Computing per-file score ad hoc in the HTML module using a different averaging method than `scoring.computeFileScore`.
**How to avoid:** Look at `scoring.computeFileScore` — it takes `[]f64` (function scores) and `computeProjectScore` weights by function count. The HTML module should call `scoring.computeFileScore` or replicate its exact logic.
**Warning signs:** File scores in HTML differ from scores in console output for the same run.

### Pitfall 5: Treemap Tiles with Zero Function Count

**What goes wrong:** Files with 0 functions get a tile with 0 area and degenerate rectangles (division by zero in the squarified algorithm).
**Why it happens:** The squarify algorithm divides by total area; a zero-weight item causes NaN dimensions.
**How to avoid:** Skip files with 0 functions from the treemap, or give them a minimum width of 1 function count. Add a guard in the squarify implementation.
**Warning signs:** NaN in SVG width/height attributes, or a single file dominating the entire treemap.

### Pitfall 6: Large HTML Output Exceeding Arena Allocator

**What goes wrong:** For large projects, the HTML string may be multi-megabyte. Arena allocator in main.zig holds everything until exit, which is fine for this use case.
**Why it happens:** Not actually a problem — the arena is not freed until process exit. Just be aware of memory footprint.
**How to avoid:** Use `std.ArrayList(u8)` with `ensureTotalCapacity` pre-allocation if needed. For most projects the HTML will be under 1 MB.

### Pitfall 7: Sort Stability and Null Metrics

**What goes wrong:** Sorting the function table by Halstead volume crashes or produces garbage when Halstead is 0.0 (structural-only run).
**Why it happens:** Default `halstead_volume = 0` for functions analyzed without Halstead metrics. Sorting still works but shows misleading zeros.
**How to avoid:** In the JS sort, treat 0.0 as "not available" and sort nullish values to the end. In the Zig output, show "—" instead of "0.0" when Halstead is 0.

---

## Code Examples

Verified patterns from codebase and Zig stdlib:

### ArrayList(u8) as HTML String Builder

```zig
// Pattern verified from sarif_output.zig and Zig stdlib docs
pub fn buildHtmlReport(allocator: Allocator, ...) ![]u8 {
    var buf = std.ArrayList(u8).empty;
    defer buf.deinit(allocator);
    const w = buf.writer(allocator);

    try w.writeAll("<!DOCTYPE html>\n");
    try w.print("<title>ComplexityGuard v{s}</title>\n", .{tool_version});
    // ... more writes ...

    return try allocator.dupe(u8, buf.items);
    // Caller owns the returned slice: defer allocator.free(html)
}
```

### HTML Escape Helper

```zig
fn writeHtmlEscaped(w: anytype, s: []const u8) !void {
    for (s) |c| {
        switch (c) {
            '<' => try w.writeAll("&lt;"),
            '>' => try w.writeAll("&gt;"),
            '&' => try w.writeAll("&amp;"),
            '"' => try w.writeAll("&quot;"),
            else => try w.writeByte(c),
        }
    }
}
```

### SVG Metric Bar (Inline Progress Bar)

```html
<!-- Per-function metric bar: value relative to thresholds -->
<div class="metric-bar">
  <div class="metric-bar__fill metric-bar__fill--warning"
       style="width: 65%"></div>
</div>
```

The percentage is computed in Zig:
```zig
// percentage = min(100, (value / error_threshold) * 100)
const pct = @min(100.0, (value / error_threshold) * 100.0);
try w.print("<div class=\"metric-bar__fill {s}\" style=\"width: {d:.0}%\"></div>",
    .{ statusClass(status), pct });
```

### Vanilla JS Sort (Inline in HTML)

```javascript
// Inlined in <script> block — no external dependencies
function sortTable(tableId, colIndex, type) {
  const table = document.getElementById(tableId);
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const asc = table.dataset.sortCol == colIndex && table.dataset.sortDir == 'asc';
  rows.sort((a, b) => {
    const av = a.cells[colIndex].dataset.value;
    const bv = b.cells[colIndex].dataset.value;
    if (type === 'num') return asc ? parseFloat(bv) - parseFloat(av) : parseFloat(av) - parseFloat(bv);
    return asc ? bv.localeCompare(av) : av.localeCompare(bv);
  });
  rows.forEach(r => tbody.appendChild(r));
  table.dataset.sortCol = colIndex;
  table.dataset.sortDir = asc ? 'desc' : 'asc';
}
```

Rendered cell pattern: `<td data-value="85.4">85</td>` — `data-value` holds the raw numeric value for sorting; display text may be rounded.

### Expand/Collapse Row Pattern

```javascript
// Event delegation on the file table — one handler for all rows
document.getElementById('file-table').addEventListener('click', (e) => {
  const row = e.target.closest('tr.file-row');
  if (!row) return;
  const detailRow = document.getElementById('detail-' + row.dataset.fileId);
  if (detailRow) {
    detailRow.classList.toggle('expanded');
    row.setAttribute('aria-expanded', detailRow.classList.contains('expanded'));
  }
});
```

CSS:
```css
.detail-row { display: none; }
.detail-row.expanded { display: table-row; }
/* Optional animation: */
.detail-row td { overflow: hidden; transition: max-height 0.2s ease; }
```

### Distribution Bar (Pure CSS)

```html
<!-- Three-segment CSS flexbox bar -->
<div class="dist-bar">
  <div class="dist-bar__ok"      style="flex: 12"></div>
  <div class="dist-bar__warning" style="flex: 3"></div>
  <div class="dist-bar__error"   style="flex: 2"></div>
</div>
```

Flex values are the file counts in each health category. No JS needed.

### Squarified Treemap Core Algorithm (Zig)

```zig
// Simplified squarified layout — compute rects for files sorted by function count desc
// Input: files[] with .weight (function_count as f64) and .score (health_score)
// Output: Rect[] with .x, .y, .w, .h (all f64, relative to SVG viewBox)
const Rect = struct { x: f64, y: f64, w: f64, h: f64, file_index: usize };

fn squarify(
    allocator: Allocator,
    files: []const FileWeight,    // sorted descending by weight
    total_w: f64,
    total_h: f64,
) ![]Rect {
    // Implementation of Bruls et al. squarified algorithm
    // ~50 lines — see architecture section for full pseudocode
}
```

The full squarified algorithm is well-documented (Bruls 1999). It recursively fills rows of rectangles, greedily adding tiles until the aspect ratio would worsen, then starts a new row.

### main.zig Dispatch Wiring

```zig
// In main.zig, after the sarif branch (line ~599):
} else if (std.mem.eql(u8, effective_format, "html")) {
    const html_str = try html_output.buildHtmlReport(
        arena_allocator,
        file_results,
        total_warnings,
        total_errors,
        project_score,
        version,
    );
    defer arena_allocator.free(html_str);

    if (cli_args.output_file) |output_path| {
        const file = try std.fs.cwd().createFile(output_path, .{});
        defer file.close();
        try file.writeAll(html_str);
    } else {
        try stdout.writeAll(html_str);
        try stdout.writeAll("\n");
    }
}
```

---

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Separate CSS/JS files linked from HTML | Inlined CSS+JS in single HTML | Project decision | Zero external dependencies at runtime |
| D3.js/Chart.js for visualizations | Pure CSS/SVG for charts | Project decision | Eliminates ~300KB JS dependency; treemap logic computed at generation time |
| `ArrayList.init(allocator)` | `ArrayList.empty` + allocator-passing | Zig 0.14 | Breaking API change; must follow 0.14 patterns |
| `writer()` with no args | `writer(allocator)` | Zig 0.14 | Same breaking change in ArrayList API |

**Deprecated/outdated:**
- `std.ArrayList(T).init(allocator)`: Use `.empty` in Zig 0.14
- `list.writer()`: Use `list.writer(allocator)` in Zig 0.14

---

## Open Questions

1. **Grade thresholds for letter grade (A/B/C/D/F)**
   - What we know: The `grade` field in `ProjectResult` exists but is never computed — "Phase 7" comment. Console output shows only the numeric score.
   - What's unclear: Are there canonical threshold values defined anywhere in the planning docs or requirements?
   - Recommendation: Use `>=90=A, >=80=B, >=65=C, >=50=D, else=F` as sensible defaults. This is a standard software quality grading scale. Document in code comments.

2. **File health score for file rows — use `scoring.computeFileScore` or inline average?**
   - What we know: `scoring.computeFileScore([]f64)` exists and is called in main.zig. The HTML module receives `[]FileThresholdResults`, each with `results[].health_score`.
   - What's unclear: Should html_output import `scoring.zig` to call `computeFileScore`, or re-average inline?
   - Recommendation: Import `scoring.zig` and call `computeFileScore` to guarantee consistency with what main.zig computed. The function scores are already in `ThresholdResult.health_score`.

3. **Treemap SVG viewBox dimensions**
   - What we know: SVG needs fixed dimensions for the viewBox. The treemap should be responsive.
   - What's unclear: What viewBox width/height to use as the computation canvas.
   - Recommendation: Use `viewBox="0 0 800 400"` with `width="100%"` — scales responsively. Compute tile coordinates against 800x400 coordinate space.

4. **Hotspot "worst functions" definition**
   - What we know: CONTEXT says "top 5 worst functions displayed as cards." The `health_score` field on `ThresholdResult` is the composite score.
   - What's unclear: "Worst" means lowest health_score, or most violations, or highest cyclomatic?
   - Recommendation: Use lowest `health_score` (composite score) as the ranking criterion — this is the single unified signal that accounts for all metrics with weights. Tie-break by cyclomatic complexity.

---

## Sources

### Primary (HIGH confidence)
- Codebase analysis: `src/output/sarif_output.zig`, `src/output/json_output.zig` — verified ArrayList/writer patterns, format dispatch pattern, FileThresholdResults structure
- Codebase analysis: `src/main.zig` lines 482–629 — verified format dispatch, data available at HTML generation point, project_score computation
- Codebase analysis: `src/metrics/cyclomatic.zig` — verified ThresholdResult struct with all metric fields including `health_score: f64`
- Codebase analysis: `src/metrics/scoring.zig` — verified `computeFileScore`, `computeProjectScore` functions
- Codebase analysis: `src/cli/config.zig` — confirmed "html" is a recognized format value in `OutputConfig.format` comment

### Secondary (MEDIUM confidence)
- WebSearch: Vanilla JS table sort pattern — multiple sources confirm `data-value` + `parseFloat` approach; well-established pattern across many implementations
- WebSearch: SVG CSS variables for fill color — supported in Chrome 80+, Firefox 75+, Safari 13.1+ (modern browsers)
- WebSearch: Zig ArrayList writer pattern — confirmed by zig.guide and ziggit.dev community sources; consistent with codebase usage

### Tertiary (LOW confidence)
- WebSearch: Squarified treemap algorithm complexity — reported as ~40–60 lines for the core algorithm; needs implementation verification during coding
- WebSearch: `<details>/<summary>` for expand/collapse — confirmed as valid HTML5 native approach, though event-delegation JS gives more control for table rows specifically

---

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH — verified against existing codebase patterns; no new external dependencies
- Architecture: HIGH — directly mirrors sarif_output.zig pattern; all data structures verified
- Pitfalls: HIGH for Zig API and HTML injection; MEDIUM for treemap edge cases (squarify zero-weight)
- Visualizations: MEDIUM — CSS variable SVG fill and squarify algorithm are well-documented but need implementation testing
- JavaScript interactivity: HIGH — vanilla JS sort and expand/collapse are extremely well-established patterns

**Research date:** 2026-02-18
**Valid until:** 2026-03-20 (stable domain; Zig 0.14 API won't change within this window)
