---
phase: 10-html-reports
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/output/html_output.zig
autonomous: true
requirements:
  - OUT-HTML-03
  - OUT-HTML-04

must_haves:
  truths:
    - "HTML report shows a file list below the dashboard with each file as a clickable row"
    - "Collapsed file rows show file path and health score with color indicator"
    - "Clicking a file row expands it to show all functions with their metric details"
    - "Expanded function detail shows metric table with all metric columns"
    - "File list is sortable by clicking column headers (health score, function count, worst violation)"
    - "Function metric values show inline bars indicating proximity to threshold"
    - "HTML report includes a treemap SVG showing files sized by function count, colored by health score"
    - "HTML report includes a bar chart SVG showing files ranked by health score"
  artifacts:
    - path: "src/output/html_output.zig"
      provides: "File table, function drill-down, sort JS, treemap SVG, bar chart SVG"
      contains: "writeFileTable"
  key_links:
    - from: "src/output/html_output.zig writeFileTable"
      to: "FileThresholdResults"
      via: "iterates file_results to render expandable rows"
      pattern: "file-row"
    - from: "src/output/html_output.zig JS sort"
      to: "HTML table data-value attributes"
      via: "sortTable function reads data-value, reorders DOM rows"
      pattern: "sortTable"
    - from: "src/output/html_output.zig writeTreemap"
      to: "computeFileHealthScore"
      via: "colors treemap tiles by file health score"
      pattern: "treemap"
---

<objective>
Add the file breakdown table with expandable function details, sortable columns, inline metric bars, treemap SVG, and bar chart SVG to the HTML report.

Purpose: Implements per-file drill-down with expandable function details (OUT-HTML-03) and sortable metric tables (OUT-HTML-04). Adds the treemap and bar chart visualizations from locked decisions.

Output: Extended `src/output/html_output.zig` with file table, function details, sorting JS, treemap SVG, and bar chart SVG.
</objective>

<execution_context>
@/Users/benvds/.claude/get-shit-done/workflows/execute-plan.md
@/Users/benvds/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-html-reports/10-RESEARCH.md
@.planning/phases/10-html-reports/10-CONTEXT.md
@.planning/phases/10-html-reports/10-01-SUMMARY.md
@src/output/html_output.zig
@src/metrics/cyclomatic.zig
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add file table with expandable function details, sortable columns, and inline metric bars</name>
  <files>src/output/html_output.zig</files>
  <action>
Extend `html_output.zig` to add the file breakdown section below the dashboard. This is the primary drill-down UI.

**New private functions to add:**

1. `writeFileTable(w, allocator, file_results)` — Main file list section:
   - Render `<table id="file-table">` with sortable column headers
   - Headers: File Path, Health Score, Functions, Worst Violation
   - Each header has `onclick="sortTable('file-table', N, type)"` where type is 'str' or 'num'
   - Sort indicator arrows in headers (CSS-styled)

2. `writeFileRow(w, allocator, file_result, file_index)` — One collapsed file row:
   - `<tr class="file-row" data-file-id="{index}" aria-expanded="false">`
   - Cells: file path (HTML-escaped), health score with color class, function count, worst violation status
   - Each `<td>` has `data-value="{raw_value}"` for sort correctness
   - Health score cell colored via CSS class based on score (ok/warning/error)

3. `writeDetailRow(w, allocator, file_result, file_index)` — Expandable detail row (initially hidden):
   - `<tr class="detail-row" id="detail-{index}">`
   - Contains a `<td colspan="4">` with a nested function metric table
   - Function table headers: Function, Kind, Health, Cyclomatic, Cognitive, Halstead Vol, Halstead Diff, Lines, Params, Nesting
   - Each function row: function name (HTML-escaped), function kind, health_score, all metric values
   - Metric values with `data-value` for potential sub-sorting

4. `writeMetricBar(w, value, threshold_warning, threshold_error)` — Inline progress bar per metric:
   - Compute percentage: `min(100, (value / error_threshold) * 100)`
   - Render `<div class="metric-bar"><div class="metric-bar__fill {status}" style="width: {pct}%"></div></div>`
   - Status class based on value vs thresholds: ok (<warning), warning (warning..error), error (>=error)

**Update the CSS const** to add styles for:
- `.file-row` — clickable cursor, hover highlight
- `.detail-row` — hidden by default (`display: none`), `.detail-row.expanded` shows (`display: table-row`)
- `.metric-bar` — small inline bar (height 8px, background light gray, rounded)
- `.metric-bar__fill` — colored fill (green/yellow/red based on status class)
- Sort indicator styles: `th[data-sort]` with cursor pointer, `::after` content for asc/desc arrows
- Nested function table: compact, dense layout for progressive density

**Update the JS const** to add:
- `sortTable(tableId, colIndex, type)` — Vanilla JS sort as specified in research:
  - Get tbody, convert rows to array
  - Toggle asc/desc via `table.dataset.sortCol` and `table.dataset.sortDir`
  - Sort by `parseFloat(data-value)` for 'num', `localeCompare(data-value)` for 'str'
  - Re-append sorted rows to tbody
  - Update sort indicator arrows
- Expand/collapse event delegation on `#file-table`:
  - `document.getElementById('file-table').addEventListener('click', ...)`
  - On click of `.file-row`, toggle `.expanded` on corresponding `#detail-{fileId}`
  - Set `aria-expanded` attribute on the file row for accessibility

**Integrate into buildHtmlReport:**
Call `writeFileTable(w, allocator, file_results)` after the dashboard section in the `<main>` body.

**Additional inline tests:**
- `test "writeMetricBar percentage clamping"` — verify percentage doesn't exceed 100%
- `test "file table row count"` — verify buildHtmlReport output contains correct number of file-row and detail-row elements
  </action>
  <verify>Run `zig build test` — all tests pass. Run `zig build run -- --format html --output-file report.html tests/fixtures/` and open in browser. Verify file table renders, rows expand on click, columns sort on header click.</verify>
  <done>File breakdown table renders below dashboard with expandable function detail rows. Column headers are sortable by click. Function metrics display with inline bar indicators. Expand/collapse works via JS event delegation. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add treemap SVG and bar chart SVG visualizations</name>
  <files>src/output/html_output.zig</files>
  <action>
Add the two SVG visualizations specified in the locked decisions: a treemap (files as rectangles sized by function count, colored by health score) and a bar chart (files ranked by health score).

**New types and functions:**

1. `const TreemapRect = struct { x: f64, y: f64, w: f64, h: f64, file_index: usize }` — Computed tile coordinates.

2. `const FileWeight = struct { index: usize, weight: f64, score: f64 }` — Input to treemap: index into file_results, weight = function count as f64, score = file health score.

3. `squarify(allocator, items, x, y, w, h) ![]TreemapRect` — Squarified treemap algorithm (Bruls 1999):
   - Input: sorted FileWeight items (descending by weight), bounding box coordinates
   - Algorithm: greedily fill rows, minimizing worst aspect ratio
   - For each row: lay out tiles horizontally or vertically depending on remaining aspect ratio
   - Skip items with weight <= 0 (files with 0 functions)
   - Output: array of TreemapRect with computed x/y/w/h in the SVG coordinate space
   - Use `viewBox="0 0 800 400"` as the coordinate space

4. `writeTreemap(w, allocator, file_results)` — Render treemap SVG:
   - Collect FileWeight entries (skip files with 0 functions)
   - Sort by weight descending (largest files first)
   - Call `squarify()` to compute tile positions
   - Write `<svg viewBox="0 0 800 400" width="100%" class="treemap" role="img" aria-label="File complexity treemap">`
   - For each tile: `<rect x y width height fill="var(--color-{status}-bg)" stroke="var(--border)" />`
   - For each tile: `<text>` with truncated filename (last path component), centered in tile, font-size scaled to tile
   - Close `</svg>`

5. `writeBarChart(w, allocator, file_results)` — Render horizontal bar chart SVG:
   - Sort files by health score ascending (worst first, most interesting at top)
   - Write `<svg viewBox="0 0 800 {height}" width="100%">` where height = file_count * bar_height
   - Each file gets a horizontal bar: width proportional to score (0-100 mapped to 0-700px), colored by status
   - Label: file path (truncated, HTML-escaped) on the left side
   - Score value at end of bar

**Update CSS const** to add:
- `.treemap` — margin, responsive width
- `.treemap rect` — default stroke, hover opacity change
- `.treemap text` — fill, font-size, pointer-events none
- `.bar-chart` — margin, responsive width
- Visualization section layout: side-by-side on desktop (CSS grid 2-col), stacked on mobile

**Integrate into buildHtmlReport:**
Add a `<section class="visualizations">` between the dashboard and file table. Contains the treemap and bar chart side by side.

**Truncate helper:**
`truncateFilename(path)` — return last path component (after last `/`), truncate to ~20 chars with ellipsis if needed.

**Inline tests:**
- `test "squarify single item"` — one file fills entire viewbox
- `test "squarify multiple items"` — verify all tiles fit within viewbox, no overlaps, total area approximately equals viewbox area
- `test "squarify skips zero-weight"` — files with 0 functions produce no tiles
- `test "treemap SVG structure"` — verify output contains `<svg`, `<rect`, `<text` elements
  </action>
  <verify>Run `zig build test` — all tests pass including squarify algorithm tests. Generate report and open in browser to verify treemap and bar chart render correctly with colored tiles/bars.</verify>
  <done>Treemap SVG renders files as rectangles sized by function count and colored by health score. Bar chart SVG shows files ranked by health score. Both are responsive (width 100%) and use CSS variables for colors. Squarify algorithm handles edge cases (zero functions, single file). All tests pass.</done>
</task>

</tasks>

<verification>
1. `zig build test` — all tests pass
2. Generate report: `zig build run -- --format html --output-file report.html tests/fixtures/`
3. Open report.html: file table visible below dashboard, expandable rows work, sortable columns work
4. Treemap visible with colored tiles, bar chart visible with ranked files
5. Metric bars show fill proportional to threshold proximity
6. Test responsive behavior: narrow browser window, layout adjusts
7. Test dark mode: toggle OS theme, colors adapt
</verification>

<success_criteria>
- File table renders all analyzed files with health score, function count, worst violation
- Clicking file row expands to show function metric table
- Clicking column headers sorts the file list
- Treemap SVG tiles are sized by function count and colored by health score
- Bar chart SVG ranks files by health score
- Inline metric bars show proximity to thresholds
- All visualizations use CSS variables (adapt to light/dark mode)
- `zig build test` passes
</success_criteria>

<output>
After completion, create `.planning/phases/10-html-reports/10-02-SUMMARY.md`
</output>
