---
phase: 02-cli-configuration
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/cli/help.zig
  - src/cli/errors.zig
  - src/main.zig
autonomous: true

must_haves:
  truths:
    - "Help output is compact ripgrep-style, grouped by category (General, Output, Analysis, Files, Thresholds), fits one screen"
    - "--version displays version string"
    - "Invalid flag produces error + did-you-mean suggestion using Levenshtein distance"
    - "Color output auto-detects TTY, respects --color/--no-color and NO_COLOR env var"
  artifacts:
    - path: "src/cli/help.zig"
      provides: "Compact help text and version display"
      exports: ["printHelp", "printVersion"]
    - path: "src/cli/errors.zig"
      provides: "Levenshtein distance and did-you-mean suggestions"
      exports: ["levenshteinDistance", "suggestFlag"]
  key_links:
    - from: "src/cli/help.zig"
      to: "stdout"
      via: "writer interface"
      pattern: "writer\\.writeAll"
    - from: "src/cli/errors.zig"
      to: "src/cli/args.zig"
      via: "known flag names for suggestions"
      pattern: "known_flags"
---

<objective>
Implement compact ripgrep-style help output, version display, Levenshtein did-you-mean error suggestions, and TTY color detection.

Purpose: Users get a polished CLI experience with helpful errors and clean help text, matching the locked ripgrep/fd personality.
Output: Help display, version command, and error UX modules.
</objective>

<execution_context>
@/home/ben/.claude/get-shit-done/workflows/execute-plan.md
@/home/ben/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cli-configuration/02-CONTEXT.md
@.planning/phases/02-cli-configuration/02-RESEARCH.md
@.planning/phases/02-cli-configuration/02-01-SUMMARY.md
@src/cli/args.zig
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement compact help output and version display</name>
  <files>src/cli/help.zig, src/main.zig</files>
  <action>
Create `src/cli/help.zig` with ripgrep-style compact help per locked decisions.

1. `pub fn printHelp(writer: anytype) !void`

   Output must be grouped by category per locked decision (General, Output, Analysis, Files, Thresholds, Config). Format:

   ```
   complexityguard [OPTIONS] [PATH]...

   Analyze code complexity for TypeScript/JavaScript files.

   GENERAL:
     -h, --help                 Show this help message
         --version              Show version information
         --init                 Run interactive config setup

   OUTPUT:
     -f, --format <FORMAT>      Output format [console, json, sarif, html]
     -o, --output <FILE>        Write report to file
         --color                Force color output
         --no-color             Disable color output
     -q, --quiet                Suppress non-error output
     -v, --verbose              Show detailed output

   ANALYSIS:
         --metrics <LIST>       Comma-separated metrics to enable
         --no-duplication       Skip duplication analysis
         --threads <N>          Thread count (default: CPU count)
         --baseline <FILE>      Compare against baseline report

   FILES:
         --include <GLOB>       Include files matching pattern (repeatable)
         --exclude <GLOB>       Exclude files matching pattern (repeatable)

   THRESHOLDS:
         --fail-on <LEVEL>      Exit non-zero on: warning, error, none
         --fail-health-below <N>  Exit non-zero if health score below N

   CONFIG:
     -c, --config <FILE>        Use specific config file

   Run 'complexityguard --init' to create a config file interactively.
   ```

   Use hardcoded string literal with `\\` multiline syntax for the help text (not zig-clap's auto-generated help). This gives full control over formatting per the ripgrep-style locked decision.

   Key formatting rules:
   - Short aliases left-aligned with long flags
   - Flags without short aliases indented with spaces to align with long flag names
   - Description column aligned consistently
   - One blank line between groups

2. `pub fn printVersion(writer: anytype) !void`

   Import version from core/types.zig and print: `complexityguard {version}`

3. Color-aware output utility:

   `pub fn shouldUseColor(force_color: bool, no_color: bool) bool`
   - If no_color is true (from --no-color flag), return false
   - If force_color is true (from --color flag), return true
   - Check NO_COLOR environment variable (standard: https://no-color.org/). If set (any value), return false
   - Check FORCE_COLOR or YES_COLOR env var. If set, return true
   - Default: detect TTY on stdout via `std.io.tty.detectConfig(std.io.getStdOut())`
   - Return whether TTY supports color

   Note: Color will be USED by Phase 8 (console output). This plan only provides the detection function. The help text itself does not need color.

Add tests:
- Test printHelp writes non-empty content containing "GENERAL:", "OUTPUT:", "ANALYSIS:", "FILES:", "THRESHOLDS:"
- Test printVersion contains "complexityguard" and the version string
- Test shouldUseColor returns false when no_color=true regardless of other settings
- Test shouldUseColor returns true when force_color=true and no_color=false

Add `_ = @import("cli/help.zig");` to main.zig test block.
  </action>
  <verify>
`zig build test` passes. Help text output is compact and contains all flag groups.
  </verify>
  <done>Help output matches ripgrep-style with five groups per locked decision. Version display works. Color detection respects flags and environment variables.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Levenshtein distance and did-you-mean error suggestions</name>
  <files>src/cli/errors.zig, src/main.zig</files>
  <action>
Create `src/cli/errors.zig` implementing error UX per locked decisions.

1. `pub fn levenshteinDistance(allocator: std.mem.Allocator, a: []const u8, b: []const u8) !usize`

   Implement Wagner-Fischer algorithm:
   - Allocate (m+1) * (n+1) matrix using allocator
   - defer free the matrix
   - Fill base cases (first row and column)
   - Fill matrix with min of deletion, insertion, substitution costs
   - Return matrix[m][n]

   Edge cases: if either string is empty, return length of other string.

2. `pub fn suggestFlag(allocator: std.mem.Allocator, unknown: []const u8) !?[]const u8`

   Compare unknown flag against all known flag names. Known flags list should be a comptime array of all valid long flag names:
   ```
   const known_flags = [_][]const u8{
       "help", "version", "format", "output", "config",
       "fail-on", "fail-health-below", "include", "exclude",
       "metrics", "no-duplication", "threads", "baseline",
       "verbose", "quiet", "color", "no-color", "init",
   };
   ```

   Strip leading dashes from unknown before comparing. Find the flag with minimum Levenshtein distance. Only suggest if distance <= 3 (per research guidance). Return the suggestion with "--" prefix, or null if no close match.

3. `pub fn formatUnknownFlagError(allocator: std.mem.Allocator, unknown: []const u8) ![]const u8`

   Format error message:
   - Without suggestion: `error: unknown flag '{unknown}'`
   - With suggestion: `error: unknown flag '{unknown}'. Did you mean '--{suggestion}'?`

   Write to stderr, not stdout (per locked decision: diagnostics to stderr).

Add tests:
- Test levenshteinDistance("kitten", "sitting") == 3
- Test levenshteinDistance("", "abc") == 3
- Test levenshteinDistance("abc", "abc") == 0
- Test levenshteinDistance("foramt", "format") == 2
- Test suggestFlag("foramt") returns "format"
- Test suggestFlag("verbos") returns "verbose"
- Test suggestFlag("xyzxyzxyz") returns null (too far from any flag)
- Test formatUnknownFlagError with suggestion contains "Did you mean"
- Test formatUnknownFlagError without suggestion does not contain "Did you mean"

Add `_ = @import("cli/errors.zig");` to main.zig test block.
  </action>
  <verify>
`zig build test` passes. Levenshtein distance computes correctly. Did-you-mean suggestions work for common typos.
  </verify>
  <done>Levenshtein distance implemented. suggestFlag finds closest match within distance 3. Error messages include did-you-mean suggestions per locked decision.</done>
</task>

</tasks>

<verification>
1. `zig build test` passes all tests
2. Help output is compact, grouped by category, fits one screen
3. Version display shows correct version string
4. Levenshtein distance is mathematically correct
5. Did-you-mean suggests correct flags for common typos
6. Color detection respects --color, --no-color, NO_COLOR env
</verification>

<success_criteria>
- Help text is ripgrep-style with General, Output, Analysis, Files, Thresholds groups
- Version display works
- Levenshtein did-you-mean provides suggestions for typos within distance 3
- Color detection respects all three levels: flags > env vars > TTY detection
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-cli-configuration/02-03-SUMMARY.md`
</output>
