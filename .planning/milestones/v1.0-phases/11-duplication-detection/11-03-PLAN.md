---
phase: 11-duplication-detection
plan: 03
type: execute
wave: 3
depends_on:
  - "11-02"
files_modified:
  - src/output/console.zig
  - src/output/json_output.zig
  - src/output/sarif_output.zig
  - src/output/html_output.zig
  - src/output/exit_codes.zig
autonomous: true
requirements:
  - DUP-06
  - DUP-07

must_haves:
  truths:
    - "Console output shows Duplication section with clone groups and per-file/project percentages"
    - "JSON output includes duplication object with clone_groups array and file duplication data"
    - "SARIF output includes duplication rule with relatedLocations for clone group instances"
    - "HTML report includes clone group table and file heatmap section"
    - "Exit codes account for duplication threshold violations"
  artifacts:
    - path: "src/output/console.zig"
      provides: "Duplication section in console output"
      contains: "formatDuplication"
    - path: "src/output/json_output.zig"
      provides: "Duplication object in JSON output"
      contains: "duplication"
    - path: "src/output/sarif_output.zig"
      provides: "Duplication SARIF rule and results"
      contains: "duplication"
    - path: "src/output/html_output.zig"
      provides: "Clone groups table and heatmap in HTML report"
      contains: "duplication"
  key_links:
    - from: "src/main.zig"
      to: "src/output/console.zig"
      via: "passes dup_result to formatDuplication"
      pattern: "formatDuplication"
    - from: "src/main.zig"
      to: "src/output/json_output.zig"
      via: "passes dup_result to buildJsonOutput"
      pattern: "dup_result"
---

<objective>
Integrate duplication results into all four output formats and exit code logic.

Purpose: Display duplication clone groups and percentages in console (DUP-06), JSON, SARIF, and HTML outputs per the locked decisions in CONTEXT.md. Update exit codes to account for duplication threshold violations (DUP-07). Each output format follows the specific format requirements from CONTEXT.md.

Output: Updated output modules with duplication support, integrated with main.zig pipeline.
</objective>

<execution_context>
@/home/ben/.claude/get-shit-done/workflows/execute-plan.md
@/home/ben/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-duplication-detection/11-CONTEXT.md (locked output format decisions)
@.planning/phases/11-duplication-detection/11-RESEARCH.md (output format examples)
@.planning/phases/11-duplication-detection/11-01-SUMMARY.md
@.planning/phases/11-duplication-detection/11-02-SUMMARY.md
@src/output/console.zig (formatFileResults, formatSummary, OutputConfig)
@src/output/json_output.zig (buildJsonOutput, JsonOutput, serializeJsonOutput)
@src/output/sarif_output.zig (buildSarifOutput, SarifResult, SarifThresholds)
@src/output/html_output.zig (buildHtmlReport)
@src/output/exit_codes.zig (determineExitCode, countViolations)
@src/metrics/duplication.zig (DuplicationResult, CloneGroup, FileDuplicationResult)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add duplication sections to console and JSON output, update exit codes</name>
  <files>src/output/console.zig, src/output/json_output.zig, src/output/exit_codes.zig, src/main.zig</files>
  <action>
**console.zig — Duplication section:**
Add a `formatDuplicationSection` function that takes writer, allocator, DuplicationResult, and OutputConfig.

Per CONTEXT.md locked format:
```
Duplication
-----------
Clone group (42 tokens): src/auth/login.ts:15, src/auth/register.ts:88
Clone group (31 tokens): src/utils/format.ts:42, src/utils/parse.ts:10, src/lib/common.ts:77

File duplication:
  src/auth/login.ts        12.3%  [OK]
  src/auth/register.ts     17.1%  [WARNING]

Project duplication: 4.2%  [OK]
```

- Print "Duplication" header and separator
- For each clone group: print "Clone group ({N} tokens): " followed by comma-separated "path:start_line" locations
- Print blank line, then "File duplication:" section
- For each file with duplication > 0: print path, percentage, status indicator ([OK], [WARNING], [ERROR])
- Print "Project duplication: {pct}%  [{status}]"
- Respect `output_config.verbosity` — in quiet mode, only show files with warnings/errors
- Respect `output_config.use_color` — use color codes for WARNING (yellow) and ERROR (red)

Call this function from main.zig in the console output path, after `formatSummary`, only if `dup_result` is not null.

**json_output.zig — Duplication in JSON:**
Add duplication fields to `JsonOutput` struct:
```zig
duplication: ?JsonDuplication = null,
```

Define `JsonDuplication` struct:
```zig
const JsonDuplication = struct {
    enabled: bool,
    project_duplication_pct: f64,
    project_status: []const u8,  // "ok", "warning", "error"
    clone_groups: []const JsonCloneGroup,
    files: []const JsonFileDuplication,
};

const JsonCloneGroup = struct {
    token_count: u32,
    locations: []const JsonCloneLocation,
};

const JsonCloneLocation = struct {
    file: []const u8,
    start_line: u32,
    end_line: u32,
};

const JsonFileDuplication = struct {
    path: []const u8,
    total_tokens: u32,
    cloned_tokens: u32,
    duplication_pct: f64,
    status: []const u8,  // "ok", "warning", "error"
};
```

Update `buildJsonOutput` to accept an optional `?DuplicationResult` parameter. When non-null, populate the duplication field. When null, omit it (keep null).

Update the signature in main.zig where `buildJsonOutput` is called.

**exit_codes.zig — Duplication violations:**
Update `determineExitCode` to accept additional parameters for duplication violations:
- `dup_errors: u32` (file-level or project-level error threshold exceeded)
- `dup_warnings: u32` (file-level or project-level warning threshold exceeded)
- Add these to the existing errors_found and warnings_found logic

Alternative (simpler): In main.zig, add duplication violation counts to `total_warnings` and `total_errors` before calling `determineExitCode`. This avoids changing the `determineExitCode` signature. Preferred approach — keep it simple.

**main.zig integration:**
- Pass `dup_result` to console formatDuplicationSection (console path)
- Pass `dup_result` to buildJsonOutput (JSON path)
- Before exit code determination, if dup_result exists, count duplication violations and add to total_warnings/total_errors

Tests:
- Add test in console.zig for `formatDuplicationSection` with mock DuplicationResult
- Add test in json_output.zig verifying duplication field appears in JSON when provided

Commit: `feat(11-03): add duplication output to console and JSON formats, update exit codes`
  </action>
  <verify>`zig build test` passes. Running `zig build run -- --duplication --format json tests/fixtures/` includes duplication object in JSON output. Console output shows Duplication section.</verify>
  <done>Console output shows clone groups, file duplication percentages, and project duplication with status indicators. JSON output includes duplication object with clone_groups and per-file data. Exit codes account for duplication threshold violations.</done>
</task>

<task type="auto">
  <name>Task 2: Add duplication to SARIF and HTML output formats</name>
  <files>src/output/sarif_output.zig, src/output/html_output.zig, src/main.zig</files>
  <action>
**sarif_output.zig — Duplication SARIF rule:**

Per CONTEXT.md: "One SARIF result per clone group (not per instance). Use relatedLocations to point to all instances within the group."

- Add duplication rule to the rules array (index 10, after existing 10 rules which are indices 0-9):
  ```zig
  // Rule index 10: duplication
  SarifRule{
      .id = "complexity-guard/duplication",
      .name = "Code Duplication",
      .short_description = .{ .text = "Duplicate code block detected across files" },
      .full_description = .{ .text = "A sequence of tokens was found duplicated in multiple locations. Consider extracting shared code into a reusable function or module." },
      .default_configuration = .{ .level = "warning" },
  }
  ```

- Update `buildSarifOutput` to accept optional `?DuplicationResult` parameter
- For each clone group, create a SARIF result:
  - `ruleId`: "complexity-guard/duplication"
  - `ruleIndex`: 10
  - `level`: "warning" or "error" based on file duplication percentage
  - `message.text`: "Clone group: {N} tokens duplicated in {M} locations ({path1}:{line1}, {path2}:{line2})"
  - `locations`: first clone location as primary location
  - `relatedLocations`: remaining clone locations with sequential `id` values and `message.text: "Clone instance N"`
- Only emit duplication results when duplication is enabled and results exist
- Update SarifThresholds to include duplication thresholds (file_warning_pct, file_error_pct)

Update the `buildSarifOutput` call in main.zig to pass `dup_result`.

**html_output.zig — Clone table and heatmap:**

Per CONTEXT.md: "Sortable table of clone groups (locations, token count, line count) plus heatmap overlay showing which files share the most clones."

- Add duplication section to HTML report (only when dup_result is not null):

1. **Clone Groups Table:**
   - Column headers: #, Token Count, Locations
   - Each row shows clone group number, token count, and comma-separated file:line pairs
   - Sortable by token count (reuse existing table sort JS)

2. **File Duplication Heatmap:**
   - Build an adjacency matrix: for each pair of files that share clones, count shared clone tokens
   - Render as a grid/table where cell color intensity represents shared clone volume
   - Use CSS background-color with opacity proportional to shared clone count
   - For large file counts (>20), only show top 20 files by duplication percentage
   - Color scale: white (0 shared) -> orange (some shared) -> red (heavy sharing)

3. **File Duplication Summary:**
   - List each file with duplication_pct, status indicator (colored)
   - Project-level duplication percentage at the bottom

Update `buildHtmlReport` to accept optional `?DuplicationResult` parameter. Update the call in main.zig.

Tests:
- Add test in sarif_output.zig verifying duplication rule and relatedLocations structure
- Add test in html_output.zig verifying duplication section appears in HTML when result provided

Commit: `feat(11-03): add duplication to SARIF output with relatedLocations and HTML report with heatmap`
  </action>
  <verify>`zig build test` passes. Running `zig build run -- --duplication --format sarif tests/fixtures/` includes duplication rule results with relatedLocations. Running `zig build run -- --duplication --format html --output report.html tests/fixtures/` generates HTML with clone table.</verify>
  <done>SARIF output includes duplication rule with relatedLocations for GitHub Code Scanning. HTML report includes sortable clone groups table and file duplication heatmap. All four output formats support duplication.</done>
</task>

</tasks>

<verification>
1. `zig build test` — all tests pass
2. Console: `zig build run -- --duplication tests/fixtures/` shows Duplication section
3. JSON: `zig build run -- --duplication --format json tests/fixtures/` includes duplication object
4. SARIF: `zig build run -- --duplication --format sarif tests/fixtures/` includes duplication rules with relatedLocations
5. HTML: `zig build run -- --duplication --format html --output /tmp/report.html tests/fixtures/` includes clone table and heatmap
6. Without --duplication: no duplication section in any format
7. Exit codes: duplication violations contribute to exit code determination
</verification>

<success_criteria>
- All four output formats (console, JSON, SARIF, HTML) display duplication results when enabled
- Console format matches CONTEXT.md specification (location pairs, no code snippets)
- SARIF uses relatedLocations per CONTEXT.md
- HTML includes sortable clone table and file heatmap per CONTEXT.md
- Exit codes reflect duplication threshold violations
- No output changes when duplication is disabled
</success_criteria>

<output>
After completion, create `.planning/phases/11-duplication-detection/11-03-SUMMARY.md`
</output>
