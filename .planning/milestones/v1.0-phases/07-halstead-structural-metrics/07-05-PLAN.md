---
phase: 07-halstead-structural-metrics
plan: 05
type: execute
wave: 1
depends_on: []
files_modified: [src/output/console.zig, src/main.zig]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "When --metrics cyclomatic is specified, only Top cyclomatic hotspots section appears in summary; cognitive and Halstead hotspot sections are hidden"
    - "When --metrics cyclomatic is specified, per-function output shows only cyclomatic score, not cognitive/Halstead/structural details"
    - "When no --metrics flag is specified (null), all hotspot sections and all per-function metric details render as before (backward compatible)"
  artifacts:
    - path: "src/output/console.zig"
      provides: "OutputConfig with selected_metrics field; metric-gated hotspot and detail rendering"
      contains: "selected_metrics"
    - path: "src/main.zig"
      provides: "parsed_metrics passed through OutputConfig to output layer"
      contains: "selected_metrics"
  key_links:
    - from: "src/main.zig"
      to: "src/output/console.zig"
      via: "OutputConfig.selected_metrics = parsed_metrics"
      pattern: "selected_metrics.*=.*parsed_metrics"
---

<objective>
Wire the --metrics flag through to the console output layer so that hotspot sections and per-function metric details are filtered by selected metrics.

Purpose: UAT test 6 found that `--metrics cyclomatic` still shows cognitive and Halstead hotspot sections in the summary, and per-function lines include metric details for unselected families. The `parsed_metrics` value is correctly built in main.zig but never passed to the output layer.

Output: Console output respects --metrics filtering for both per-function detail lines and summary hotspot sections.
</objective>

<execution_context>
@/Users/benvds/.claude/get-shit-done/workflows/execute-plan.md
@/Users/benvds/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-halstead-structural-metrics/07-03-SUMMARY.md
@.planning/phases/07-halstead-structural-metrics/07-UAT.md
@src/output/console.zig
@src/main.zig
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add selected_metrics to OutputConfig and gate console output</name>
  <files>src/output/console.zig, src/main.zig</files>
  <action>
**In src/output/console.zig:**

1. Add `selected_metrics: ?[]const []const u8` field to `OutputConfig` struct (after `verbosity`), defaulting to `null`. Since Zig does not allow default values in non-test production structs, you must update ALL existing OutputConfig construction sites (including in tests) to include `.selected_metrics = null`.

2. Add a private helper function `isMetricEnabled` in console.zig (same logic as main.zig's local version):
   ```zig
   fn isMetricEnabled(metrics: ?[]const []const u8, metric: []const u8) bool {
       const list = metrics orelse return true;
       for (list) |m| {
           if (std.mem.eql(u8, m, metric)) return true;
       }
       return false;
   }
   ```

3. In `formatFileResults`:
   - Gate the file-level structural section (lines 117-151): wrap the entire block in `if (isMetricEnabled(config.selected_metrics, "structural"))`. When structural is not selected, skip rendering the file-level line entirely.
   - Gate the base function line's `cyclomatic N cognitive N` display: always show the status symbol/severity line, but conditionally include the metric values. Specifically:
     - Always print: `{line}:{col} {symbol} {severity} {kind} '{name}'`
     - Append ` cyclomatic {N}` only if `isMetricEnabled(config.selected_metrics, "cyclomatic")`
     - Append ` cognitive {N}` only if `isMetricEnabled(config.selected_metrics, "cognitive")`
   - Gate the `[halstead vol N]` block (lines 210-217): add `isMetricEnabled(config.selected_metrics, "halstead")` as an additional AND condition to the existing `if` check.
   - Gate the `[length N]`, `[params N]`, `[depth N]` blocks (lines 220-234): add `isMetricEnabled(config.selected_metrics, "structural")` as an additional AND condition to each existing `if` check.
   - Important: the `worstStatusAll` function used for filtering by verbosity should still consider ALL metric statuses regardless of selected_metrics (the filter only affects display, not which functions appear). However, for the `has_file_level_violations` check, also gate it with `isMetricEnabled(config.selected_metrics, "structural")` so files without structural metrics selected don't show file-level violations.

4. In `formatSummary`:
   - Gate the cyclomatic hotspot section (sort + print around lines 286-357) with `if (isMetricEnabled(config.selected_metrics, "cyclomatic"))`.
   - Gate the cognitive hotspot section (sort + print around lines 359-388) with `if (isMetricEnabled(config.selected_metrics, "cognitive"))`.
   - Gate the Halstead volume hotspot section (sort + print around lines 390-419) with `if (isMetricEnabled(config.selected_metrics, "halstead"))`.

5. Update ALL existing test `OutputConfig` literals in console.zig to include `.selected_metrics = null` (there are approximately 13 test functions that construct OutputConfig).

**In src/main.zig:**

6. Update the `OutputConfig` construction (around line 397) to pass `parsed_metrics`:
   ```zig
   const output_config = console.OutputConfig{
       .use_color = use_color,
       .verbosity = verbosity,
       .selected_metrics = parsed_metrics,
   };
   ```

This is the only change needed in main.zig since `parsed_metrics` is already correctly parsed.
  </action>
  <verify>
Run `zig build test` -- all existing tests must pass (they use `.selected_metrics = null` which means "all enabled", preserving current behavior).

Then build and verify manually:
```bash
zig build
# Verify filtering works: only cyclomatic hotspots shown
zig-out/bin/complexity-guard --metrics cyclomatic tests/fixtures/ --verbose 2>&1 | grep -c "Top cyclomatic"
# Should return 1 (or 0 if no hotspots, but no cognitive/halstead hotspot sections)
zig-out/bin/complexity-guard --metrics cyclomatic tests/fixtures/ --verbose 2>&1 | grep -c "Top cognitive"
# Should return 0
zig-out/bin/complexity-guard --metrics cyclomatic tests/fixtures/ --verbose 2>&1 | grep -c "Top Halstead"
# Should return 0

# Verify no --metrics still shows everything
zig-out/bin/complexity-guard tests/fixtures/ --verbose 2>&1 | grep "Top"
# Should show all hotspot sections
```
  </verify>
  <done>
When --metrics filters to specific families: (a) only the selected metric's hotspot section appears in the summary, (b) per-function output only shows metric detail brackets for selected families, (c) running without --metrics behaves identically to before this change.
  </done>
</task>

</tasks>

<verification>
1. `zig build test` passes with zero failures
2. `zig-out/bin/complexity-guard --metrics cyclomatic tests/fixtures/ --verbose` shows only cyclomatic scores and cyclomatic hotspots
3. `zig-out/bin/complexity-guard --metrics halstead tests/fixtures/ --verbose` shows only Halstead details and Halstead hotspots
4. `zig-out/bin/complexity-guard tests/fixtures/ --verbose` shows all metrics and all hotspot sections (backward compatible)
</verification>

<success_criteria>
- OutputConfig has selected_metrics field
- parsed_metrics flows from main.zig to OutputConfig
- Hotspot sections are filtered by selected_metrics
- Per-function metric details are filtered by selected_metrics
- All existing tests pass unchanged (with null = all enabled)
- UAT test 6 gap is resolved
</success_criteria>

<output>
After completion, create `.planning/phases/07-halstead-structural-metrics/07-05-SUMMARY.md`
</output>
