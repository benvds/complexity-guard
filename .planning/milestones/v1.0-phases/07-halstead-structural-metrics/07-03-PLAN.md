---
phase: 07-halstead-structural-metrics
plan: 03
type: execute
wave: 2
depends_on:
  - 07-01
  - 07-02
files_modified:
  - src/metrics/cyclomatic.zig
  - src/output/console.zig
  - src/output/json_output.zig
  - src/output/exit_codes.zig
  - src/main.zig
autonomous: true
requirements:
  - HALT-05
  - STRC-06

must_haves:
  truths:
    - "ThresholdResult carries Halstead and structural metric values and their threshold statuses"
    - "Console output shows Halstead and structural violations in default mode, all metrics in verbose mode"
    - "JSON output includes all Halstead and structural fields for every function (non-null values)"
    - "Hotspot ranking considers Halstead volume alongside cyclomatic/cognitive scores"
    - "Exit codes and violation counts consider worst status across all metric families"
    - "File-level structural metrics (file_length, export_count) appear in console and JSON output"
    - "--metrics flag filters which metric families are computed (e.g., --metrics cyclomatic,halstead)"
  artifacts:
    - path: "src/metrics/cyclomatic.zig"
      provides: "Extended ThresholdResult with Halstead + structural fields"
      contains: "halstead_volume"
    - path: "src/main.zig"
      provides: "Pipeline running all 4 analysis passes, merging by index, --metrics filtering"
      contains: "halstead.analyzeFunctions"
    - path: "src/output/console.zig"
      provides: "Extended console output with Halstead/structural violations, file-level metrics, updated hotspots"
      contains: "halstead_volume"
    - path: "src/output/json_output.zig"
      provides: "JSON output with populated Halstead/structural fields"
      contains: "halstead_volume"
    - path: "src/output/exit_codes.zig"
      provides: "Violation counting across all metric families"
      contains: "worstStatusAll"
  key_links:
    - from: "src/main.zig"
      to: "src/metrics/halstead.zig"
      via: "import and analyzeFunctions call"
      pattern: "halstead\\.analyzeFunctions"
    - from: "src/main.zig"
      to: "src/metrics/structural.zig"
      via: "import and analyzeFunctions/analyzeFile calls"
      pattern: "structural\\.analyzeFunctions"
    - from: "src/output/console.zig"
      to: "src/metrics/cyclomatic.zig"
      via: "ThresholdResult with Halstead/structural fields"
      pattern: "result\\.halstead_volume"
---

<objective>
Wire Halstead and structural metrics into the analysis pipeline: extend ThresholdResult, update main.zig to run all analysis passes and merge results, update console/JSON output to display new metrics, apply configurable thresholds, and implement --metrics flag filtering.

Purpose: Connect the metric computation modules (Plans 01-02) to the user-facing pipeline so metrics are computed, validated against thresholds, and displayed in both console and JSON output.
Output: Complete pipeline integration with all 4 metric families operational.
</objective>

<execution_context>
@/Users/benvds/.claude/get-shit-done/workflows/execute-plan.md
@/Users/benvds/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-halstead-structural-metrics/07-RESEARCH.md
@.planning/phases/07-halstead-structural-metrics/07-01-SUMMARY.md
@.planning/phases/07-halstead-structural-metrics/07-02-SUMMARY.md
@src/metrics/cyclomatic.zig
@src/metrics/halstead.zig
@src/metrics/structural.zig
@src/main.zig
@src/output/console.zig
@src/output/json_output.zig
@src/output/exit_codes.zig
@src/cli/config.zig
@src/cli/args.zig
@src/cli/merge.zig
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ThresholdResult and wire pipeline in main.zig</name>
  <files>src/metrics/cyclomatic.zig, src/main.zig</files>
  <action>
    **1a. Extend ThresholdResult in cyclomatic.zig:**
    Add fields to ThresholdResult struct (after cognitive_status):
    ```
    // Halstead (Phase 7)
    halstead_volume: f64 = 0,
    halstead_difficulty: f64 = 0,
    halstead_effort: f64 = 0,
    halstead_bugs: f64 = 0,
    halstead_volume_status: ThresholdStatus = .ok,
    halstead_difficulty_status: ThresholdStatus = .ok,
    halstead_effort_status: ThresholdStatus = .ok,
    halstead_bugs_status: ThresholdStatus = .ok,
    // Structural (Phase 7)
    function_length: u32 = 0,
    params_count: u32 = 0,
    nesting_depth: u32 = 0,
    end_line: u32 = 0,
    function_length_status: ThresholdStatus = .ok,
    params_count_status: ThresholdStatus = .ok,
    nesting_depth_status: ThresholdStatus = .ok,
    ```
    Use default values so existing code that creates ThresholdResult (in tests and analyzeFile) does not break.

    Add a `validateThresholdF64` function for floating-point threshold validation:
    ```
    pub fn validateThresholdF64(value: f64, warning: f64, err_level: f64) ThresholdStatus {
        if (value >= err_level) return .@"error";
        if (value >= warning) return .warning;
        return .ok;
    }
    ```

    **1b. Wire Halstead and structural analysis in main.zig:**
    - Import halstead and structural modules
    - Add `isMetricEnabled(metrics: ?[]const []const u8, metric: []const u8) bool` helper: returns true if metrics is null (all enabled) or if metric is in the list.
    - Parse --metrics flag: split cli_args.metrics (a ?[]const u8 string like "cyclomatic,halstead") on commas into a []const []const u8 slice. Store as parsed_metrics.
    - Build HalsteadConfig and StructuralConfig from cfg.analysis.thresholds (similar to how cog_config is built).
    - In the per-file loop, after cognitive analysis and merge:
      - If isMetricEnabled(parsed_metrics, "halstead"): run halstead.analyzeFunctions, merge into ThresholdResults by index (set halstead_volume, halstead_difficulty, halstead_effort, halstead_bugs, and their threshold statuses using validateThresholdF64).
      - If isMetricEnabled(parsed_metrics, "structural"): run structural.analyzeFunctions, merge into ThresholdResults by index (set function_length, params_count, nesting_depth, end_line, and their threshold statuses using validateThreshold).
      - Run structural.analyzeFile to get file_length and export_count. Store in FileThresholdResults.

    **1c. Extend FileThresholdResults in console.zig:**
    Add optional field: `structural: ?StructuralFileResult = null` where StructuralFileResult is imported from structural.zig (FileStructuralResult). Update main.zig to populate this field when structural metrics are enabled.

    **1d. Update main.zig test block:**
    Add `_ = @import("metrics/halstead.zig");` and `_ = @import("metrics/structural.zig");` if not already present from Plans 01-02.

    **Important:** All existing tests that create ThresholdResult struct literals must continue to compile thanks to default field values. If any test creates ThresholdResult without the new fields, the defaults kick in. Verify by running `zig build test`.
  </action>
  <verify>
    ```bash
    zig build test 2>&1 | head -20
    # All existing tests still pass
    # New metrics flow through pipeline
    ```
  </verify>
  <done>
    ThresholdResult has Halstead and structural fields with defaults. main.zig runs all 4 analysis passes and merges results. --metrics flag filtering works (null = all enabled). FileThresholdResults carries file-level structural data. All existing tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update output layer (console, JSON, exit codes) for new metrics</name>
  <files>src/output/console.zig, src/output/json_output.zig, src/output/exit_codes.zig</files>
  <action>
    **2a. Update exit_codes.zig:**
    Extend `worstStatus` to handle all metric families. Create `worstStatusAll` that takes a ThresholdResult and returns the worst status across all metrics:
    ```
    fn worstStatusAll(result: cyclomatic.ThresholdResult) cyclomatic.ThresholdStatus {
        var worst = worstStatus(result.status, result.cognitive_status);
        worst = worstStatus(worst, result.halstead_volume_status);
        worst = worstStatus(worst, result.halstead_difficulty_status);
        worst = worstStatus(worst, result.halstead_effort_status);
        worst = worstStatus(worst, result.halstead_bugs_status);
        worst = worstStatus(worst, result.function_length_status);
        worst = worstStatus(worst, result.params_count_status);
        worst = worstStatus(worst, result.nesting_depth_status);
        return worst;
    }
    ```
    Update `countViolations` to use `worstStatusAll` instead of `worstStatus(result.status, result.cognitive_status)`.

    **2b. Update console.zig:**
    - Update `worstStatus` usage in `formatFileResults` to use the same all-metrics worst status pattern.
    - In the per-function output line, extend the format to include Halstead and structural info when in verbose mode or when they have violations:
      - Default mode: show only violations. If a function has Halstead volume warning but cyclomatic ok, still show it. The line format becomes:
        `{line}:{col} {symbol} {severity} {Kind} '{name}' cyclomatic {N} cognitive {N} [halstead vol {N}] [length {N}] [params {N}] [depth {N}]`
        Only include the bracketed sections if they have non-ok status OR if verbosity is verbose.
      - Verbose mode: always show all metrics on the line.
    - Update `formatSummary` hotspot section: add a "Top Halstead volume hotspots:" list alongside the existing cyclomatic and cognitive lists. Collect functions with halstead_volume > 0, sort descending, show top 5.
    - Add file-level structural output: if FileThresholdResults has structural data and file_length or export_count exceed thresholds, show a file-level line before the function results:
      `  file  {symbol} {severity}  file length {N} logical lines, {N} exports`
      Only show in default mode if file-level status is warning/error. Always show in verbose mode.

    **2c. Update json_output.zig:**
    - In FunctionOutput: change halstead_volume, halstead_difficulty, halstead_effort from `?f64` to `f64`. Add halstead_bugs: f64 field. Change nesting_depth, line_count, params_count from `u32` with hardcoded 0 to populated values. Add end_line from ThresholdResult.
    - Add file-level fields to FileOutput: `file_length: ?u32` and `export_count: ?u32` (null when structural metrics not computed).
    - In buildJsonOutput: populate all fields from ThresholdResult. Use the Halstead/structural values directly. Status reflects worst across ALL metrics using worstStatusAll pattern.
    - Update existing tests: ThresholdResult struct literals in tests now get default values for new fields, so they should compile unchanged. Update the "null for uncomputed metrics" test to verify Halstead fields are now populated (non-null) when metrics are computed.

    **2d. Add tests for new output behavior:**
    - exit_codes: worstStatusAll correctly picks worst across all families
    - console: verbose mode shows all metric values
    - json: Halstead and structural fields populated in output
  </action>
  <verify>
    ```bash
    zig build test 2>&1 | head -20
    # All tests pass including new output tests
    zig build run -- tests/fixtures/typescript/ --verbose 2>&1 | head -30
    # Verify all metrics appear in console output
    zig build run -- tests/fixtures/typescript/ --format json 2>&1 | head -50
    # Verify JSON has Halstead and structural fields populated
    ```
  </verify>
  <done>
    Console output shows Halstead/structural violations in default mode, all metrics in verbose mode. JSON output includes all Halstead and structural fields populated (non-null). Exit codes consider worst status across all metric families. Hotspot ranking includes Halstead volume. File-level metrics shown when exceeding thresholds. All tests pass.
  </done>
</task>

</tasks>

<verification>
```bash
# Full test suite
zig build test

# End-to-end console output with verbose
zig build run -- tests/fixtures/typescript/ --verbose

# End-to-end JSON output
zig build run -- tests/fixtures/typescript/ --format json

# Verify --metrics flag filters metrics
zig build run -- tests/fixtures/typescript/ --metrics cyclomatic --verbose
# Should show only cyclomatic metrics, not Halstead/structural

zig build run -- tests/fixtures/typescript/ --metrics halstead,structural --verbose
# Should show only Halstead and structural metrics
```
</verification>

<success_criteria>
- ThresholdResult carries all Halstead and structural fields with threshold statuses
- Pipeline runs 4 analysis passes and merges by index
- Console shows violations for all metric families, verbose shows everything
- JSON output has all Halstead/structural fields populated (non-null)
- Exit codes use worst-of-all-metrics status
- Hotspot lists include Halstead volume
- File-level metrics (file_length, export_count) shown in console and JSON
- --metrics flag correctly filters which families are computed
- All existing and new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-halstead-structural-metrics/07-03-SUMMARY.md`
</output>
