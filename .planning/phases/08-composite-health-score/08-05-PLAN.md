---
phase: 08-composite-health-score
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/config.zig
autonomous: false
gap_closure: true
requirements:
  - COMP-03

must_haves:
  truths:
    - "Config baseline field written by --save-baseline is enforced on subsequent runs"
    - "Running with a config file containing 'baseline: 99.0' causes exit code 1 when project score is below 99.0"
  artifacts:
    - path: "src/cli/config.zig"
      provides: "deepCopyConfig copies baseline field"
      contains: "result.baseline = config.baseline;"
  key_links:
    - from: "src/cli/config.zig (deepCopyConfig)"
      to: "main.zig baseline check"
      via: "cfg.baseline non-null propagation"
      pattern: "result\\.baseline = config\\.baseline"
---

<objective>
Fix the deepCopyConfig bug in src/cli/config.zig where the `baseline` field is never copied to the result, causing config-file baselines to be silently dropped to null. This is the single functional gap identified in phase 8 verification.

Purpose: The baseline ratchet is the primary CI enforcement mechanism for health scores. Users who set a baseline via `--save-baseline` or edit their `.complexityguard.json` directly cannot currently enforce it — the bug silently bypasses the ratchet on every file-load path.

Output: One-line fix in deepCopyConfig, confirmed by a regression test and human end-to-end verification.
</objective>

<execution_context>
@/Users/benvds/.claude/get-shit-done/workflows/execute-plan.md
@/Users/benvds/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-composite-health-score/08-VERIFICATION.md
@src/cli/config.zig
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix deepCopyConfig to copy baseline field and add regression test</name>
  <files>src/cli/config.zig</files>
  <action>
In `src/cli/config.zig`, in the `deepCopyConfig` function (line 183-246):

After line 240 (`result.weights = config.weights;`), add the missing baseline copy:

```zig
// Copy baseline (plain ?f64, no allocation needed)
result.baseline = config.baseline;
```

This line must appear BEFORE the overrides comment/assignment at line 242.

The full weights+baseline block should read:

```zig
// Copy weights config (no strings, just floats)
result.weights = config.weights;

// Copy baseline (plain ?f64, no allocation needed)
result.baseline = config.baseline;

// Copy overrides (complex, skip for now - not tested in this phase)
result.overrides = null;
```

Then add a test in the `// TESTS` section of `src/cli/config.zig` that verifies the fix:

```zig
test "deepCopyConfig preserves baseline field" {
    const allocator = std.testing.allocator;
    const original = Config{
        .baseline = 77.5,
    };
    const copy = try deepCopyConfig(allocator, original);
    try std.testing.expectEqual(@as(?f64, 77.5), copy.baseline);
}
```

Place the test after the existing tests in the file. No other changes needed — `?f64` is a plain value type (no heap allocation), so no freeing required.
  </action>
  <verify>
Run `zig build test` — all tests must pass including the new "deepCopyConfig preserves baseline field" test.

Also confirm the fix is in place:
```
grep -n "result.baseline = config.baseline" src/cli/config.zig
```
Must return a match at line ~241.
  </verify>
  <done>
`zig build test` passes with zero failures. `grep` confirms `result.baseline = config.baseline;` is present in `deepCopyConfig`. New test "deepCopyConfig preserves baseline field" passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of baseline ratchet end-to-end</name>
  <action>Build binary with `zig build`, then follow the how-to-verify steps below to confirm the ratchet enforces config-file baselines.</action>
  <verify>
Build the binary first:
```
zig build
```

Test 1 — Baseline enforcement:
1. Create `.complexityguard.json` with content: `{"baseline": 99.0}`
2. Run: `./zig-out/bin/complexity-guard tests/fixtures/`
3. Expected: Exit code 1, stderr contains "Health score" and "below baseline 99.0"
4. Verify: `echo $?` prints `1`

Test 2 — Save-baseline round-trip:
1. Run: `./zig-out/bin/complexity-guard --save-baseline tests/fixtures/`
2. Check: `.complexityguard.json` contains a `"baseline"` field
3. Edit `.complexityguard.json`: change the baseline value to `99.0` (above actual score)
4. Run: `./zig-out/bin/complexity-guard tests/fixtures/`
5. Expected: Exit code 1, stderr shows health score is below baseline

Test 3 — Cleanup:
Delete or empty `.complexityguard.json` so it does not interfere with future runs.
  </verify>
  <done>Both baseline enforcement tests pass: exit code 1 on below-baseline score, and --save-baseline round-trip works end-to-end.</done>
  <resume-signal>Type "approved" if both tests confirm the ratchet is enforced, or describe what went wrong.</resume-signal>
</task>

</tasks>

<verification>
1. `zig build test` passes — no regressions, new baseline copy test passes
2. Binary built successfully with `zig build`
3. Human verified: config-file baseline enforcement causes exit code 1 when score falls below baseline
4. Human verified: --save-baseline round-trip works end-to-end
</verification>

<success_criteria>
- `result.baseline = config.baseline;` present in `deepCopyConfig` in `src/cli/config.zig`
- New test "deepCopyConfig preserves baseline field" passes
- All existing tests continue to pass
- Human confirmed: setting `"baseline": 99.0` in `.complexityguard.json` causes exit code 1
- Human confirmed: `--save-baseline` then run enforces the written baseline
</success_criteria>

<output>
After completion, create `.planning/phases/08-composite-health-score/08-05-SUMMARY.md`
</output>
