---
phase: 05-console-json-output
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/output/console.zig
  - src/output/exit_codes.zig
  - src/main.zig
autonomous: true

must_haves:
  truths:
    - "Console output groups results by file path in ESLint style"
    - "Threshold indicators show symbols (checkmark/warning/X) with color"
    - "Default mode shows only functions exceeding warning/error thresholds"
    - "Project summary displays files analyzed, functions found, warning/error counts, verdict, and top 5 hotspots"
    - "Exit code logic returns 0-4 based on analysis results with correct priority order"
  artifacts:
    - path: "src/output/console.zig"
      provides: "ESLint-style console formatter with color support, verbosity modes, summary"
      contains: "ConsoleFormatter"
    - path: "src/output/exit_codes.zig"
      provides: "Exit code determination logic with priority ordering"
      contains: "ExitCode"
  key_links:
    - from: "src/output/console.zig"
      to: "src/metrics/cyclomatic.zig"
      via: "ThresholdResult and ThresholdStatus types"
      pattern: "cyclomatic\\.ThresholdResult"
    - from: "src/output/exit_codes.zig"
      to: "src/metrics/cyclomatic.zig"
      via: "ThresholdStatus enum for counting errors/warnings"
      pattern: "cyclomatic\\.ThresholdStatus"
---

<objective>
Create the console output formatter and exit code logic for ComplexityGuard.

Purpose: Establish the output infrastructure that transforms analysis results into human-readable ESLint-style console output with color-coded threshold indicators, verbosity modes, project summary with hotspot highlights, and graduated exit codes for CI integration.

Output: Two new modules (`src/output/console.zig`, `src/output/exit_codes.zig`) with comprehensive tests, plus test imports in main.zig.
</objective>

<execution_context>
@/Users/benvds/.claude/get-shit-done/workflows/execute-plan.md
@/Users/benvds/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-console-json-output/05-RESEARCH.md
@.planning/phases/05-console-json-output/05-CONTEXT.md
@.planning/phases/04-cyclomatic-complexity/04-02-SUMMARY.md
@src/metrics/cyclomatic.zig
@src/cli/help.zig
@src/core/types.zig
@src/main.zig
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create exit code determination module</name>
  <files>src/output/exit_codes.zig</files>
  <action>
Create `src/output/exit_codes.zig` with exit code determination logic.

**ExitCode enum:**
```
pub const ExitCode = enum(u8) {
    success = 0,        // All checks pass
    errors_found = 1,   // Error-level threshold violations
    warnings_found = 2, // Warning-level violations (only if --fail-on warning)
    config_error = 3,   // Config validation/load failures
    parse_error = 4,    // Tree-sitter parse failures
};
```

Add `pub fn toInt(self: ExitCode) u8` returning `@intFromEnum(self)`.

**determineExitCode function:**
```
pub fn determineExitCode(
    has_parse_errors: bool,
    error_count: u32,
    warning_count: u32,
    fail_on_warnings: bool,
) ExitCode
```

Priority order (critical - match CI-01 through CI-05):
1. If `has_parse_errors` -> `.parse_error` (exit 4)
2. If `error_count > 0` -> `.errors_found` (exit 1)
3. If `warning_count > 0 AND fail_on_warnings` -> `.warnings_found` (exit 2)
4. Otherwise -> `.success` (exit 0)

Note: Config errors (exit 3) are handled earlier in main.zig during config load, not here.

**countViolations function:**
```
pub fn countViolations(
    threshold_results: []const cyclomatic.ThresholdResult,
) struct { warnings: u32, errors: u32 }
```

Iterates through results, counting `.warning` and `.@"error"` statuses.

**Tests (below `// TESTS` comment):**
- `determineExitCode` returns `.success` when no violations
- `determineExitCode` returns `.errors_found` when error_count > 0
- `determineExitCode` returns `.warnings_found` when warnings > 0 and fail_on_warnings true
- `determineExitCode` returns `.success` when warnings > 0 but fail_on_warnings false
- `determineExitCode` returns `.parse_error` when has_parse_errors true (even with other violations - priority test)
- `determineExitCode` priority: parse_error > errors_found > warnings_found
- `countViolations` counts correctly with mixed statuses
- `countViolations` returns zeros for all-ok results
- `ExitCode.toInt` returns correct numeric values

Import cyclomatic module as: `const cyclomatic = @import("../metrics/cyclomatic.zig");`

Add test import in main.zig test block: `_ = @import("output/exit_codes.zig");`
  </action>
  <verify>`zig build test` passes with all exit code tests green</verify>
  <done>ExitCode enum with determineExitCode and countViolations functions, all tests passing, priority order verified</done>
</task>

<task type="auto">
  <name>Task 2: Create ESLint-style console formatter with summary</name>
  <files>src/output/console.zig, src/main.zig</files>
  <action>
Create `src/output/console.zig` with the console output formatter.

**Color support (reuse pattern from help.zig):**

Import shouldUseColor from help.zig: `const help = @import("../cli/help.zig");`

Define ANSI escape helpers:
```
const AnsiCode = struct {
    pub const reset = "\x1b[0m";
    pub const red = "\x1b[31m";
    pub const yellow = "\x1b[33m";
    pub const green = "\x1b[32m";
    pub const bold = "\x1b[1m";
    pub const dim = "\x1b[2m";
};
```

**Verbosity enum:**
```
pub const Verbosity = enum {
    default,  // Problems only
    verbose,  // All functions, all files
    quiet,    // Errors only, minimal output
};
```

**OutputConfig struct:**
```
pub const OutputConfig = struct {
    use_color: bool,
    verbosity: Verbosity,
};
```

**Core formatting functions:**

1. `pub fn formatFileResults(writer: anytype, allocator: Allocator, file_path: []const u8, results: []const cyclomatic.ThresholdResult, config: OutputConfig) !bool`

   Returns true if any output was written for this file.

   ESLint-style layout per CONTEXT.md locked decisions:
   - File path as header line (bold if color enabled)
   - Problem functions indented 2 spaces below
   - Format: `  {line}:{col}  {symbol}  {severity}  Function '{name}' has complexity {N} (threshold: {T})  cyclomatic`
   - Symbols: "✓" (green) for ok, "⚠" (yellow) for warning, "✗" (red) for error
   - Default mode: skip files with no problems, skip ok functions
   - Verbose mode: show ALL files and ALL functions
   - Quiet mode: show ONLY error-level functions (skip warnings and ok)
   - Return false if nothing was written (file had no relevant results)

2. `pub fn formatSummary(writer: anytype, allocator: Allocator, file_count: u32, function_count: u32, warning_count: u32, error_count: u32, all_results: []const FileThresholdResults, config: OutputConfig) !void`

   Per CONTEXT.md locked decisions, summary at bottom includes:
   - Blank line separator
   - Files analyzed, functions found
   - Warning/error counts (if any)
   - Top 5 worst functions by complexity as hotspot highlights (only if there are functions with complexity > 1)
   - Final verdict: "PASSED" (green), "WARNINGS" (yellow), or "FAILED" (red)

   For hotspots, define:
   ```
   pub const FileThresholdResults = struct {
       path: []const u8,
       results: []const cyclomatic.ThresholdResult,
   };
   ```

   To compute top 5, iterate all FileThresholdResults, collect all ThresholdResults into a temp list, sort descending by complexity, take top 5. Display as:
   ```
   Top complexity hotspots:
     1. functionName (src/file.ts:12) complexity 25
     2. otherFunc (src/other.ts:45) complexity 18
   ```

   In quiet mode, suppress the summary entirely - only show final verdict line.

3. `pub fn formatVerdict(writer: anytype, error_count: u32, warning_count: u32, config: OutputConfig) !void`

   Single line verdict:
   - errors > 0: "✗ N problems (E errors, W warnings)" in red
   - warnings > 0 but no errors: "⚠ N warnings" in yellow
   - all clean: "✓ All checks passed" in green

   Use plural/singular correctly: "1 error" vs "2 errors", "1 warning" vs "2 warnings".

**Null metric handling per CONTEXT.md:**
- When displaying metrics in verbose mode, use "--" for null optional values
- Currently only cyclomatic is populated; cognitive, halstead, health are null
- In default/quiet mode this doesn't matter since only threshold violations shown

**Tests (below `// TESTS` comment):**

Use `std.ArrayList(u8).empty` as buffer, `.writer(allocator)` for test output capture.

- formatFileResults with all-ok results in default mode writes nothing, returns false
- formatFileResults with warning/error results in default mode writes file header and problem functions
- formatFileResults in verbose mode writes all functions including ok
- formatFileResults in quiet mode writes only error-level functions
- formatFileResults with no_color produces no ANSI codes
- formatSummary includes file count, function count, verdict
- formatSummary shows top 5 hotspots when functions exist
- formatSummary in quiet mode shows only verdict
- formatVerdict shows correct message for errors, warnings, and all-clear

Add test import in main.zig test block: `_ = @import("output/console.zig");`
  </action>
  <verify>`zig build test` passes with all console formatter tests green</verify>
  <done>ESLint-style console formatter with file grouping, color-coded threshold indicators, verbosity modes (default/verbose/quiet), project summary with top-5 hotspots, and verdict line. All tests passing.</done>
</task>

</tasks>

<verification>
1. `zig build test` -- all new tests pass alongside existing tests
2. `zig build` -- project compiles without errors
3. New modules imported in main.zig test block for test discovery
4. Exit code priority order verified by dedicated priority test
5. Console output matches ESLint-style layout (file path header, indented problems, summary at bottom)
6. Color output disabled when use_color is false (no ANSI escape codes in output)
7. Verbosity modes behave correctly: default=problems only, verbose=everything, quiet=errors only
</verification>

<success_criteria>
- src/output/exit_codes.zig exists with ExitCode enum, determineExitCode, countViolations, all tests passing
- src/output/console.zig exists with ConsoleFormatter functions, ESLint-style layout, color support, verbosity modes, summary with hotspots, all tests passing
- Both modules imported in main.zig test block
- `zig build test` passes with zero failures
</success_criteria>

<output>
After completion, create `.planning/phases/05-console-json-output/05-01-SUMMARY.md`
</output>
