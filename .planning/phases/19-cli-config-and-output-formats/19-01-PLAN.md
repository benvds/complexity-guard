---
phase: 19-cli-config-and-output-formats
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - rust/Cargo.toml
  - rust/src/lib.rs
  - rust/src/main.rs
  - rust/src/cli/mod.rs
  - rust/src/cli/args.rs
  - rust/src/cli/config.rs
  - rust/src/cli/merge.rs
  - rust/src/cli/discovery.rs
  - rust/src/output/mod.rs
  - rust/src/output/exit_codes.rs
autonomous: true
requirements:
  - CLI-01
  - CLI-02
  - CLI-03
  - OUT-05

must_haves:
  truths:
    - "Running `cargo run -- --help` shows all 28 CLI flags with correct names, short aliases, and descriptions"
    - "A `.complexityguard.json` config file placed in CWD is loaded and its values appear in the resolved config"
    - "CLI flags override config file values when both are present"
    - "Exit code 0 is returned on success, 1 on errors, 2 on warnings with --fail-on warning, 4 on parse error"
  artifacts:
    - path: "rust/src/cli/args.rs"
      provides: "clap derive Args struct with all CLI flags"
      contains: "#[derive(Parser"
    - path: "rust/src/cli/config.rs"
      provides: "Config struct with serde Deserialize and defaults"
      contains: "pub struct Config"
    - path: "rust/src/cli/merge.rs"
      provides: "merge_args_into_config function"
      contains: "pub fn merge_args_into_config"
    - path: "rust/src/cli/discovery.rs"
      provides: "Config file auto-discovery with upward search"
      contains: "pub fn discover_config"
    - path: "rust/src/output/exit_codes.rs"
      provides: "determine_exit_code function with 0-4 semantics"
      contains: "pub fn determine_exit_code"
  key_links:
    - from: "rust/src/main.rs"
      to: "rust/src/cli/args.rs"
      via: "clap Parser::parse()"
      pattern: "Args::parse"
    - from: "rust/src/main.rs"
      to: "rust/src/cli/merge.rs"
      via: "merge_args_into_config call"
      pattern: "merge_args_into_config"
    - from: "rust/src/cli/discovery.rs"
      to: "rust/src/cli/config.rs"
      via: "serde_json deserialization"
      pattern: "serde_json::from_str"
---

<objective>
Implement CLI argument parsing, config file loading with merge semantics, and exit code logic for the Rust binary.

Purpose: Establish the full CLI interface so the binary can be invoked with all flags from the Zig version, load config files, and return correct exit codes. This is the foundation for all output format plans.
Output: Runnable binary with `--help`, config loading, and exit code parity.
</objective>

<execution_context>
@/Users/benvds/.claude/get-shit-done/workflows/execute-plan.md
@/Users/benvds/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-cli-config-and-output-formats/19-RESEARCH.md
@rust/Cargo.toml
@rust/src/types.rs
@rust/src/lib.rs
@rust/src/main.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dependencies and implement CLI args, config, merge, and discovery modules</name>
  <files>
    rust/Cargo.toml
    rust/src/lib.rs
    rust/src/cli/mod.rs
    rust/src/cli/args.rs
    rust/src/cli/config.rs
    rust/src/cli/merge.rs
    rust/src/cli/discovery.rs
  </files>
  <action>
Add clap dependency to Cargo.toml:
```toml
clap = { version = "4.5", features = ["derive"] }
```

Create `rust/src/cli/mod.rs` re-exporting all submodules (args, config, merge, discovery).

Create `rust/src/cli/args.rs` with a clap derive `Args` struct containing all CLI flags from the Zig binary. Reference the exact flag list in 19-RESEARCH.md "Pattern 1: clap Derive for CLI Args". All 28 flags must be present with correct long names, short aliases (-f, -o, -q, -v, -c), and types. Key flags:
- `paths: Vec<PathBuf>` (positional)
- `--version`, `--init` (bool flags)
- `--format` / `-f`, `--output` / `-o` (Option<String>)
- `--color`, `--no-color`, `--quiet` / `-q`, `--verbose` / `-v` (bool)
- `--metrics` (Option<String>), `--duplication`, `--no-duplication` (bool), `--threads` (Option<u32>)
- `--include`, `--exclude` (Vec<String>)
- `--fail-on` (Option<String>), `--fail-health-below` (Option<f64>)
- `--config` / `-c` (Option<String>), `--baseline` (Option<String>)

Create `rust/src/cli/config.rs` with Config, OutputConfig, AnalysisConfig, FilesConfig, WeightsConfig, ThresholdsConfig, and OverrideConfig structs — all with `#[derive(Debug, Default, Clone, serde::Deserialize)]`. Include a `config_defaults() -> Config` function returning the exact defaults from 19-RESEARCH.md "Complete Config Default Values". ThresholdsConfig must have fields for all metric thresholds: cyclomatic, cognitive, halstead_volume, halstead_difficulty, halstead_effort, halstead_bugs, nesting_depth, line_count, params_count, file_length, export_count. Each threshold has warning and error (both Option<u32> or Option<f64> as appropriate).

Create `rust/src/cli/merge.rs` with `pub fn merge_args_into_config(args: &Args, config: &mut Config)` — follows the exact merge pattern from 19-RESEARCH.md "Pattern 3". CLI args override config values when present (Some). Handle: format, output_file, duplication/no_duplication, threads, include, exclude, fail_on, fail_health_below, metrics, quiet, verbose, color/no_color.

Create `rust/src/cli/discovery.rs` with `pub fn discover_config(explicit_path: Option<&str>) -> anyhow::Result<Option<Config>>`. If explicit_path is Some, load that file directly. Otherwise, search upward from CWD checking four filenames in order: `.complexityguard.json`, `complexityguard.config.json`, `.complexityguard.toml`, `complexityguard.config.toml`. For v0.8, only parse JSON files (skip TOML filenames if found). Stop at `.git` directory boundary or filesystem root. Return None if no config found.

Update `rust/src/lib.rs` to add `pub mod cli;` and `pub mod output;`.

Add unit tests in each module:
- args.rs: verify `--help` text contains key flag names, verify parsing known args
- config.rs: verify config_defaults() returns expected values, verify serde deserialization of a sample JSON config string
- merge.rs: verify CLI args override config values, verify unset args don't clobber config
- discovery.rs: verify explicit path loading, verify None returned when no config file exists
  </action>
  <verify>
    <automated>cd /Users/benvds/code/complexity-guard/rust && cargo test cli:: -- --nocapture 2>&1 | tail -20</automated>
    <manual>Check that `cargo run -- --help` prints all expected flags</manual>
  </verify>
  <done>All 28 CLI flags parse correctly, config loads from JSON file, merge applies CLI overrides, discovery searches upward to .git boundary. All unit tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Implement exit code logic and wire main.rs entry point</name>
  <files>
    rust/src/output/mod.rs
    rust/src/output/exit_codes.rs
    rust/src/main.rs
  </files>
  <action>
Create `rust/src/output/mod.rs` re-exporting exit_codes (and placeholder for future output submodules: console, json_output, sarif_output, html_output).

Create `rust/src/output/exit_codes.rs` with:
- `pub enum ExitCode { Success = 0, ErrorsFound = 1, WarningsFound = 2, ConfigError = 3, ParseError = 4 }`
- `pub fn determine_exit_code(has_parse_errors: bool, error_count: u32, warning_count: u32, fail_on_warnings: bool, baseline_failed: bool) -> ExitCode`
- Logic priority: parse_error(4) > baseline_failed(1) > error_count>0(1) > warning_count>0 && fail_on_warnings(2) > Success(0)
- Parse `--fail-on` semantics: "warning" sets fail_on_warnings=true; "none" overrides to always Success; "error" or absent is default behavior.

Update `rust/src/main.rs` to:
1. Parse args with `Args::parse()`
2. Handle `--version` (print version from Cargo.toml via `env!("CARGO_PKG_VERSION")` and exit 0)
3. Handle `--init` (print stub message "Config initialization not yet implemented." and exit 0)
4. Discover config via `discover_config(args.config.as_deref())`
5. Merge args into config via `merge_args_into_config(&args, &mut config)`
6. Print placeholder message showing resolved config (format, paths) — actual analysis and output rendering deferred to Plans 02/03
7. Return exit code via `std::process::exit(exit_code as i32)`

Add comprehensive unit tests for exit_codes.rs:
- Success when no issues
- ErrorsFound when error_count > 0
- WarningsFound when warnings exist and fail_on_warnings is true
- ParseError takes priority over all others
- baseline_failed returns ErrorsFound
- "none" fail_on override returns Success regardless of errors/warnings
  </action>
  <verify>
    <automated>cd /Users/benvds/code/complexity-guard/rust && cargo test exit_code -- --nocapture 2>&1 | tail -20 && cargo run -- --version 2>&1 && cargo run -- --help 2>&1 | head -30</automated>
  </verify>
  <done>Exit codes 0-4 match Zig semantics exactly. main.rs parses args, loads config, merges, and returns appropriate exit code. `--version` and `--help` work correctly.</done>
</task>

</tasks>

<verification>
1. `cargo build` compiles without warnings
2. `cargo test` — all existing Phase 17/18 tests still pass, plus new CLI and exit code tests
3. `cargo run -- --help` shows all 28 flags
4. `cargo run -- --version` prints the version string
5. Exit code parity: test scenarios return codes 0, 1, 2, 4 under correct conditions
</verification>

<success_criteria>
- Binary has identical CLI flag interface to Zig version (all 28 flags with correct names)
- Config file loading works with JSON format and upward directory search
- CLI flags override config values when both present
- Exit codes 0-4 returned under same conditions as Zig binary
- All tests pass (existing + new)
</success_criteria>

<output>
After completion, create `.planning/phases/19-cli-config-and-output-formats/19-01-SUMMARY.md`
</output>
