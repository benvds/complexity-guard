---
phase: 10.1-performance-benchmarks-and-fta-comparison
plan: 01
subsystem: infra
tags: [benchmarks, hyperfine, fta, shell-scripts, performance]

# Dependency graph
requires:
  - phase: 10-html-reports
    provides: Completed core product with all metrics (cyclomatic, cognitive, halstead, structural, health score)
provides:
  - Benchmark directory structure (benchmarks/scripts, projects, results, src)
  - setup.sh clone script with quick/full/stress suite selection from public-projects.json
  - bench-quick.sh: hyperfine end-to-end benchmark for 10 quick-suite projects (CG vs FTA)
  - bench-full.sh: hyperfine benchmark for all 76 projects
  - bench-stress.sh: hyperfine benchmark for massive repos with 5-min timeout protection
  - Actual baseline benchmark results in benchmarks/results/baseline-2026-02-21/
affects:
  - "10.1-02 (Zig subsystem benchmarks)"
  - "10.1-03 (metric accuracy comparison)"
  - "10.1-04 (benchmarks documentation)"
  - "Phase 11 (duplication detection) — before/after comparison infrastructure"
  - "Phase 12 (parallelization) — before/after comparison infrastructure"

# Tech tracking
tech-stack:
  added:
    - "hyperfine 1.20.0 (end-to-end binary benchmarking with --export-json and memory_usage_byte)"
    - "fta-cli 3.0.0 (auto-installed via npm per benchmark run)"
    - "python3 (JSON parsing of public-projects.json and results extraction)"
  patterns:
    - "Temp directory pattern: mktemp -d /tmp/fta-bench-XXXX + trap 'rm -rf $FTA_TEMP' EXIT"
    - "Suite selection flag: --suite quick|full|stress for tiered benchmark execution"
    - "Timestamped results: benchmarks/results/baseline-YYYY-MM-DD/ for before/after Phase 11/12 comparison"
    - "Per-project JSON files: ${project}-{suite}.json for granular analysis"
    - "--ignore-failure in hyperfine: required because CG exits 1 when threshold violations found"

key-files:
  created:
    - "benchmarks/scripts/setup.sh"
    - "benchmarks/scripts/bench-quick.sh"
    - "benchmarks/scripts/bench-full.sh"
    - "benchmarks/scripts/bench-stress.sh"
    - "benchmarks/projects/.gitkeep"
    - "benchmarks/results/.gitkeep"
  modified:
    - ".gitignore (added benchmarks/projects/*/ exclusion)"

key-decisions:
  - "--ignore-failure in hyperfine instead of --fail-on none alone: CG exits 1 on error-level violations regardless of --fail-on none; --fail-on none only suppresses warnings from triggering exit 2"
  - "Graceful clone failures in setup.sh: warn-and-continue instead of exit 1, because some tags in public-projects.json don't match upstream tag names"
  - "Per-project JSON output: separate ${project}-{suite}.json files rather than single suite JSON for granular analysis and partial-run recovery"
  - "Quick suite: 7/10 projects successfully cloned (typeorm/rxjs/effect have tag mismatches in public-projects.json)"

patterns-established:
  - "Hyperfine benchmark pattern: --warmup 3 --runs 15 --ignore-failure --export-json for statistical rigor"
  - "Stress suite: --warmup 1 --runs 5 + timeout 300 for massive repos"
  - "FTA auto-install: mktemp + npm install fta-cli@3.0.0 --prefix + trap cleanup"
  - "CG always built ReleaseFast before benchmarking (fair comparison vs FTA compiled binary)"

requirements-completed:
  - "BENCH-INFRA: Benchmark directory structure and project clone infrastructure"
  - "BENCH-E2E: End-to-end hyperfine benchmark scripts for quick/full/stress suites"

# Metrics
duration: 28min
completed: 2026-02-21
---

# Phase 10.1 Plan 01: Benchmark Infrastructure Summary

**Shell-based hyperfine benchmark infrastructure comparing ComplexityGuard vs FTA across 10-76 real-world TypeScript/JavaScript projects, producing per-project JSON results with wall-clock time and memory statistics**

## Performance

- **Duration:** 28 min
- **Started:** 2026-02-21T07:00:05Z
- **Completed:** 2026-02-21T07:28:12Z
- **Tasks:** 2
- **Files modified:** 6 created, 1 modified

## Accomplishments

- Created complete benchmark directory structure (benchmarks/scripts, projects, results, src)
- Created setup.sh with quick/full/stress suite selection, shallow clone with caching, and graceful error handling for tag mismatches
- Created three hyperfine benchmark scripts (bench-quick.sh, bench-full.sh, bench-stress.sh) that auto-install FTA, build CG in ReleaseFast, and export per-project JSON
- Successfully ran bench-quick.sh and captured baseline results for 7 of 10 quick-suite projects (typeorm/rxjs/effect tags unavailable in upstream)
- Updated .gitignore to exclude cloned project directories (ephemeral, large)

## Task Commits

Each task was committed atomically:

1. **Task 1: Create benchmark directory structure and setup.sh** - `bf30041` (feat)
2. **Task 2: Create hyperfine benchmark scripts (quick, full, stress)** - `4681e83` (feat)

## Files Created/Modified

- `benchmarks/scripts/setup.sh` - Clone quick/full/stress suite projects from public-projects.json with caching and graceful error handling
- `benchmarks/scripts/bench-quick.sh` - Hyperfine benchmark: 10 quick-suite projects, CG vs FTA, 15 runs + 3 warmup, per-project JSON
- `benchmarks/scripts/bench-full.sh` - Hyperfine benchmark: all 76 projects from public-projects.json
- `benchmarks/scripts/bench-stress.sh` - Hyperfine benchmark: massive repos (vscode, typescript, effect), 5 runs + 1 warmup, 5-min timeout
- `benchmarks/projects/.gitkeep` - Placeholder for cloned repos (git-ignored)
- `benchmarks/results/.gitkeep` - Placeholder for JSON results (committed)
- `.gitignore` - Added `benchmarks/projects/*/` exclusion and `!benchmarks/projects/.gitkeep`

## Decisions Made

- **--ignore-failure in hyperfine required:** `--fail-on none` in CG only suppresses warnings from triggering exit 2; error-level threshold violations always cause exit 1 regardless. Hyperfine's `--ignore-failure` flag is needed to benchmark projects with real violations.
- **Graceful clone failures:** setup.sh warns but continues on failed clones instead of exit 1. Three quick-suite projects (typeorm, rxjs, effect) have tag names in public-projects.json that don't match upstream (v0.3.20 vs 0.3.20 without v prefix, v7.8.1 doesn't exist, v3.13.0 is a monorepo sub-package tag). Infrastructure handles this gracefully.
- **Per-project JSON files:** Each project gets its own `${project}-{suite}.json` rather than a single suite JSON, enabling partial runs, granular analysis, and incremental result collection.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Added --ignore-failure flag to hyperfine commands**
- **Found during:** Task 2 (bench-quick.sh execution)
- **Issue:** Plan specified `--fail-on none` in CG to prevent exit code 1 from breaking hyperfine. However, CG exits 1 for error-level threshold violations regardless of `--fail-on none` — that flag only suppresses exit 2 for warning-level violations. Hyperfine treats any non-zero exit as failure on first warmup run.
- **Fix:** Added `--ignore-failure` to all three benchmark scripts alongside `--fail-on none`
- **Files modified:** benchmarks/scripts/bench-quick.sh, bench-full.sh, bench-stress.sh
- **Verification:** bench-quick.sh ran successfully across all 7 available projects with JSON results produced
- **Committed in:** 4681e83 (Task 2 commit)

**2. [Rule 1 - Bug] Graceful clone error handling in setup.sh**
- **Found during:** Task 1 (setup.sh execution — first run attempt)
- **Issue:** Three quick-suite projects (typeorm, rxjs, effect) have tag names in public-projects.json that don't exist in their upstream repos. Original script exited 1 on first clone failure.
- **Fix:** Changed error handling to warn-and-continue: print warning message, remove partial clone directory, continue to next project. Script exits 0 and reports skip count at end.
- **Files modified:** benchmarks/scripts/setup.sh
- **Verification:** Running setup.sh twice shows cached for 7 projects, warning for 3, exit 0
- **Committed in:** bf30041 (Task 1 commit)

---

**Total deviations:** 2 auto-fixed (2 Rule 1 bugs)
**Impact on plan:** Both fixes necessary for correct operation. No scope creep.

## Issues Encountered

- Three quick-suite projects (typeorm at v0.3.20, rxjs at v7.8.1, effect at v3.13.0) have tags in public-projects.json that don't exist in upstream git repos (typeorm uses 0.3.20 without v prefix; rxjs tag doesn't exist; effect uses monorepo scoped package tags like `effect@3.13.0`). These projects are skipped gracefully and excluded from benchmark runs. If needed, public-projects.json tags should be corrected in a separate task.

## Baseline Results (Quick Suite)

Actual benchmark results from first run (`bench-quick.sh` on 2026-02-21):

| Project | CG (ms) | FTA (ms) | FTA Speedup |
|---------|---------|---------|------------|
| zod | 290.9 | 150.3 | 1.93x |
| got | 130.9 | 104.2 | 1.26x |
| dayjs | 205.9 | 136.6 | 1.51x |
| vite | 480.6 | 400.1 | 1.20x |
| nestjs | 587.5 | 413.8 | 1.42x |
| webpack | 1734.9 | 1274.9 | 1.36x |
| vscode | 19844.6 | 5255.9 | 3.78x |

FTA is 1.2x-3.8x faster than CG. CG is single-threaded (Phase 12 will add parallelization). The vscode gap is largest — likely because FTA uses multi-threaded Rust for I/O while CG is single-threaded Zig.

## Next Phase Readiness

- Benchmark infrastructure is complete: directory structure, clone scripts, and hyperfine benchmark scripts all work end-to-end
- JSON results in `benchmarks/results/baseline-2026-02-21/` serve as Phase 11/12 before/after baseline
- Plan 02 (Zig subsystem benchmarks) can proceed: `benchmarks/src/` directory exists, `zig build bench` step to add
- Three missing quick-suite projects (typeorm, rxjs, effect) should have their tags corrected in public-projects.json if full-suite benchmarks are needed

---
*Phase: 10.1-performance-benchmarks-and-fta-comparison*
*Completed: 2026-02-21*
