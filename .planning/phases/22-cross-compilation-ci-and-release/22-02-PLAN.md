---
phase: 22-cross-compilation-ci-and-release
plan: 02
type: execute
wave: 2
depends_on: [22-01]
files_modified:
  - .github/workflows/rust-release.yml
  - scripts/release.sh
autonomous: true
requirements: [REL-04, REL-05]

must_haves:
  truths:
    - "Pushing a v* tag triggers the rust-release workflow and builds all 5 targets"
    - "The release job creates a GitHub Release with 5 binary archives attached"
    - "release.sh reads version from rust/Cargo.toml and bumps it correctly"
    - "Binary sizes are recorded as a step output in the release workflow"
  artifacts:
    - path: ".github/workflows/rust-release.yml"
      provides: "Tag-triggered Rust release workflow"
      contains: "softprops/action-gh-release"
    - path: "scripts/release.sh"
      provides: "Updated release script reading from Cargo.toml"
      contains: "rust/Cargo.toml"
  key_links:
    - from: ".github/workflows/rust-release.yml"
      to: "softprops/action-gh-release@v2"
      via: "release job with uploaded archives"
      pattern: "softprops/action-gh-release"
    - from: "scripts/release.sh"
      to: "rust/Cargo.toml"
      via: "grep version from Cargo.toml"
      pattern: "rust/Cargo.toml"
---

<objective>
Create a Rust release workflow triggered by version tags and update the release script to read version from `rust/Cargo.toml`. The release workflow builds all 5 targets, creates archives, measures binary sizes, and publishes a GitHub Release with the archives attached.

Purpose: Enables shipping Rust binaries to users via GitHub Releases on each version tag push.
Output: New `.github/workflows/rust-release.yml` and updated `scripts/release.sh`.
</objective>

<execution_context>
@/Users/benvds/.claude/get-shit-done/workflows/execute-plan.md
@/Users/benvds/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-cross-compilation-ci-and-release/22-RESEARCH.md
@.planning/phases/22-cross-compilation-ci-and-release/22-01-SUMMARY.md
@.github/workflows/rust-ci.yml
@.github/workflows/release.yml
@scripts/release.sh
@rust/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create rust-release.yml workflow</name>
  <files>.github/workflows/rust-release.yml</files>
  <action>
Create a new workflow file `.github/workflows/rust-release.yml` with three jobs: validate, build, release.

**Trigger:**
```yaml
on:
  push:
    branches-ignore:
      - '**'
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.8.0)'
        required: true
```

**Job 1: validate**
- runs-on: ubuntu-latest
- Extract version from tag name (strip `v` prefix) or from workflow_dispatch input.
- Validate semver format with grep regex `^[0-9]+\.[0-9]+\.[0-9]+$`.
- On workflow_dispatch, check tag does not already exist.
- Output: `version` for downstream jobs.

**Job 2: build**
- needs: validate
- Matrix with same 5 targets as rust-ci.yml cross-compile job. Include matrix fields: `name`, `os`, `target`, `use_zigbuild`, `ext` (empty or `.exe`), and `archive_name` for the output archive file name.
- Archive names follow the pattern from research: `complexity-guard-{name}.tar.gz` (unix) or `complexity-guard-{name}.zip` (windows). Names: `linux-x86_64-musl`, `linux-aarch64-musl`, `macos-x86_64`, `macos-aarch64`, `windows-x86_64`.
- Steps:
  1. actions/checkout@v4
  2. dtolnay/rust-toolchain@stable with `targets: ${{ matrix.target }}`
  3. Swatinem/rust-cache@v2 with `workspaces: "rust"`
  4. Conditional zigbuild setup (same as rust-ci.yml)
  5. Build release binary (same as rust-ci.yml)
  6. For Windows, set `RUSTFLAGS: "-C target-feature=+crt-static"`
  7. Print binary size: `ls -lh rust/target/${{ matrix.target }}/release/complexity-guard${{ matrix.ext }}`
  8. Create archive:
     - Unix: `cd rust/target/${{ matrix.target }}/release && tar czf ../../../../complexity-guard-${{ matrix.name }}.tar.gz complexity-guard`
     - Windows: `cd rust/target/${{ matrix.target }}/release && Compress-Archive -Path complexity-guard.exe -DestinationPath ../../../../complexity-guard-${{ matrix.name }}.zip`
     - Use `shell: bash` for unix steps and `shell: pwsh` for Windows archive step. Alternatively, use a conditional `if` on the matrix OS.
  9. Upload artifact: actions/upload-artifact@v4 with `name: complexity-guard-${{ matrix.name }}` and path `complexity-guard-${{ matrix.name }}.*`

**Job 3: release**
- needs: [validate, build]
- runs-on: ubuntu-latest
- permissions: `contents: write`
- Steps:
  1. actions/checkout@v4
  2. Download all artifacts: actions/download-artifact@v4 with `merge-multiple: true`
  3. List downloaded artifacts: `ls -lh complexity-guard-*`
  4. Create git tag (only if workflow_dispatch): configure git user as github-actions[bot], create annotated tag, push tag.
  5. Create GitHub release: softprops/action-gh-release@v2 with:
     - `tag_name: v${{ needs.validate.outputs.version }}`
     - `name: complexity-guard@${{ needs.validate.outputs.version }}`
     - `generate_release_notes: true`
     - files: `complexity-guard-*.tar.gz` and `complexity-guard-*.zip`

**Important:** This is a SEPARATE workflow from the existing `release.yml` (Zig). The existing Zig release workflow is left untouched. Name the workflow "Rust Release".

**Do NOT include npm-publish or homebrew-update jobs.** Those are deferred to post-stabilization (DIST-01, DIST-02 are future requirements).
  </action>
  <verify>
    <automated>cd /Users/benvds/code/complexity-guard && python3 -c "
import yaml, sys
with open('.github/workflows/rust-release.yml') as f:
    wf = yaml.safe_load(f)
# Check 3 jobs exist
jobs = list(wf['jobs'].keys())
assert 'validate' in jobs, 'validate job missing'
assert 'build' in jobs, 'build job missing'
assert 'release' in jobs, 'release job missing'
# Check build matrix has 5 targets
matrix = wf['jobs']['build']['strategy']['matrix']['include']
names = [e['name'] for e in matrix]
assert len(names) == 5, f'Expected 5 targets, got {len(names)}'
for expected in ['linux-x86_64-musl', 'linux-aarch64-musl', 'macos-x86_64', 'macos-aarch64', 'windows-x86_64']:
    assert expected in names, f'{expected} missing from matrix'
# Check release job has gh-release action
release_steps = wf['jobs']['release']['steps']
gh_release = [s for s in release_steps if s.get('uses','').startswith('softprops/action-gh-release')]
assert len(gh_release) > 0, 'softprops/action-gh-release not found in release job'
print('PASS: rust-release.yml has validate + build (5 targets) + release with gh-release')
"</automated>
  </verify>
  <done>rust-release.yml exists with validate/build/release jobs, 5-target matrix, and GitHub Release creation via softprops/action-gh-release@v2.</done>
</task>

<task type="auto">
  <name>Task 2: Update release.sh for Rust version source</name>
  <files>scripts/release.sh</files>
  <action>
Update `scripts/release.sh` to read and write the version from `rust/Cargo.toml` instead of `src/main.zig`.

Changes:
1. **Read current version:** Replace the `grep` on `src/main.zig` with reading from `rust/Cargo.toml`:
   ```bash
   CURRENT_VERSION=$(grep '^version' rust/Cargo.toml | head -1 | sed -E 's/version = "(.*)"/\1/')
   ```
   Update the error message to reference `rust/Cargo.toml`.

2. **Write new version:** Replace the `sed` on `src/main.zig` with updating `rust/Cargo.toml`:
   ```bash
   sed -i.bak "s/^version = \".*\"/version = \"$NEW_VERSION\"/" rust/Cargo.toml
   rm rust/Cargo.toml.bak
   ```

3. **Stage file:** Replace `git add src/main.zig` with `git add rust/Cargo.toml`.

4. **Keep all npm package.json updates** unchanged (they still need version bumping for future npm distribution).

5. **Update the usage comment** at the top of the script to note it reads from `rust/Cargo.toml`.

6. **Update the flow comment** to reference `rust/Cargo.toml` instead of `src/main.zig`.

Do NOT change the changelog generation, git commit, tag creation, or push logic -- those remain the same.
  </action>
  <verify>
    <automated>cd /Users/benvds/code/complexity-guard && grep -q 'rust/Cargo.toml' scripts/release.sh && ! grep -q 'src/main.zig' scripts/release.sh && echo "PASS: release.sh reads from Cargo.toml, no main.zig references" || echo "FAIL"</automated>
  </verify>
  <done>release.sh reads version from rust/Cargo.toml, writes updated version back to rust/Cargo.toml, and stages rust/Cargo.toml for commit. No references to src/main.zig remain.</done>
</task>

</tasks>

<verification>
- `rust-release.yml` parses as valid YAML.
- All 5 targets present in release build matrix.
- `softprops/action-gh-release@v2` used for GitHub Release creation.
- `release.sh` reads/writes `rust/Cargo.toml` with no `src/main.zig` references.
- Existing `release.yml` (Zig) is untouched.
</verification>

<success_criteria>
- `rust-release.yml` has validate, build (5 targets), and release jobs.
- `release.sh` uses `rust/Cargo.toml` as version source of truth.
- The existing Zig release workflow is preserved unchanged.
</success_criteria>

<output>
After completion, create `.planning/phases/22-cross-compilation-ci-and-release/22-02-SUMMARY.md`
</output>
