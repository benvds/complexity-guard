---
phase: 22-cross-compilation-ci-and-release
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/rust-ci.yml
autonomous: true
requirements: [REL-01, REL-02, REL-03, REL-04, REL-05]

must_haves:
  truths:
    - "CI builds succeed for all five targets: linux-x86_64-musl, linux-aarch64-musl, macos-x86_64, macos-aarch64, windows-x86_64"
    - "Each binary that can run on its CI runner executes --version successfully"
    - "Binary sizes are printed in CI logs for all five targets"
  artifacts:
    - path: ".github/workflows/rust-ci.yml"
      provides: "Extended Rust CI with 5-target cross-compilation matrix"
      contains: "cross-compile"
  key_links:
    - from: ".github/workflows/rust-ci.yml"
      to: "rust/Cargo.toml"
      via: "cargo build/zigbuild with --target flag"
      pattern: "cargo (zigbuild|build) --release --target"
---

<objective>
Extend the existing `rust-ci.yml` with a cross-compilation matrix covering all five release targets. Each target builds a release binary, prints its size, and (where possible) verifies execution with `--version`.

Purpose: Validates that the Rust binary compiles for all five platforms on every push, catching cross-compilation regressions before release.
Output: Updated `.github/workflows/rust-ci.yml` with a 5-target cross-compile job.
</objective>

<execution_context>
@/Users/benvds/.claude/get-shit-done/workflows/execute-plan.md
@/Users/benvds/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-cross-compilation-ci-and-release/22-RESEARCH.md
@.github/workflows/rust-ci.yml
@rust/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend rust-ci.yml with 5-target cross-compilation matrix</name>
  <files>.github/workflows/rust-ci.yml</files>
  <action>
Replace the existing single-target `cross-compile-linux-musl` job with a matrix-based `cross-compile` job covering all five targets. Keep the existing `build-and-test` job (ubuntu+macos native build/test/lint) unchanged.

The new `cross-compile` job structure:

1. **Matrix strategy** with 5 entries:
   - `linux-x86_64-musl`: os=ubuntu-latest, target=x86_64-unknown-linux-musl, use_zigbuild=true
   - `linux-aarch64-musl`: os=ubuntu-latest, target=aarch64-unknown-linux-musl, use_zigbuild=true
   - `macos-aarch64`: os=macos-latest, target=aarch64-apple-darwin, use_zigbuild=false
   - `macos-x86_64`: os=macos-latest, target=x86_64-apple-darwin, use_zigbuild=false
   - `windows-x86_64`: os=windows-latest, target=x86_64-pc-windows-msvc, use_zigbuild=false

2. **Steps for each matrix entry:**
   - actions/checkout@v4
   - dtolnay/rust-toolchain@stable with `targets: ${{ matrix.target }}`
   - Swatinem/rust-cache@v2 with `workspaces: "rust"`
   - Conditional: if use_zigbuild, install Zig (`pip3 install ziglang`) and cargo-zigbuild (`cargo install --locked cargo-zigbuild`)
   - Build: if use_zigbuild, run `cargo zigbuild --release --target ${{ matrix.target }}`; else run `cargo build --release --target ${{ matrix.target }}`
   - For Windows builds, set env `RUSTFLAGS: "-C target-feature=+crt-static"` on the build step
   - Print binary size: `ls -lh rust/target/${{ matrix.target }}/release/complexity-guard` (use `.exe` suffix for Windows)
   - Run `--version` verification where possible:
     - linux-x86_64-musl: runs natively on ubuntu-latest (x86_64) -- verify
     - linux-aarch64-musl: CANNOT run on x86_64 ubuntu -- skip with comment
     - macos-aarch64: runs natively on macos-latest (ARM64) -- verify
     - macos-x86_64: runs via Rosetta 2 on macos-latest (ARM64) -- verify
     - windows-x86_64: runs natively on windows-latest -- verify

   Use a matrix field `can_test: true/false` to conditionally run the verification step. Set `can_test: false` only for `linux-aarch64-musl`.

3. **Working directory:** All cargo commands use `working-directory: rust`.

4. **Do NOT remove or modify the existing `build-and-test` job** -- it provides lint, fmt, and test gates.

Important details:
- The `working-directory` key applies to the `run` step, but `ls -lh` paths must be relative to the repo root since there's no working-directory on that step. Use `rust/target/...` path prefix.
- For Windows, the binary extension is `.exe`. Use a matrix field `ext` (empty string for unix, `.exe` for windows) to handle this.
- Cache key should include `matrix.target` to avoid cache collisions. Swatinem/rust-cache handles this automatically via the target in the build artifacts.
  </action>
  <verify>
    <automated>cd /Users/benvds/code/complexity-guard && python3 -c "
import yaml, sys
with open('.github/workflows/rust-ci.yml') as f:
    wf = yaml.safe_load(f)
jobs = wf['jobs']
# Check cross-compile job exists
assert 'cross-compile' in jobs, 'cross-compile job missing'
matrix = jobs['cross-compile']['strategy']['matrix']['include']
targets = [e['target'] for e in matrix]
assert 'x86_64-unknown-linux-musl' in targets, 'linux x86_64 musl missing'
assert 'aarch64-unknown-linux-musl' in targets, 'linux aarch64 musl missing'
assert 'aarch64-apple-darwin' in targets, 'macos aarch64 missing'
assert 'x86_64-apple-darwin' in targets, 'macos x86_64 missing'
assert 'x86_64-pc-windows-msvc' in targets, 'windows x86_64 missing'
print('All 5 targets present in cross-compile matrix')
# Check build-and-test still exists
assert 'build-and-test' in jobs, 'build-and-test job missing'
print('build-and-test job preserved')
print('PASS')
"</automated>
    <manual>Push to rust branch and verify CI runs all 5 cross-compile targets (check GitHub Actions tab)</manual>
  </verify>
  <done>rust-ci.yml has a cross-compile job with all 5 targets in a matrix, each building release binaries, printing sizes, and verifying --version where architecturally possible (4 of 5 targets).</done>
</task>

</tasks>

<verification>
- The workflow YAML is valid (no syntax errors).
- All 5 target triples appear in the matrix.
- The existing build-and-test job (lint, fmt, test) is preserved unchanged.
- cargo-zigbuild is used only for Linux musl targets.
- Windows build includes static CRT flag.
- Binary size is printed for all 5 targets.
</verification>

<success_criteria>
- `rust-ci.yml` contains a 5-target cross-compilation matrix job.
- The existing build-and-test job is untouched.
- The workflow parses as valid YAML with all required matrix entries.
</success_criteria>

<output>
After completion, create `.planning/phases/22-cross-compilation-ci-and-release/22-01-SUMMARY.md`
</output>
