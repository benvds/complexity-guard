---
phase: 05.1-ci-cd-release-pipeline-documentation
plan: 04
subsystem: release-infrastructure
tags: [ci, github-actions, release-automation, npm, homebrew]
dependency_graph:
  requires:
    - 05.1-01: changelog format and CI test workflow
    - 05.1-02: npm platform packages and Homebrew formula template
  provides: [complete-release-pipeline, automated-cross-compilation, multi-channel-distribution]
  affects: [future-releases, npm-publishing, homebrew-updates]
tech_stack:
  added: [github-actions-workflows, cross-compilation-matrix]
  patterns:
    - "workflow_dispatch for manual release triggering"
    - "version validation before builds"
    - "single-runner cross-compilation with Zig"
    - "artifact upload/download for job coordination"
    - "SHA256 checksum computation for Homebrew"
    - "npm package version synchronization"
key_files:
  created:
    - .github/workflows/release.yml
  modified: []
decisions:
  - "Manual dispatch trigger prevents accidental releases"
  - "Version validation catches format errors before expensive builds"
  - "Single Ubuntu runner for all Zig cross-compilation targets (no matrix of OS runners)"
  - "Separate job dependency chain: validate -> build -> release -> (npm-publish || homebrew-update)"
  - "actions/upload-artifact@v4 and actions/download-artifact@v4 for artifact coordination"
  - "softprops/action-gh-release@v2 for GitHub release creation"
  - "NPM_TOKEN secret for npm publishing (OIDC future enhancement)"
  - "Homebrew formula updated locally (manual tap sync until automation added)"
metrics:
  duration: 79
  tasks_completed: 1
  commits: 1
  completed_date: 2026-02-15
---

# Phase 05.1 Plan 04: Release Workflow Summary

**One-liner:** Complete GitHub Actions release workflow orchestrating cross-compilation, GitHub release, npm publish, and Homebrew formula updates for all 5 platforms.

## What Was Built

Created `.github/workflows/release.yml` - a comprehensive release pipeline that automates the entire release process from a single manual trigger.

**Workflow architecture:**

1. **validate job** - Validates semver format, checks for duplicate tags, outputs version for downstream jobs
2. **build job** - Cross-compiles binaries for 5 targets (x86_64-linux, aarch64-linux, x86_64-macos, aarch64-macos, x86_64-windows) using strategy matrix, creates tar.gz/zip archives, uploads artifacts
3. **release job** - Creates git tag, creates GitHub release with softprops/action-gh-release@v2, attaches all binary archives
4. **npm-publish job** - Extracts binaries to platform package directories, updates version in all package.json files, publishes 5 platform packages then main package to npm
5. **homebrew-update job** - Computes SHA256 checksums for all archives, updates homebrew/complexity-guard.rb with version and checksums

**Key features:**

- **Manual dispatch** - workflow_dispatch with version input prevents accidental releases
- **Fail fast** - Version validation happens before any builds, saving CI time on errors
- **Single runner** - All 5 targets built from single Ubuntu runner using Zig cross-compilation
- **Artifact coordination** - upload-artifact@v4 in build job, download-artifact@v4 in downstream jobs
- **Parallel distribution** - npm-publish and homebrew-update run in parallel after release
- **Version synchronization** - Updates version in main package.json, 5 platform package.json files, and optionalDependencies

## Tasks Completed

| # | Task | Commit | Files |
|---|------|--------|-------|
| 1 | Create release workflow with build, publish, and Homebrew update | 01c007c | .github/workflows/release.yml |

## Deviations from Plan

None - plan executed exactly as written.

## Key Technical Decisions

**Manual dispatch over automated triggers**: Used workflow_dispatch instead of push-tag trigger. This gives explicit control over releases and allows version input validation before any work begins. Prevents accidental releases from tag typos or premature tagging.

**Version validation job**: Separate validate job checks semver format and tag existence before build matrix runs. This saves significant CI time when version input is malformed, as the 5-target build matrix never starts.

**Single Ubuntu runner for cross-compilation**: All 5 targets built from single ubuntu-latest runner using Zig's cross-compilation. This is simpler and faster than strategy matrix with multiple OS runners (macOS/Windows runners are slower to provision). Zig handles cross-compilation natively.

**actions/upload-artifact@v4**: Used v4 (not v3) for artifact upload/download. v4 has better merge-multiple support and cleaner artifact handling for multi-job workflows.

**softprops/action-gh-release@v2**: Used v2 (latest) with generate_release_notes for auto-generated release notes from commits. This reduces manual release note writing while providing useful changelog.

**NPM_TOKEN secret pattern**: Used secrets.NPM_TOKEN environment variable for npm authentication. The workflow is ready for OIDC trusted publishing when npm supports it for the organization (id-token: write permission already granted).

**Homebrew formula local update**: Workflow updates homebrew/complexity-guard.rb locally with SHA256 checksums but doesn't push to tap repository. This is documented as a manual step until tap automation is configured with PAT and git push.

**Platform package version sync**: Workflow updates version in 6 locations: main package.json version field, 5 platform package.json files, and 5 optionalDependencies entries in main package.json. This ensures all npm packages have consistent versioning.

**Portable sed pattern**: Used sed -i.bak pattern from Phase 05.1-01 for macOS/Linux compatibility when updating package.json files and Homebrew formula.

## Dependencies

**Requires:**
- 05.1-01: CHANGELOG.md format and CI test workflow (mlugg/setup-zig pattern)
- 05.1-02: npm package structure (package.json, npm/*/package.json, homebrew/complexity-guard.rb template)

**Provides:**
- complete-release-pipeline: Single workflow from version input to multi-channel distribution
- automated-cross-compilation: 5-target binary builds from single runner
- multi-channel-distribution: GitHub release, npm publish, Homebrew formula update

**Affects:**
- future-releases: All future releases will use this workflow
- npm-publishing: Automated npm package distribution for all platforms
- homebrew-updates: Automated SHA256 checksum computation and formula updates

## Testing/Verification

**YAML syntax:**
- Valid YAML structure (no parse errors)
- All jobs have required fields (runs-on, steps)
- All actions use @v4 or @v2 (no deprecated versions)

**workflow_dispatch trigger:**
- Trigger type: workflow_dispatch (manual)
- Input: version (required, type: string, description provided)

**Build matrix coverage:**
- 5 targets defined in strategy matrix
- Targets: x86_64-linux, aarch64-linux, x86_64-macos, aarch64-macos, x86_64-windows
- Correct extensions: "" for Unix, ".exe" for Windows
- Archive formats: tar.gz for Unix, zip for Windows

**Job dependency chain:**
- validate has no dependencies
- build needs: validate
- release needs: build
- npm-publish needs: release
- homebrew-update needs: release
- Correct sequencing: validate -> build -> release -> (parallel: npm-publish, homebrew-update)

**GitHub release action:**
- Uses: softprops/action-gh-release@v2 (latest)
- tag_name: v${{ needs.validate.outputs.version }}
- generate_release_notes: true
- files: complexity-guard-*.tar.gz, complexity-guard-*.zip

**npm publish steps:**
- 6 npm publish commands: 5 platform packages + 1 main package
- Binary extraction for all 5 platforms
- Version update in all 6 package.json files
- NODE_AUTH_TOKEN from secrets.NPM_TOKEN
- --access public for scoped packages

**SHA256 computation:**
- 4 shasum commands (aarch64-macos, x86_64-macos, aarch64-linux, x86_64-linux)
- Output captured to GITHUB_OUTPUT for downstream usage
- sed replacements for PLACEHOLDER_SHA256_* in Homebrew formula

**Permissions:**
- validate: no special permissions
- build: no special permissions
- release: contents: write (for tag and release creation)
- npm-publish: id-token: write (for OIDC)
- homebrew-update: no special permissions

## What's Next

**Ready for first release**: The complete release pipeline is now operational. To create the 0.1.0 release:
1. Navigate to Actions tab -> Release workflow
2. Click "Run workflow"
3. Enter version: 0.1.0
4. Workflow will build, release, and publish to all channels
5. Manually copy updated homebrew/complexity-guard.rb to tap repository

**Future enhancements:**
- Automate Homebrew tap update with PAT and git push
- Adopt npm OIDC trusted publishing when available
- Add release notes template or manual input option
- Add checksum verification step after binary creation

**Unblocks:**
- Phase 06: Can now focus on core functionality knowing releases are automated
- Documentation: README can reference npm install and brew install paths

## Self-Check: PASSED

**Created files verified:**
- FOUND: /Users/benvds/code/complexity-guard/.github/workflows/release.yml

**Commits verified:**
- FOUND: 01c007c (Task 1: Create release workflow)

**YAML structure verified:**
- workflow_dispatch trigger present: YES
- 5 targets in build matrix: YES (x86_64-linux, aarch64-linux, x86_64-macos, aarch64-macos, x86_64-windows)
- Job dependency chain correct: YES (validate -> build -> release -> npm-publish/homebrew-update)
- softprops/action-gh-release@v2 used: YES
- npm publish for 6 packages: YES (5 platform + 1 main)
- SHA256 computation present: YES (4 checksums computed)

All files created, all commits exist, all verification checks passed.
