---
phase: 05.1-ci-cd-release-pipeline-documentation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - bin/complexity-guard.js
  - npm/darwin-arm64/package.json
  - npm/darwin-x64/package.json
  - npm/linux-arm64/package.json
  - npm/linux-x64/package.json
  - npm/windows-x64/package.json
  - homebrew/complexity-guard.rb
autonomous: true

must_haves:
  truths:
    - "Main package.json declares optionalDependencies for all 5 platform packages"
    - "Each platform package.json has correct os and cpu fields for platform filtering"
    - "bin/complexity-guard.js wrapper resolves and executes the correct platform binary"
    - "Homebrew formula template handles macOS (arm64/x64) and Linux (arm64/x64) with SHA256 placeholders"
  artifacts:
    - path: "package.json"
      provides: "Main npm package manifest with optionalDependencies"
      contains: "@complexity-guard/darwin-arm64"
    - path: "bin/complexity-guard.js"
      provides: "Node.js wrapper that finds and executes platform-specific binary"
      contains: "spawnSync"
    - path: "npm/darwin-arm64/package.json"
      provides: "macOS ARM64 platform package"
      contains: "\"os\": [\"darwin\"]"
    - path: "homebrew/complexity-guard.rb"
      provides: "Homebrew formula template for own tap"
      contains: "class ComplexityGuard < Formula"
  key_links:
    - from: "bin/complexity-guard.js"
      to: "npm/*/package.json"
      via: "platform-to-package-name mapping"
      pattern: "@complexity-guard/"
    - from: "package.json"
      to: "npm/*/package.json"
      via: "optionalDependencies version sync"
      pattern: "optionalDependencies"
---

<objective>
Create npm platform packages structure and Homebrew formula template for multi-channel binary distribution.

Purpose: Enable npm install and brew install to deliver the correct prebuilt binary for each user's platform.
Output: package.json, bin/complexity-guard.js, npm/**/package.json (5 platforms), homebrew/complexity-guard.rb
</objective>

<execution_context>
@/Users/benvds/.claude/get-shit-done/workflows/execute-plan.md
@/Users/benvds/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.1-ci-cd-release-pipeline-documentation/05.1-CONTEXT.md
@.planning/phases/05.1-ci-cd-release-pipeline-documentation/05.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create npm platform packages and wrapper script</name>
  <files>package.json, bin/complexity-guard.js, npm/darwin-arm64/package.json, npm/darwin-x64/package.json, npm/linux-arm64/package.json, npm/linux-x64/package.json, npm/windows-x64/package.json</files>
  <action>
Create the npm platform packages pattern (like SWC/Prisma/esbuild per user decisions).

**Main package.json** (project root):
```json
{
  "name": "complexity-guard",
  "version": "0.1.0",
  "description": "Fast complexity analysis for TypeScript/JavaScript â€” single static binary",
  "bin": {
    "complexity-guard": "bin/complexity-guard.js"
  },
  "files": ["bin/"],
  "optionalDependencies": {
    "@complexity-guard/darwin-arm64": "0.1.0",
    "@complexity-guard/darwin-x64": "0.1.0",
    "@complexity-guard/linux-arm64": "0.1.0",
    "@complexity-guard/linux-x64": "0.1.0",
    "@complexity-guard/windows-x64": "0.1.0"
  },
  "license": "MIT",
  "repository": {
    "type": "git",
    "url": "https://github.com/benvds/complexity-guard"
  },
  "keywords": ["complexity", "cyclomatic", "typescript", "javascript", "analysis", "metrics"]
}
```

**bin/complexity-guard.js** (main wrapper, make executable):
- Shebang: `#!/usr/bin/env node`
- Map process.platform + process.arch to package names:
  - darwin-arm64 -> @complexity-guard/darwin-arm64
  - darwin-x64 -> @complexity-guard/darwin-x64
  - linux-arm64 -> @complexity-guard/linux-arm64
  - linux-x64 -> @complexity-guard/linux-x64
  - win32-x64 -> @complexity-guard/windows-x64
- Binary name: `complexity-guard` (or `complexity-guard.exe` on win32)
- Try to resolve platform package via require.resolve(`${pkgName}/package.json`), then derive binary path from package directory
- If binary not found, print helpful error: unsupported platform, or suggest `npm install --force`
- Execute binary with spawnSync, passing process.argv.slice(2), stdio: 'inherit'
- Exit with binary's exit code (result.status ?? 1)

**Platform package.json files** (one in each npm/<platform>/ directory):
Create 5 directories: npm/darwin-arm64/, npm/darwin-x64/, npm/linux-arm64/, npm/linux-x64/, npm/windows-x64/

Each platform package.json contains:
- name: "@complexity-guard/<platform>" (e.g., @complexity-guard/darwin-arm64)
- version: "0.1.0"
- description: "ComplexityGuard binary for <platform description>"
- os: [<platform>] (darwin, darwin, linux, linux, win32)
- cpu: [<arch>] (arm64, x64, arm64, x64, x64)
- files: ["complexity-guard"] (or ["complexity-guard.exe"] for windows-x64)
- license: "MIT"
- repository: same as main package

The binary files themselves are NOT included -- they'll be placed by the release workflow. The package.json files just define the package structure.

Add .gitkeep to each npm/<platform>/ directory so the directories are tracked in git (the binary files will be .gitignored).

Add to .gitignore: `npm/*/complexity-guard` and `npm/*/complexity-guard.exe` to avoid committing binaries.
  </action>
  <verify>
Verify all 5 platform package.json files exist with correct os/cpu fields.
Run `node -c bin/complexity-guard.js` to verify JavaScript syntax.
Verify package.json has all 5 optionalDependencies.
Check .gitignore contains npm binary exclusions.
  </verify>
  <done>Main package.json with optionalDependencies, bin wrapper script with platform detection, and 5 platform package.json files with correct os/cpu fields all exist. Binaries are gitignored.</done>
</task>

<task type="auto">
  <name>Task 2: Create Homebrew formula template</name>
  <files>homebrew/complexity-guard.rb</files>
  <action>
Create homebrew/complexity-guard.rb as a Homebrew formula template. Per user decision: own tap first (brew install benvds/tap/complexity-guard).

The formula:
- Class: ComplexityGuard < Formula
- desc: "Fast complexity analysis for TypeScript/JavaScript"
- homepage: "https://github.com/benvds/complexity-guard" (placeholder URL)
- version: "0.1.0"
- license: "MIT"
- Platform detection using on_macos/on_linux blocks with Hardware::CPU.arm?/intel? checks:
  - macOS ARM64: downloads complexity-guard-aarch64-macos.tar.gz
  - macOS x64: downloads complexity-guard-x86_64-macos.tar.gz
  - Linux ARM64: downloads complexity-guard-aarch64-linux.tar.gz
  - Linux x64: downloads complexity-guard-x86_64-linux.tar.gz
- URLs point to GitHub releases: https://github.com/benvds/complexity-guard/releases/download/v#{version}/complexity-guard-<target>.tar.gz
- SHA256 placeholders: "PLACEHOLDER_SHA256_<TARGET>" (will be replaced by release workflow)
- install method: `bin.install "complexity-guard"`
- test block: `assert_match version.to_s, shell_output("#{bin}/complexity-guard --version")`

Add a comment at top: "# This formula is a template. SHA256 values are updated by the release workflow."

This file will be copied into a separate homebrew-tap repo during release. For now it lives in the main repo as a template.
  </action>
  <verify>
Run `ruby -c homebrew/complexity-guard.rb` to verify Ruby syntax.
Verify formula contains platform detection for all 4 targets (no Windows for Homebrew).
  </verify>
  <done>Homebrew formula template exists with platform-specific download URLs, SHA256 placeholders, and proper install/test blocks for all 4 non-Windows targets.</done>
</task>

</tasks>

<verification>
- `node -c bin/complexity-guard.js` passes (valid JavaScript)
- `ruby -c homebrew/complexity-guard.rb` passes (valid Ruby)
- All 5 npm platform directories exist with package.json
- Main package.json version matches platform package versions (all 0.1.0)
- .gitignore excludes binary files from npm directories
</verification>

<success_criteria>
- npm install structure is ready: main package with optionalDependencies, wrapper script, 5 platform packages
- Homebrew formula template is ready: platform detection, download URLs, SHA256 placeholders
- No actual binaries are committed (only package manifests and templates)
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-ci-cd-release-pipeline-documentation/05.1-02-SUMMARY.md`
</output>
