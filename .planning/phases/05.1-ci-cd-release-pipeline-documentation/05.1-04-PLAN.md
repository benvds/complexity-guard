---
phase: 05.1-ci-cd-release-pipeline-documentation
plan: 04
type: execute
wave: 2
depends_on: ["05.1-01", "05.1-02"]
files_modified:
  - .github/workflows/release.yml
autonomous: true

must_haves:
  truths:
    - "Release workflow triggers via manual dispatch with version input"
    - "Workflow validates semver format before building"
    - "Workflow builds all 5 binary targets using Zig cross-compilation from single runner"
    - "Workflow creates GitHub release with all binary archives attached"
    - "Workflow publishes main package and all 5 platform packages to npm"
    - "Workflow updates Homebrew formula with correct SHA256 checksums"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "Complete release pipeline: build, GitHub release, npm publish, Homebrew update"
      contains: "workflow_dispatch"
  key_links:
    - from: ".github/workflows/release.yml"
      to: "package.json"
      via: "npm publish step reads package manifest"
      pattern: "npm publish"
    - from: ".github/workflows/release.yml"
      to: "npm/*/package.json"
      via: "publishes platform packages to npm"
      pattern: "npm publish"
    - from: ".github/workflows/release.yml"
      to: "homebrew/complexity-guard.rb"
      via: "updates SHA256 checksums in formula"
      pattern: "sha256"
---

<objective>
Create the GitHub Actions release workflow that orchestrates the complete release pipeline: cross-compile binaries, create GitHub release, publish npm packages, and update Homebrew formula.

Purpose: Single manual-dispatch workflow that handles the entire release from build to distribution across all channels.
Output: .github/workflows/release.yml
</objective>

<execution_context>
@/Users/benvds/.claude/get-shit-done/workflows/execute-plan.md
@/Users/benvds/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.1-ci-cd-release-pipeline-documentation/05.1-CONTEXT.md
@.planning/phases/05.1-ci-cd-release-pipeline-documentation/05.1-RESEARCH.md
@.planning/phases/05.1-ci-cd-release-pipeline-documentation/05.1-01-SUMMARY.md
@.planning/phases/05.1-ci-cd-release-pipeline-documentation/05.1-02-SUMMARY.md
@package.json
@homebrew/complexity-guard.rb
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create release workflow with build, publish, and Homebrew update</name>
  <files>.github/workflows/release.yml</files>
  <action>
Create .github/workflows/release.yml per locked decisions: manual dispatch (workflow_dispatch with version input), single workflow for build + GitHub release + npm publish + Homebrew tap update.

**Workflow structure:**

```yaml
name: Release
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: true
        type: string
```

**Job 1: validate**
- runs-on: ubuntu-latest
- Steps:
  1. Validate version format with regex: `^[0-9]+\.[0-9]+\.[0-9]+$` (fail fast on bad input)
  2. Check that git tag v$VERSION does not already exist (prevent duplicate releases)
  3. Output: version string for downstream jobs

**Job 2: build**
- runs-on: ubuntu-latest
- needs: validate
- Strategy matrix for 5 targets:
  - { target: x86_64-linux, os: linux, arch: x64, ext: "" }
  - { target: aarch64-linux, os: linux, arch: arm64, ext: "" }
  - { target: x86_64-macos, os: macos, arch: x64, ext: "" }
  - { target: aarch64-macos, os: macos, arch: arm64, ext: "" }
  - { target: x86_64-windows, os: windows, arch: x64, ext: ".exe" }
- Steps:
  1. actions/checkout@v4
  2. mlugg/setup-zig@v2 with version: 0.15.2
  3. Build: `zig build -Dtarget=${{ matrix.target }} -Doptimize=ReleaseSafe`
  4. Create archive:
     - For non-Windows: `tar czf complexity-guard-${{ matrix.target }}.tar.gz -C zig-out/bin complexity-guard`
     - For Windows: `zip complexity-guard-${{ matrix.target }}.zip zig-out/bin/complexity-guard.exe` (use powershell or zip command)
  5. Upload artifact: actions/upload-artifact@v4 with name matching target

**Job 3: release**
- runs-on: ubuntu-latest
- needs: build
- Steps:
  1. actions/checkout@v4
  2. Download all artifacts: actions/download-artifact@v4 with merge-multiple
  3. Create git tag: `git tag -a "v$VERSION" -m "Release $VERSION"` and push tag
  4. Create GitHub release: softprops/action-gh-release@v2
     - tag_name: v${{ inputs.version }}
     - name: Release ${{ inputs.version }}
     - generate_release_notes: true (use GitHub auto-generated notes)
     - files: complexity-guard-*.tar.gz, complexity-guard-*.zip

**Job 4: npm-publish**
- runs-on: ubuntu-latest
- needs: release
- permissions: id-token: write (for OIDC trusted publishing)
- Steps:
  1. actions/checkout@v4
  2. Setup Node: actions/setup-node@v4 with node-version: 20, registry-url: https://registry.npmjs.org
  3. Download all artifacts: actions/download-artifact@v4
  4. Copy binaries to platform package directories:
     - Extract complexity-guard-x86_64-linux.tar.gz -> npm/linux-x64/complexity-guard
     - Extract complexity-guard-aarch64-linux.tar.gz -> npm/linux-arm64/complexity-guard
     - Extract complexity-guard-x86_64-macos.tar.gz -> npm/darwin-x64/complexity-guard
     - Extract complexity-guard-aarch64-macos.tar.gz -> npm/darwin-arm64/complexity-guard
     - Extract complexity-guard-x86_64-windows.zip -> npm/windows-x64/complexity-guard.exe
  5. Update version in all package.json files (main + 5 platform) to $VERSION using sed
  6. Publish each platform package: `cd npm/<platform> && npm publish --access public` (with NODE_AUTH_TOKEN)
  7. Publish main package: `npm publish --access public` (with NODE_AUTH_TOKEN)
  8. Use env NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }} (or OIDC if configured)

**Job 5: homebrew-update**
- runs-on: ubuntu-latest
- needs: release
- Steps:
  1. actions/checkout@v4
  2. Download all artifacts
  3. Compute SHA256 for each archive: `shasum -a 256 complexity-guard-<target>.tar.gz | awk '{print $1}'`
  4. Update homebrew/complexity-guard.rb: replace version, replace each SHA256 placeholder with actual hash using sed
  5. Output updated formula (or commit to tap repo using a PAT if available -- for now, just update the local formula file and note that manual copy to tap repo is needed until automation is set up)

Add clear comments throughout the workflow explaining each job and step. Include a comment at the top noting this is triggered manually for milestone releases.

For the npm publish step, use `secrets.NPM_TOKEN` environment variable pattern. The OIDC trusted publishing approach can be adopted later when npm supports it for the organization/scope.

**Important implementation details from research:**
- Use actions/upload-artifact@v4 and actions/download-artifact@v4 (v4, not v3)
- Separate build matrix from release creation (per Pitfall 3 in research)
- Single runner for all Zig targets (Zig cross-compiles, no need for multiple OS runners)
- Validate version input before any builds (per Pitfall 5 in research)
  </action>
  <verify>
Run `cat .github/workflows/release.yml` to verify YAML structure.
Verify workflow_dispatch trigger with version input.
Verify 5-target build matrix.
Verify softprops/action-gh-release usage.
Verify npm publish steps for all 6 packages (main + 5 platforms).
Verify SHA256 computation for Homebrew formula.
  </verify>
  <done>Release workflow exists with manual dispatch trigger, version validation, 5-target cross-compilation matrix, GitHub release creation, npm publish for all packages, and Homebrew formula SHA256 update. Single workflow orchestrates the complete release pipeline.</done>
</task>

</tasks>

<verification>
- .github/workflows/release.yml is valid YAML
- workflow_dispatch trigger with version input present
- Build matrix covers all 5 targets (x86_64-linux, aarch64-linux, x86_64-macos, aarch64-macos, x86_64-windows)
- Jobs have correct dependency chain: validate -> build -> release -> npm-publish (parallel with homebrew-update)
- softprops/action-gh-release@v2 used (not archived actions)
- npm publish includes all 6 packages (main + 5 platforms)
- SHA256 computation present for Homebrew formula update
</verification>

<success_criteria>
- Complete release pipeline in single workflow file
- Manual dispatch prevents accidental releases
- Version validation catches format errors before builds
- All 5 binary targets built from single Ubuntu runner
- GitHub release, npm publish, and Homebrew update all automated
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-ci-cd-release-pipeline-documentation/05.1-04-SUMMARY.md`
</output>
