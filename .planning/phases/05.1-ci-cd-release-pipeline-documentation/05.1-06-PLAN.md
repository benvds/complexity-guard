---
phase: 05.1-ci-cd-release-pipeline-documentation
plan: 06
type: execute
wave: 2
depends_on: ["05.1-05"]
files_modified:
  - docs/releasing.md
  - publication/homebrew/complexity-guard.rb
  - README.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Developer understands the distinction between release (local version bump + tag) and publish (CI distribution)"
    - "Developer can follow step-by-step instructions to create a release"
    - "Developer understands how Homebrew SHA256 placeholders get replaced during CI"
    - "Developer knows the complete release cycle from start to finish"
    - "Developer can troubleshoot common release failures"
  artifacts:
    - path: "docs/releasing.md"
      provides: "Comprehensive release process documentation"
      min_lines: 150
      contains: "release vs publish"
    - path: "publication/homebrew/complexity-guard.rb"
      provides: "Homebrew formula with inline SHA256 mechanism comments"
      contains: "PLACEHOLDER_SHA256"
    - path: "README.md"
      provides: "Updated README linking to release docs"
      contains: "releasing.md"
  key_links:
    - from: "README.md"
      to: "docs/releasing.md"
      via: "Documentation section link"
      pattern: "releasing.md"
    - from: "docs/releasing.md"
      to: "scripts/release.sh"
      via: "Usage examples referencing script"
      pattern: "scripts/release.sh"
    - from: "docs/releasing.md"
      to: ".github/workflows/release.yml"
      via: "Explanation of CI pipeline steps"
      pattern: "release.yml"
---

<objective>
Create comprehensive release process documentation (docs/releasing.md) covering the full release lifecycle, and add inline comments to the Homebrew formula explaining the SHA256 mechanism.

Purpose: Close UAT gaps 1, 3, and 4 -- the release script needs documented usage examples (Gap 1), the Homebrew SHA256 update process needs explanation (Gap 3), and the whole release cycle needs end-to-end documentation (Gap 4).
Output: docs/releasing.md with full release narrative, updated Homebrew formula with explanatory comments, README link to releasing docs.
</objective>

<execution_context>
@/Users/benvds/.claude/get-shit-done/workflows/execute-plan.md
@/Users/benvds/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.1-ci-cd-release-pipeline-documentation/05.1-05-SUMMARY.md
@scripts/release.sh
@.github/workflows/release.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive docs/releasing.md</name>
  <files>docs/releasing.md</files>
  <action>
    Create `docs/releasing.md` with the following structure. Use the same friendly, thorough tone as the existing docs (TanStack/Astro style per user decision from Phase 05.1-03). Document paths as they exist AFTER Plan 05 (publication/ structure).

    **Structure:**

    ## Release Process

    Brief intro: ComplexityGuard uses a two-step release process -- a local **release** step (version bump + tag) followed by automated **publish** (CI builds and distributes).

    ### Overview (ASCII flow diagram)

    Show the complete flow:
    ```
    Local: release.sh -> bump version -> commit -> tag -> push
                                                          |
    CI:                                             tag push triggers
                                                          |
                                                      validate
                                                          |
                                                        build (5 targets)
                                                          |
                                                       release (GitHub)
                                                        /       \
                                              npm-publish    homebrew-update
    ```

    ### Concepts: Release vs Publish

    Explain clearly:
    - **Release** = local action: bumps version in source files, creates a git commit and tag, pushes to origin. Uses `scripts/release.sh`. This is what YOU do.
    - **Publish** = automated CI action: triggered by the tag push, builds binaries for all platforms, creates GitHub release, publishes to npm, updates Homebrew formula. This is what GitHub Actions does automatically.

    ### Step-by-Step: Creating a Release

    1. Ensure you're on `main` with clean working tree
    2. Run `./scripts/release.sh [major|minor|patch]` (defaults to patch)
    3. Script reads current version from `src/main.zig`
    4. Script computes new version based on bump type
    5. Script updates version in: `src/main.zig`, `publication/npm/package.json`, `publication/npm/packages/*/package.json`
    6. Script creates commit: `chore: release vX.Y.Z`
    7. Script creates annotated tag: `vX.Y.Z`
    8. Script asks for confirmation before pushing
    9. Push triggers the release workflow

    Include concrete examples:
    ```sh
    # Patch release (0.1.0 -> 0.1.1)
    ./scripts/release.sh patch

    # Minor release (0.1.1 -> 0.2.0)
    ./scripts/release.sh minor

    # Major release (0.2.0 -> 1.0.0)
    ./scripts/release.sh major
    ```

    ### What Happens After Push (CI Pipeline)

    Explain each of the 5 CI jobs in order:

    1. **validate** -- Extracts version from tag name, validates semver format, checks for duplicate tags
    2. **build** -- Cross-compiles Zig binary for 5 targets (x86_64-linux, aarch64-linux, x86_64-macos, aarch64-macos, x86_64-windows) on a single Ubuntu runner. Creates tar.gz (Unix) or zip (Windows) archives. Uploads as GitHub Actions artifacts.
    3. **release** -- Downloads all build artifacts, creates GitHub release with softprops/action-gh-release, attaches all binary archives. Auto-generates release notes from commits.
    4. **npm-publish** -- Extracts binaries into platform package directories, updates version in all 6 package.json files, publishes 5 platform packages then main package to npm.
    5. **homebrew-update** -- Computes SHA256 checksums for all 4 Unix archives, replaces PLACEHOLDER_SHA256_* values in the Homebrew formula template. Outputs updated formula (manual step to push to tap).

    ### How Homebrew SHA256 Works

    Explain the mechanism in detail:
    - The Homebrew formula (`publication/homebrew/complexity-guard.rb`) contains 4 placeholder strings: `PLACEHOLDER_SHA256_AARCH64_MACOS`, `PLACEHOLDER_SHA256_X86_64_MACOS`, `PLACEHOLDER_SHA256_AARCH64_LINUX`, `PLACEHOLDER_SHA256_X86_64_LINUX`
    - During the `homebrew-update` CI job, the workflow downloads the actual binary archives, computes their SHA256 checksums using `shasum -a 256`, and replaces the placeholders with real values using `sed`
    - The formula version is also updated from the tag
    - After the workflow runs, the updated formula needs to be manually copied to the Homebrew tap repository (future enhancement: automate with PAT)
    - The placeholder naming convention matches the Zig cross-compilation target names for consistency

    ### Version Files

    Document which files contain version numbers and how they stay in sync:
    - `src/main.zig`: Source of truth (read by release.sh)
    - `publication/npm/package.json`: Updated by release.sh locally and release.yml in CI
    - `publication/npm/packages/*/package.json`: Updated by release.sh locally and release.yml in CI
    - `CHANGELOG.md`: Updated manually before release (add entries under [Unreleased])

    ### Pre-Release Checklist

    - [ ] All tests pass (`zig build test`)
    - [ ] CHANGELOG.md updated with new entries under [Unreleased]
    - [ ] On `main` branch with clean working tree
    - [ ] No pending PRs that should be included

    ### Post-Release Checklist

    - [ ] GitHub Actions release workflow completed successfully
    - [ ] GitHub release page shows all 5 binary archives
    - [ ] npm packages published (check `npm view complexity-guard versions`)
    - [ ] Copy updated Homebrew formula to tap repository (until automated)

    ### Troubleshooting

    Common issues:
    - **"Tag already exists"**: The version was already released. Bump to next version.
    - **Build failure on one target**: Check Zig cross-compilation logs. Usually a target-specific issue.
    - **npm publish fails**: Verify NPM_TOKEN secret is set in GitHub repository settings. Check token hasn't expired.
    - **SHA256 mismatch**: Don't manually edit the Homebrew formula SHA256 values -- they're computed from actual builds.
    - **Rollback a release**: Delete the GitHub release and tag (`git tag -d vX.Y.Z && git push origin :refs/tags/vX.Y.Z`). Note: npm packages cannot be unpublished after 72 hours.

    ### Manual/Alternative Workflows

    - **Manual dispatch**: Can also trigger release workflow from GitHub Actions UI (Actions > Release > Run workflow) for cases where tag push didn't trigger
    - **Local npm publish**: `./scripts/publish.sh` for publishing from your machine (requires .env with NPM_TOKEN). See .env.example.
    - **Dry run publish**: `./scripts/publish.sh --dry-run` to verify without actually publishing
  </action>
  <verify>
    - `test -f docs/releasing.md` exits 0
    - `wc -l docs/releasing.md` shows 150+ lines
    - `grep -c 'release.sh' docs/releasing.md` returns 5+ (script referenced throughout)
    - `grep -c 'PLACEHOLDER_SHA256' docs/releasing.md` returns 2+ (SHA256 mechanism documented)
    - `grep 'release.*vs.*publish\|Release.*Publish\|release.*publish' docs/releasing.md` finds the distinction
    - `grep 'Troubleshooting' docs/releasing.md` finds troubleshooting section
    - `grep 'publication/' docs/releasing.md` confirms new paths used (not old root paths)
  </verify>
  <done>docs/releasing.md exists with 150+ lines covering: release vs publish distinction, step-by-step guide, CI pipeline explanation, Homebrew SHA256 mechanism, version file locations, pre/post-release checklists, and troubleshooting.</done>
</task>

<task type="auto">
  <name>Task 2: Add inline SHA256 comments to Homebrew formula and link releasing docs from README</name>
  <files>
    publication/homebrew/complexity-guard.rb
    README.md
  </files>
  <action>
    **Homebrew formula (`publication/homebrew/complexity-guard.rb`):**

    Add inline comments explaining the SHA256 placeholder mechanism. The comment at the top should be expanded from the current single line to explain:
    - This is a template file, not a production formula
    - The PLACEHOLDER_SHA256_* values are replaced by the `homebrew-update` job in `.github/workflows/release.yml`
    - Placeholder names match Zig cross-compilation target names (AARCH64_MACOS, X86_64_MACOS, etc.)
    - After release workflow runs, copy this file to your Homebrew tap repository
    - See docs/releasing.md for the full process

    Add a brief comment before each `sha256` line explaining which placeholder corresponds to which platform:
    ```ruby
    # SHA256 computed by CI from complexity-guard-aarch64-macos.tar.gz
    sha256 "PLACEHOLDER_SHA256_AARCH64_MACOS"
    ```

    **README.md:**

    Add "Releasing" link to the Documentation section (after the Examples link):
    ```markdown
    - **[Releasing](docs/releasing.md)** -- Release process, publishing, version management
    ```

    Also update the docs/getting-started.md and docs/cli-reference.md links if they mention npm installation paths that changed. Check README for any references to `package.json`, `bin/`, `npm/`, or `homebrew/` at root level and update to `publication/` paths if present. (The current README does not reference these internal paths, so likely only the Documentation section link needs adding.)
  </action>
  <verify>
    - `grep 'releasing.md' README.md` finds the new documentation link
    - `grep 'homebrew-update' publication/homebrew/complexity-guard.rb` finds CI job reference in comments
    - `grep 'docs/releasing.md' publication/homebrew/complexity-guard.rb` finds docs reference in comments
    - `grep -c '#' publication/homebrew/complexity-guard.rb` returns 8+ (expanded comments)
  </verify>
  <done>Homebrew formula has inline comments explaining SHA256 placeholder mechanism and pointing to docs/releasing.md. README Documentation section includes link to releasing guide.</done>
</task>

</tasks>

<verification>
1. `docs/releasing.md` covers all 4 UAT gaps:
   - Gap 1 (Test 2): Release script usage with examples -- `grep 'release.sh' docs/releasing.md`
   - Gap 3 (Test 5): Homebrew SHA256 mechanism -- `grep 'PLACEHOLDER_SHA256' docs/releasing.md`
   - Gap 4 (Test 10): End-to-end release cycle -- `grep 'Troubleshooting\|Checklist\|Step-by-Step' docs/releasing.md`
2. `publication/homebrew/complexity-guard.rb` has explanatory comments for SHA256 mechanism (Gap 3)
3. `README.md` links to releasing docs (discoverable)
4. All paths in docs reference `publication/` structure (consistent with Plan 05 changes)
</verification>

<success_criteria>
- docs/releasing.md exists with 150+ lines of comprehensive release documentation
- Document clearly explains release (local) vs publish (CI) distinction
- Document includes step-by-step guide, CI pipeline explanation, SHA256 mechanism, troubleshooting
- Homebrew formula has inline comments explaining placeholder mechanism
- README links to releasing docs in Documentation section
- All documented paths use publication/ structure (post-Plan 05)
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-ci-cd-release-pipeline-documentation/05.1-06-SUMMARY.md`
</output>
