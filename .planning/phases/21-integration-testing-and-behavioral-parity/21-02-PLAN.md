---
phase: 21-integration-testing-and-behavioral-parity
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - rust/src/output/console.rs
  - rust/src/metrics/mod.rs
  - rust/src/parser/mod.rs
  - README.md
  - docs/cli-reference.md
  - docs/examples.md
  - publication/npm/README.md
autonomous: true
requirements:
  - PARSE-05
  - OUT-01

must_haves:
  truths:
    - "Console output uses consolidated per-function format matching Zig (one line per function with worst severity, not per-metric violation lines)"
    - "Function naming for naming-edge-cases.ts produces descriptive names like 'map callback', 'forEach callback', 'click handler', 'default export' instead of '<anonymous>'"
  artifacts:
    - path: "rust/src/output/console.rs"
      provides: "Zig-parity consolidated per-function console format"
      contains: "worstStatusAll"
    - path: "rust/src/metrics/mod.rs"
      provides: "Enhanced function name extraction for callback and export patterns"
      contains: "callback"
  key_links:
    - from: "rust/src/output/console.rs"
      to: "rust/src/main.rs"
      via: "render_console called from main for console format output"
      pattern: "render_console"
    - from: "rust/src/metrics/mod.rs"
      to: "rust/src/metrics/cognitive.rs"
      via: "cognitive.rs calls extract_function_name from mod.rs"
      pattern: "extract_function_name"
---

<objective>
Rewrite console output to match Zig consolidated per-function format and fix function naming for callback/export patterns.

Purpose: OUT-01 requires console output to match the Zig ESLint-style format. Currently Rust uses per-metric individual violation lines while Zig consolidates all metrics into a single line per function with the worst severity. PARSE-05 requires function name extraction to produce descriptive names for callbacks and exports.

Output: Console output is visually identical to Zig for the same input. Function names match Zig for naming-edge-cases.ts patterns.
</objective>

<execution_context>
@/Users/benvds/.claude/get-shit-done/workflows/execute-plan.md
@/Users/benvds/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-integration-testing-and-behavioral-parity/21-RESEARCH.md
@rust/src/output/console.rs
@rust/src/metrics/mod.rs
@rust/src/parser/mod.rs
@src/output/console.zig
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite console renderer to Zig consolidated per-function format</name>
  <files>
    rust/src/output/console.rs
  </files>
  <action>
Rewrite `render_console()` in `rust/src/output/console.rs` to match the Zig `formatFileResults()` consolidated format. The key differences:

**Zig format (target):**
```
path/to/file.ts
  5:7  ✗  error  Function 'processData' cyclomatic 11 cognitive 35 [halstead vol 299] [depth 7]

Analyzed 1 files, 3 functions
Health: 34
Found 0 warnings, 1 errors

Top cyclomatic hotspots:
  1. processData (...) complexity 11
...
✗ 1 problems (1 error, 0 warnings)
```

**Key changes from current Rust format:**

1. **Per-function line consolidation**: Instead of one line per metric violation, emit ONE line per function showing the worst severity across all metrics. Format: `  {line}:{col}  {symbol}  {severity}  Function '{name}' cyclomatic {N} cognitive {N} [halstead vol {N}] [depth {N}]`

2. **Severity symbols**: Use `✓` for ok, `⚠` for warning, `✗` for error (Unicode, not text-only)

3. **Worst severity per function**: Compute worst status across ALL metrics for each function (not individual per-metric violations). A function with cyclomatic=warning and cognitive=error shows as "error".

4. **Metric values inline**: Show cyclomatic and cognitive values always. Show halstead volume in brackets `[halstead vol N]` only if the function has halstead violations or verbose mode. Show structural info `[depth N]` `[length N]` `[params N]` only if violations or verbose.

5. **Summary section**: After all files, show:
   - `Analyzed {N} files, {M} functions`
   - `Health: {score}` (integer, not float with .1 decimal)
   - `Found {W} warnings, {E} errors`
   - (Optional) Top cyclomatic/cognitive hotspots section
   - Final line: `✗ {total} problems ({E} errors, {W} warnings)` or `✓ No problems found`

6. **Verbosity**: default mode shows only functions with violations; verbose shows all functions; quiet shows only errors.

7. **Keep `function_violations()` and `Severity` enum exported** — they are used by json_output.rs, sarif_output.rs, and main.rs for exit code counting. The console format change is purely in `render_console()`.

8. **Keep color support** via `should_use_color()` and owo-colors. Apply color to symbols and severity labels.

9. **Duplication section**: When duplication data is present (the `_duplication` parameter currently ignored), add a duplication summary section after the function results. For now, keep it simple — show `Duplication: {pct:.1}%` if present.

Update all existing console tests to assert the new consolidated format. Key assertions:
- Single line per function (not multiple lines per metric)
- Symbols ✓/⚠/✗ present
- Summary line format matches
  </action>
  <verify>
    <automated>cd /Users/benvds/code/complexity-guard/rust && cargo test --lib -- console --test-threads=1</automated>
    <manual>Run binary on a fixture file and visually compare output format to Zig binary</manual>
  </verify>
  <done>Console output uses one line per function with worst severity, symbols ✓/⚠/✗, inline metric values, and summary section matching Zig format; all console tests updated and passing</done>
</task>

<task type="auto">
  <name>Task 2: Fix function name extraction for callback and export patterns</name>
  <files>
    rust/src/metrics/mod.rs
    rust/src/parser/mod.rs
  </files>
  <action>
The naming-edge-cases.ts fixture has patterns where Zig extracts descriptive names but Rust returns `<anonymous>`:

1. **Array method callbacks**: `arr.map(x => ...)` → Zig: "map callback", Rust: "&lt;anonymous&gt;"
2. **forEach callbacks**: `arr.forEach(item => ...)` → Zig: "forEach callback", Rust: "&lt;anonymous&gt;"
3. **Event handler callbacks**: `button.addEventListener('click', () => ...)` → Zig: "click handler", Rust: "&lt;anonymous&gt;"
4. **Default exports**: `export default function() {}` → Zig: "default export", Rust: "&lt;anonymous&gt;"
5. **Object literal methods**: `const obj = { process() {} }` → Zig: "process" or "obj.process", Rust: "obj"

Fix `extract_function_name()` in `rust/src/metrics/mod.rs` (the shared function name extraction used by all metric modules):

**For callback patterns** (arrow function as argument to a method call):
- When an arrow_function has a parent of `arguments` and a grandparent of `call_expression`:
  - Check if the call_expression's callee is a `member_expression` with a method name
  - For array methods (map, filter, forEach, reduce, find, some, every, flatMap): name = "{method} callback"
  - For addEventListener with a string literal first arg: name = "{event_name} handler"
  - For .then/.catch on promises: name = "{method} callback"

**For default export**:
- When a function_declaration or arrow_function has no name and parent is `export_statement` with `default` keyword: name = "default export"

**For object literal methods**:
- When a `method_definition` is inside a `pair` or object literal, extract the property key name

Update or add unit tests in mod.rs to verify these naming patterns. If the naming-edge-cases fixture exists and is accessible from Rust tests, add a fixture-based test.

Also check `rust/src/parser/mod.rs` — the `extract_functions()` traversal may need similar updates for the `FunctionInfo.name` field. The parser extracts function names for ParseResult while metrics/mod.rs extracts for metric results. Both should produce consistent names. Focus on the metrics extraction since that's what appears in output.
  </action>
  <verify>
    <automated>cd /Users/benvds/code/complexity-guard/rust && cargo test --lib -- extract_function_name --test-threads=1</automated>
    <manual>Run binary on tests/fixtures/naming-edge-cases.ts and verify function names in output match Zig</manual>
  </verify>
  <done>Function naming for callback patterns produces "map callback", "forEach callback", "click handler", "default export" etc.; naming-edge-cases fixture produces matching names to Zig output</done>
</task>

<task type="auto">
  <name>Task 3: Update documentation to reflect new console output format</name>
  <files>
    README.md
    docs/cli-reference.md
    docs/examples.md
    publication/npm/README.md
  </files>
  <action>
The console output format is changing from per-metric violation lines to a consolidated per-function format (one line per function with worst severity). Update all documentation that shows or describes console output:

1. **README.md**: Update any example console output snippets to show the new consolidated format. Replace per-metric violation lines with single per-function lines using `✓`/`⚠`/`✗` symbols and inline metric values. Update the summary format to show "Analyzed N files, M functions" / "Found W warnings, E errors" / "✗ N problems (E errors, W warnings)".

2. **docs/cli-reference.md**: Update the output format section describing what console output looks like. Document the per-function consolidated format, severity symbols, and summary section structure.

3. **docs/examples.md**: Update any example output blocks showing console format to reflect the new consolidated style.

4. **publication/npm/README.md**: Sync any console output examples with the new format. Keep in sync with the main README.md changes.

5. **publication/npm/packages/*/README.md**: Check if these contain console output examples. If they only reference the main package README, no changes needed. If they have inline output examples, update them.

For all files: only update the sections that show or describe console output format. Do not change unrelated sections.
  </action>
  <verify>
    <automated>grep -rn "per-metric\|per metric\|individual violation" README.md docs/cli-reference.md docs/examples.md publication/npm/README.md; test $? -eq 1</automated>
    <manual>Visually confirm that all console output examples in docs show the new consolidated per-function format with ✓/⚠/✗ symbols</manual>
  </verify>
  <done>All documentation files show the new consolidated per-function console output format; no stale per-metric violation line examples remain; publication README is in sync with main README</done>
</task>

</tasks>

<verification>
1. `cd /Users/benvds/code/complexity-guard/rust && cargo test` — all unit tests pass
2. `cd /Users/benvds/code/complexity-guard/rust && cargo build --release` — binary builds
3. Run: `./rust/target/release/complexity-guard tests/fixtures/typescript/complex_nested.ts` — verify consolidated per-function format (single line per function with ✗ symbol)
4. Run: `./rust/target/release/complexity-guard tests/fixtures/naming-edge-cases.ts` — verify descriptive function names
</verification>

<success_criteria>
- Console output shows one line per function with worst severity symbol
- Summary section shows "Analyzed N files, M functions" and "Found W warnings, E errors"
- Function names for callbacks show "map callback", "forEach callback", etc.
- Default exports show "default export"
- All existing tests updated and passing
</success_criteria>

<output>
After completion, create `.planning/phases/21-integration-testing-and-behavioral-parity/21-02-SUMMARY.md`
</output>
