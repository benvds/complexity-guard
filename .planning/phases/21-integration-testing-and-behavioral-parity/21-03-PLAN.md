---
phase: 21-integration-testing-and-behavioral-parity
plan: 03
type: execute
wave: 2
depends_on:
  - 21-01
  - 21-02
files_modified:
  - rust/Cargo.toml
  - rust/tests/integration_tests.rs
  - rust/tests/fixtures/baselines/simple_function.json
  - rust/tests/fixtures/baselines/cognitive_cases.json
  - rust/tests/fixtures/baselines/cyclomatic_cases.json
  - rust/tests/fixtures/baselines/halstead_cases.json
  - rust/tests/fixtures/baselines/structural_cases.json
  - rust/tests/fixtures/baselines/async_patterns.json
  - rust/tests/fixtures/baselines/class_with_methods.json
  - rust/tests/fixtures/baselines/complex_nested.json
  - rust/tests/fixtures/baselines/react_component.json
  - rust/tests/fixtures/baselines/express_middleware.json
  - rust/tests/fixtures/baselines/jsx_component.json
  - rust/tests/fixtures/baselines/callback_patterns.json
autonomous: true
requirements:
  - PARSE-01
  - PARSE-02
  - PARSE-03
  - PARSE-04
  - METR-01
  - METR-04
  - CLI-01
  - CLI-02
  - CLI-03
  - OUT-03
  - OUT-04
  - OUT-05
  - PIPE-01
  - PIPE-02
  - PIPE-03

must_haves:
  truths:
    - "Integration tests run the Rust binary against all fixture files and compare JSON output to committed baselines — all tests pass"
    - "Exit code parity confirmed for codes 0, 1, 2, and 3"
    - "Float tolerance explicitly defined as constants (1e-9 for Halstead, 1e-6 for health scores)"
    - "Deterministic output ordering verified across multiple runs"
    - "SARIF output contains required structural fields (tool.driver, results[].ruleId, results[].level, results[].locations)"
    - "HTML output is self-contained with no external URL references"
  artifacts:
    - path: "rust/tests/integration_tests.rs"
      provides: "End-to-end binary integration tests covering all requirements"
      min_lines: 200
    - path: "rust/tests/fixtures/baselines/"
      provides: "Committed Zig v1.0 baseline JSON files for comparison"
    - path: "rust/Cargo.toml"
      provides: "assert_cmd and predicates dev-dependencies"
      contains: "assert_cmd"
  key_links:
    - from: "rust/tests/integration_tests.rs"
      to: "rust/tests/fixtures/baselines/"
      via: "load_baseline() reads JSON files for comparison"
      pattern: "load_baseline"
    - from: "rust/tests/integration_tests.rs"
      to: "complexity-guard binary"
      via: "Command::cargo_bin() runs the binary"
      pattern: "cargo_bin"
---

<objective>
Record Zig v1.0 baselines and write comprehensive integration tests validating behavioral parity across all fixtures, output formats, exit codes, and pipeline behavior.

Purpose: This is the validation core of Phase 21. After Plans 01 and 02 fix the confirmed bugs, this plan records correct baselines from the Rust binary (since bugs are fixed, values now match Zig) and writes integration tests that exercise every requirement from PARSE-01 through PIPE-03. These tests catch any regression before Phase 22 release work.

Output: A comprehensive integration test suite in `rust/tests/integration_tests.rs` with committed baseline files and all tests passing.
</objective>

<execution_context>
@/Users/benvds/.claude/get-shit-done/workflows/execute-plan.md
@/Users/benvds/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-integration-testing-and-behavioral-parity/21-RESEARCH.md
@.planning/phases/21-integration-testing-and-behavioral-parity/21-01-SUMMARY.md
@.planning/phases/21-integration-testing-and-behavioral-parity/21-02-SUMMARY.md
@rust/Cargo.toml
@rust/tests/parser_tests.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add test dependencies and record baselines from Rust binary</name>
  <files>
    rust/Cargo.toml
    rust/tests/fixtures/baselines/simple_function.json
    rust/tests/fixtures/baselines/cognitive_cases.json
    rust/tests/fixtures/baselines/cyclomatic_cases.json
    rust/tests/fixtures/baselines/halstead_cases.json
    rust/tests/fixtures/baselines/structural_cases.json
    rust/tests/fixtures/baselines/async_patterns.json
    rust/tests/fixtures/baselines/class_with_methods.json
    rust/tests/fixtures/baselines/complex_nested.json
    rust/tests/fixtures/baselines/react_component.json
    rust/tests/fixtures/baselines/express_middleware.json
    rust/tests/fixtures/baselines/jsx_component.json
    rust/tests/fixtures/baselines/callback_patterns.json
  </files>
  <action>
1. Add dev-dependencies to `rust/Cargo.toml`:
```toml
[dev-dependencies]
tempfile = "3"
assert_cmd = "2"
predicates = "3"
```

2. Build the Rust binary in release mode: `cd rust && cargo build --release`

3. Create `rust/tests/fixtures/baselines/` directory.

4. Record baseline JSON output from the Rust binary (with bugs fixed by Plan 01) for each fixture file. Run the binary with `--format json --no-color` for each:

**TypeScript fixtures** (in `tests/fixtures/typescript/`):
- simple_function.ts → baselines/simple_function.json
- cognitive_cases.ts → baselines/cognitive_cases.json
- cyclomatic_cases.ts → baselines/cyclomatic_cases.json
- halstead_cases.ts → baselines/halstead_cases.json
- structural_cases.ts → baselines/structural_cases.json
- async_patterns.ts → baselines/async_patterns.json
- class_with_methods.ts → baselines/class_with_methods.json
- complex_nested.ts → baselines/complex_nested.json
- react_component.tsx → baselines/react_component.json

**JavaScript fixtures** (in `tests/fixtures/javascript/`):
- express_middleware.js → baselines/express_middleware.json
- jsx_component.jsx → baselines/jsx_component.json
- callback_patterns.js → baselines/callback_patterns.json

For each baseline, strip the `timestamp` and `metadata.elapsed_ms` fields (they change between runs). Use `jq` or manual editing:
```bash
./target/release/complexity-guard --format json --no-color ../tests/fixtures/typescript/simple_function.ts | jq 'del(.timestamp, .metadata.elapsed_ms)' > tests/fixtures/baselines/simple_function.json
```

If `jq` is not available, record the full output and note that the integration tests must skip timestamp and elapsed_ms comparison.

5. Verify baselines are valid JSON: `for f in tests/fixtures/baselines/*.json; do jq . "$f" > /dev/null && echo "OK: $f"; done`
  </action>
  <verify>
    <automated>cd /Users/benvds/code/complexity-guard/rust && cargo build --release && ls tests/fixtures/baselines/*.json | wc -l</automated>
    <manual>Verify at least 12 baseline JSON files exist and are valid JSON</manual>
  </verify>
  <done>assert_cmd and predicates added to dev-dependencies; 12 baseline JSON files recorded and committed in rust/tests/fixtures/baselines/</done>
</task>

<task type="auto">
  <name>Task 2: Write integration test suite covering all requirements</name>
  <files>
    rust/tests/integration_tests.rs
  </files>
  <action>
Create `rust/tests/integration_tests.rs` with comprehensive integration tests. Use `assert_cmd::Command::cargo_bin("complexity-guard")` for binary invocation.

**Helper functions:**

```rust
use assert_cmd::Command;
use serde_json::Value;

const HALSTEAD_TOL: f64 = 1e-9;
const SCORE_TOL: f64 = 1e-6;

fn cargo_bin() -> Command {
    Command::cargo_bin("complexity-guard").unwrap()
}

fn fixture_path(relative: &str) -> std::path::PathBuf {
    std::path::Path::new(env!("CARGO_MANIFEST_DIR"))
        .join("..")
        .join("tests")
        .join("fixtures")
        .join(relative)
}

fn baseline_path(name: &str) -> std::path::PathBuf {
    std::path::Path::new(env!("CARGO_MANIFEST_DIR"))
        .join("tests")
        .join("fixtures")
        .join("baselines")
        .join(name)
}

fn load_baseline(name: &str) -> Value {
    let content = std::fs::read_to_string(baseline_path(name)).unwrap();
    serde_json::from_str(&content).unwrap()
}

fn run_json(fixture: &str) -> Value {
    let output = cargo_bin()
        .args(["--format", "json", "--no-color"])
        .arg(fixture_path(fixture))
        .output()
        .unwrap();
    let stdout = String::from_utf8(output.stdout).unwrap();
    serde_json::from_str(&stdout).unwrap()
}

fn assert_float_eq(actual: f64, expected: f64, tol: f64, context: &str) {
    assert!(
        (actual - expected).abs() <= tol,
        "{}: actual={} expected={} diff={} tol={}",
        context, actual, expected, (actual - expected).abs(), tol
    );
}
```

**Test categories (one or more #[test] functions per category):**

**1. Per-fixture JSON baseline comparison (PARSE-01 through PARSE-05, METR-01 through METR-04, METR-06):**
For each of the 12 fixtures, write a test that:
- Runs the binary with `--format json --no-color`
- Parses JSON output
- Loads corresponding baseline
- Compares `summary.files_analyzed`, `summary.total_functions`
- For each function in `files[0].functions`: compare `name`, `start_line`, `start_col`, `cyclomatic` (exact), `cognitive` (exact), `nesting_depth` (exact), `line_count` (exact), `params_count` (exact)
- Compare float fields with tolerance: `halstead_volume`, `halstead_difficulty`, `halstead_effort`, `halstead_bugs` (HALSTEAD_TOL), `health_score` (SCORE_TOL)
- Compare `status` (ok/warning/error)
- Skip `timestamp` and `metadata.elapsed_ms` comparison
- Allow `version` field to differ (Rust is 0.8.0, baseline may record whatever)

Use a helper function `compare_fixture(fixture_relative: &str, baseline_name: &str)` to avoid code duplication across 12 tests.

**2. Exit code parity (OUT-05):**
- `test_exit_code_0_clean`: simple_function.ts → exit 0
- `test_exit_code_1_errors`: complex_nested.ts → exit 1
- `test_exit_code_2_warnings_fail_on_warning`: cognitive_cases.ts with `--fail-on warning` → exit 2
- `test_exit_code_3_bad_config`: `--config /nonexistent/path.json` → exit 3
- Document that exit 4 is not testable (tree-sitter is error-tolerant)

**3. CLI flags (CLI-01, CLI-02, CLI-03):**
- `test_format_json_flag`: `--format json` produces valid JSON
- `test_format_sarif_flag`: `--format sarif` produces valid JSON with `$schema` field
- `test_format_html_flag`: `--format html` produces HTML string
- `test_config_file_loading`: Create temp dir with `.complexityguard.json` setting `analysis.thresholds.cyclomatic.warning: 5`, run binary, verify the lower threshold takes effect
- `test_cli_overrides_config`: Create config with format=json, pass --format sarif on CLI, verify SARIF output

**4. SARIF structure (OUT-03):**
- `test_sarif_structure`: Run with `--format sarif`, parse JSON, verify:
  - `$schema` contains "sarif"
  - `version` is "2.1.0"
  - `runs[0].tool.driver.name` is "complexity-guard"
  - `runs[0].results` is an array
  - Each result has `ruleId`, `level`, `message.text`, `locations[0].physicalLocation`

**5. HTML self-contained (OUT-04):**
- `test_html_no_external_urls`: Run with `--format html`, check output does not contain `http://` or `https://` (except in data attributes or comments)

**6. Pipeline (PIPE-01, PIPE-02, PIPE-03):**
- `test_directory_scan`: Run on `tests/fixtures/typescript/` directory, verify multiple files in JSON output
- `test_deterministic_ordering`: Run same directory twice, compare file ordering in JSON output — must be identical
- `test_threads_flag`: Run with `--threads 1`, verify it completes and produces same results as default

**7. Cognitive deviation pinning (METR-02):**
- `test_cognitive_async_patterns`: Run on async_patterns.ts, verify fetchUserData cognitive=15 specifically

**8. Duplication (METR-05):**
- `test_duplication_flag`: Run with `--duplication` on a directory with duplication_cases fixtures, verify `duplication` field is not null in JSON and has `enabled: true`
- `test_no_duplication_default`: Run without `--duplication`, verify `duplication` is null

Total: approximately 20-25 test functions.
  </action>
  <verify>
    <automated>cd /Users/benvds/code/complexity-guard/rust && cargo test --test integration_tests -- --test-threads=4</automated>
    <manual>All integration tests pass; test count is 20+</manual>
  </verify>
  <done>rust/tests/integration_tests.rs exists with 20+ tests covering all requirement categories; all tests pass with `cargo test --test integration_tests`</done>
</task>

</tasks>

<verification>
1. `cd /Users/benvds/code/complexity-guard/rust && cargo test` — ALL tests pass (unit + integration)
2. `cd /Users/benvds/code/complexity-guard/rust && cargo test --test integration_tests -- --test-threads=4` — integration tests complete in under 30 seconds
3. Verify test count: `cargo test --test integration_tests -- --list 2>&1 | grep "test " | wc -l` shows 20+ tests
4. Verify baseline files: `ls rust/tests/fixtures/baselines/*.json | wc -l` shows 12 files
</verification>

<success_criteria>
- 12 baseline JSON files committed in rust/tests/fixtures/baselines/
- assert_cmd and predicates in dev-dependencies
- 20+ integration tests passing
- Exit codes 0, 1, 2, 3 all tested
- SARIF structural validation passing
- HTML self-contained check passing
- Directory scan and deterministic ordering tested
- Float tolerances explicitly documented as constants
- All `cargo test` passes (unit + integration)
</success_criteria>

<output>
After completion, create `.planning/phases/21-integration-testing-and-behavioral-parity/21-03-SUMMARY.md`
</output>
