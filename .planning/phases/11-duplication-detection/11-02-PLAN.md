---
phase: 11-duplication-detection
plan: 02
type: execute
wave: 2
depends_on:
  - "11-01"
files_modified:
  - src/cli/args.zig
  - src/cli/config.zig
  - src/cli/merge.zig
  - src/cli/help.zig
  - src/main.zig
  - src/pipeline/parallel.zig
  - src/metrics/scoring.zig
autonomous: true
requirements:
  - DUP-06
  - DUP-07

must_haves:
  truths:
    - "User can enable duplication detection via --duplication CLI flag"
    - "User can enable duplication detection via --metrics duplication"
    - "User can enable duplication detection via config file duplication_enabled field"
    - "When duplication is not enabled, zero overhead — no duplication code path runs"
    - "Duplication results include per-file duplication percentages with warning/error status"
    - "Duplication results include project-level duplication percentage with threshold status"
    - "Configurable thresholds for file-level (default 15%/25%) and project-level (default 5%/10%) duplication"
    - "Health score integrates duplication when enabled (5-metric normalization with 0.20 weight)"
  artifacts:
    - path: "src/cli/args.zig"
      provides: "duplication: bool field in CliArgs"
      contains: "duplication"
    - path: "src/cli/config.zig"
      provides: "DuplicationThresholds struct and duplication_enabled field"
      contains: "DuplicationThresholds"
    - path: "src/main.zig"
      provides: "Duplication pass wired after parallel/sequential analysis"
      contains: "detectDuplication"
    - path: "src/metrics/scoring.zig"
      provides: "5-metric weight normalization when duplication enabled"
      contains: "duplication"
  key_links:
    - from: "src/main.zig"
      to: "src/metrics/duplication.zig"
      via: "detectDuplication call after file analysis"
      pattern: "duplication\\.detectDuplication"
    - from: "src/cli/merge.zig"
      to: "src/cli/config.zig"
      via: "merge --duplication flag into config"
      pattern: "duplication"
    - from: "src/metrics/scoring.zig"
      to: "duplication weight"
      via: "5-metric effective weights when duplication enabled"
      pattern: "duplication.*f64"
---

<objective>
Wire duplication detection into the CLI, configuration, analysis pipeline, and health score system.

Purpose: Users can opt into duplication analysis via `--duplication` flag, `--metrics duplication`, or config file (DUP-07 thresholds). The main.zig pipeline calls `detectDuplication` as a post-analysis step after all per-file metrics are computed. The health score system re-normalizes to 5 weights when duplication is enabled, using the duplication 0.20 weight from WeightsConfig. File and project duplication percentages are computed with configurable warning/error thresholds (DUP-06).

Output: CLI flags, config types, pipeline wiring, scoring integration, threshold application.
</objective>

<execution_context>
@/home/ben/.claude/get-shit-done/workflows/execute-plan.md
@/home/ben/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-duplication-detection/11-RESEARCH.md
@.planning/phases/11-duplication-detection/11-01-SUMMARY.md
@src/cli/args.zig (CliArgs struct, parseArgsFromSlice)
@src/cli/config.zig (Config, AnalysisConfig, ThresholdsConfig, WeightsConfig)
@src/cli/merge.zig (mergeArgsIntoConfig)
@src/main.zig (pipeline flow — sequential and parallel paths)
@src/metrics/scoring.zig (EffectiveWeights, resolveEffectiveWeights, computeFunctionScore)
@src/pipeline/parallel.zig (analyzeFilesParallel, FileAnalysisResult)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --duplication CLI flag, config types, merge logic, and help text</name>
  <files>src/cli/args.zig, src/cli/config.zig, src/cli/merge.zig, src/cli/help.zig</files>
  <action>
**args.zig:**
- Add `duplication: bool = false` field to `CliArgs` struct (alongside existing `no_duplication`)
- In `parseArgsFromSlice`, add parsing for `"--duplication"` flag: sets `cli_args.duplication = true`

**config.zig:**
- Add `DuplicationThresholds` struct:
  ```zig
  pub const DuplicationThresholds = struct {
      file_warning: ?f64 = null,   // default 15.0
      file_error: ?f64 = null,     // default 25.0
      project_warning: ?f64 = null, // default 5.0
      project_error: ?f64 = null,  // default 10.0
  };
  ```
- Add `duplication: ?DuplicationThresholds = null` field to `ThresholdsConfig`
- Add `duplication_enabled: ?bool = null` field to `AnalysisConfig`
- In `defaults()`, set `duplication_enabled = false` in AnalysisConfig
- In `deepCopyConfig`, copy the `duplication_enabled` field and `duplication` thresholds

**merge.zig:**
- In `mergeArgsIntoConfig`: if `cli_args.duplication` is true, set `cfg.analysis.duplication_enabled = true`
- Also check: if parsed_metrics contains "duplication", set `duplication_enabled = true`
  (Note: the `--metrics duplication` path is handled in main.zig where parsed_metrics is built — merge.zig only handles the --duplication flag. The main.zig code will check both paths.)

**help.zig:**
- Add `--duplication` to the help text in the Options section, after `--no-duplication`:
  `"  --duplication           Enable cross-file duplication detection (disabled by default)"`

Run `zig build test` to verify compilation and existing tests still pass.

Commit: `feat(11-02): add --duplication CLI flag, DuplicationThresholds config, and merge logic`
  </action>
  <verify>`zig build test` passes. `zig build run -- --help` shows --duplication flag. Parsing `--duplication` sets the field correctly (existing arg parser tests or manual verification).</verify>
  <done>--duplication flag parsed and merged into config. DuplicationThresholds struct exists. Config deepCopy propagates duplication fields. Help text updated.</done>
</task>

<task type="auto">
  <name>Task 2: Wire duplication pass into main.zig pipeline, update scoring for 5-weight mode, and apply thresholds</name>
  <files>src/main.zig, src/metrics/scoring.zig, src/pipeline/parallel.zig</files>
  <action>
**Determine duplication enabled:**
In main.zig, after parsed_metrics is built and config is merged, determine if duplication is enabled:
```zig
const duplication_enabled: bool = blk: {
    // Check --duplication flag (via config merge)
    if (cfg.analysis) |a| {
        if (a.duplication_enabled) |de| {
            if (de) break :blk true;
        }
    }
    // Check --metrics duplication
    if (parsed_metrics) |pm| {
        for (pm) |m| {
            if (std.mem.eql(u8, m, "duplication")) break :blk true;
        }
    }
    break :blk false;
};
```

**Import duplication module** in main.zig:
```zig
const duplication = @import("metrics/duplication.zig");
```

**Run duplication pass** (after the sequential/parallel analysis loop and sorting, but before project score computation):
```zig
var dup_result: ?duplication.DuplicationResult = null;
if (duplication_enabled) {
    // Build DuplicationConfig from ThresholdsConfig
    const dup_config = buildDuplicationConfig(cfg);

    // Re-parse and tokenize all files for duplication analysis
    // (trees were freed during per-file analysis)
    var file_tokens_list = std.ArrayList(duplication.FileTokens).empty;
    defer file_tokens_list.deinit(arena_allocator);

    for (discovery_result.files) |file_path| {
        // Re-parse each file to get tree for tokenization
        const source = std.fs.cwd().readFileAlloc(arena_allocator, file_path, 10 * 1024 * 1024) catch continue;
        const tree = parse.parseSource(arena_allocator, source, file_path) catch continue;
        defer if (tree) |t| t.deinit();

        if (tree) |t| {
            const root = t.rootNode();
            const tokens = duplication.tokenizeTree(arena_allocator, root, source) catch continue;
            file_tokens_list.append(arena_allocator, duplication.FileTokens{
                .path = file_path,
                .tokens = tokens,
            }) catch continue;
        }
    }

    dup_result = duplication.detectDuplication(
        arena_allocator,
        file_tokens_list.items,
        dup_config,
    ) catch null;
}
```

Note: The re-parse approach is simpler than pre-tokenizing in workers (per RESEARCH.md recommendation). The `parse.parseSource` function may need to be used — check what parse.zig exports. If `parseSource` doesn't exist as a standalone function, use the parser/tree_sitter API directly:
```zig
const tree_sitter = @import("parser/tree_sitter.zig");
const ts_parser = tree_sitter.Parser.init() catch continue;
defer ts_parser.deinit();
const lang = tree_sitter.detectLanguage(file_path) catch continue;
ts_parser.setLanguage(lang) catch continue;
const tree = ts_parser.parseString(source) orelse continue;
defer tree.deinit();
```

**Add `buildDuplicationConfig` helper** in main.zig:
```zig
fn buildDuplicationConfig(cfg: config_mod.Config) duplication.DuplicationConfig {
    var dc = duplication.DuplicationConfig{};
    if (cfg.analysis) |a| {
        if (a.thresholds) |t| {
            if (t.duplication) |d| {
                dc.file_warning_pct = d.file_warning orelse dc.file_warning_pct;
                dc.file_error_pct = d.file_error orelse dc.file_error_pct;
                dc.project_warning_pct = d.project_warning orelse dc.project_warning_pct;
                dc.project_error_pct = d.project_error orelse dc.project_error_pct;
            }
        }
    }
    return dc;
}
```

**scoring.zig — 5-weight normalization:**
- Add `duplication: f64` field to `EffectiveWeights` struct (default 0.0)
- Update `resolveEffectiveWeights` to accept an additional `duplication_enabled: bool` parameter:
  - When `duplication_enabled = true`: include duplication weight (default 0.20) and normalize all 5 weights to sum 1.0
  - When `duplication_enabled = false`: set duplication weight to 0.0 and normalize 4 weights only (existing behavior)
- Add `normalizeDuplication(duplication_pct: f64, warning: f64, err: f64) f64` function:
  - Score = 100 - duplication_pct, but use sigmoid smoothing: `sigmoidScore(duplication_pct, warning, computeSteepness(warning, err))`
- Update `computeFunctionScore` — function-level scoring does NOT include duplication (duplication is file-level, not function-level). Keep function scoring unchanged.
- Add `computeFileScoreWithDuplication(function_scores: []const f64, dup_score: f64, weights: EffectiveWeights) f64`:
  - If duplication weight > 0: blend file score with duplication score
  - `final_score = base_file_score * (1.0 - weights.duplication) + dup_score * weights.duplication`

**Update main.zig project score computation** to use duplication-aware scoring when enabled:
- After duplication pass, if dup_result is not null, recompute file scores blending duplication
- Update `resolveEffectiveWeights` call to pass `duplication_enabled`

**Threshold application for duplication:**
- In the duplication result, each `FileDuplicationResult` gets warning/error flags based on config thresholds
- Project-level duplication percentage gets warning/error flags
- These are used by exit_codes and output formatters (wired in Plan 03)

**Add duplication warning/error counts to totals:**
- If duplication is enabled and dup_result exists, add duplication violations to `total_warnings` and `total_errors` counters based on file-level and project-level threshold status

Run `zig build test` to verify all existing tests still pass plus new tests.

Commit: `feat(11-02): wire duplication into pipeline, scoring, and threshold system`
  </action>
  <verify>`zig build test` passes. Running `zig build run -- --duplication tests/fixtures/` shows duplication analysis executing (even if output formatting is not yet complete — the analysis runs without crashing). Scoring tests still pass with backward-compatible 4-weight mode.</verify>
  <done>Duplication detection runs in the main.zig pipeline when --duplication flag is set. Health score integrates duplication weight when enabled. Configurable thresholds applied to file and project duplication percentages. Existing tests unaffected.</done>
</task>

</tasks>

<verification>
1. `zig build test` — all tests pass (including scoring tests with updated EffectiveWeights)
2. `zig build run -- --duplication tests/fixtures/` — runs without crash, duplication analysis executes
3. `zig build run -- tests/fixtures/` — without --duplication, zero duplication overhead (no re-parsing)
4. Config file with `"analysis": {"duplication_enabled": true}` enables duplication
5. `--metrics duplication` enables duplication
6. Health score computation includes duplication weight when enabled
</verification>

<success_criteria>
- --duplication flag parsed and enables duplication analysis
- DuplicationThresholds configurable via config file
- main.zig calls detectDuplication after per-file analysis when enabled
- scoring.zig supports 5-weight normalization with duplication
- File and project duplication percentages computed with threshold status
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-duplication-detection/11-02-SUMMARY.md`
</output>
