---
phase: 17-project-setup-and-parser-foundation
plan: 03
type: execute
wave: 2
depends_on:
  - "17-01"
files_modified:
  - .github/workflows/rust-ci.yml
autonomous: true
requirements:
  - PARSE-01
  - PARSE-02
  - PARSE-03
  - PARSE-04

must_haves:
  truths:
    - "GitHub Actions CI builds the Rust crate and runs cargo test on push to the rust branch"
    - "CI cross-compiles to x86_64-unknown-linux-musl target successfully"
    - "CI measures and reports the release binary size for both native and musl targets"
  artifacts:
    - path: ".github/workflows/rust-ci.yml"
      provides: "CI workflow for Rust crate: build, test, cross-compile, binary size measurement"
      min_lines: 40
  key_links:
    - from: ".github/workflows/rust-ci.yml"
      to: "rust/Cargo.toml"
      via: "cargo commands in rust/ working directory"
      pattern: "working-directory.*rust"
---

<objective>
Add a GitHub Actions CI workflow that builds the Rust crate, runs tests, cross-compiles to linux-musl, and measures binary size. This validates that the grammar crate C compilation works on CI and that cross-compilation is functional.

Purpose: The Phase 17 success criteria require "at least one cross-compilation target builds successfully in CI." Validating this early prevents discovering CI-specific build failures in Phase 22. Binary size is tracked from the first phase.
Output: CI workflow file that runs on push to the `rust` branch.
</objective>

<execution_context>
@/Users/benvds/.claude/get-shit-done/workflows/execute-plan.md
@/Users/benvds/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-project-setup-and-parser-foundation/17-RESEARCH.md
@.planning/phases/17-project-setup-and-parser-foundation/17-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions CI workflow for Rust crate</name>
  <files>
    .github/workflows/rust-ci.yml
  </files>
  <action>
Create `.github/workflows/rust-ci.yml` with the following jobs:

**Trigger:** Push to `rust` branch, and pull requests targeting `main` that modify `rust/**` files.

**Job 1: build-and-test**
- Runs on: `ubuntu-latest` and `macos-latest` (matrix)
- Steps:
  1. Checkout repository
  2. Install Rust stable toolchain (use `dtolnay/rust-toolchain@stable`)
  3. Cache cargo registry and build artifacts (use `Swatinem/rust-cache@v2` with `workspaces: "rust"`)
  4. `cargo fmt --check` in `rust/` (formatting gate)
  5. `cargo clippy -- -D warnings` in `rust/` (lint gate)
  6. `cargo test` in `rust/` (all tests)
  7. `cargo build --release` in `rust/`
  8. Print binary size: `ls -lh rust/target/release/complexity-guard`
  9. Run the binary: `rust/target/release/complexity-guard`

**Job 2: cross-compile-linux-musl**
- Runs on: `ubuntu-latest`
- Steps:
  1. Checkout repository
  2. Install Rust stable toolchain with `x86_64-unknown-linux-musl` target added
  3. Install musl-tools: `sudo apt-get install -y musl-tools`
  4. Cache cargo build artifacts
  5. `cargo build --release --target x86_64-unknown-linux-musl` in `rust/`
  6. Print binary size: `ls -lh rust/target/x86_64-unknown-linux-musl/release/complexity-guard`
  7. Run the binary (musl static binary runs on Linux): `rust/target/x86_64-unknown-linux-musl/release/complexity-guard`

**Key details:**
- All `cargo` commands use `working-directory: rust`
- Use `CARGO_TERM_COLOR: always` env var for colored CI output
- Do NOT use cargo-zigbuild yet — the musl target with `--target x86_64-unknown-linux-musl` plus `musl-tools` is simpler for the Phase 17 smoke test. cargo-zigbuild will be set up in Phase 22 for the full release matrix.
- Do NOT add Windows cross-compilation — that is Phase 22 scope.

**Note:** If the `cross-compile-linux-musl` job fails because tree-sitter grammar C compilation requires additional C compiler configuration for the musl target, add `CC=musl-gcc` environment variable. The tree-sitter grammar crates use the `cc` crate internally which respects the `CC` env var.
  </action>
  <verify>
    <automated>cat /Users/benvds/code/complexity-guard/.github/workflows/rust-ci.yml | head -5 && echo "WORKFLOW EXISTS"</automated>
    <manual>Push to rust branch and verify GitHub Actions runs successfully. Check that both native and musl builds succeed, and binary sizes are printed in the CI log.</manual>
  </verify>
  <done>
    - `.github/workflows/rust-ci.yml` exists with build-and-test and cross-compile-linux-musl jobs
    - Workflow triggers on push to `rust` branch and PRs modifying `rust/**`
    - CI runs `cargo fmt --check`, `cargo clippy`, `cargo test`, and `cargo build --release`
    - Cross-compilation to `x86_64-unknown-linux-musl` is configured
    - Binary size is printed for both native and musl release builds
  </done>
</task>

</tasks>

<verification>
1. `.github/workflows/rust-ci.yml` exists and is valid YAML
2. Workflow defines two jobs: build-and-test (matrix) and cross-compile-linux-musl
3. All cargo commands specify `working-directory: rust`
4. Workflow triggers on push to `rust` branch
5. After push: CI runs green on GitHub (manual verification after push)
</verification>

<success_criteria>
- GitHub Actions workflow file is committed and syntactically valid
- CI pipeline builds, tests, and cross-compiles the Rust crate when pushed to the rust branch
- Binary size is reported in CI logs for tracking across phases
</success_criteria>

<output>
After completion, create `.planning/phases/17-project-setup-and-parser-foundation/17-03-SUMMARY.md`
</output>
