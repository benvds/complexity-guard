---
phase: 17-project-setup-and-parser-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - rust/Cargo.toml
  - rust/Cargo.lock
  - rust/src/main.rs
  - rust/src/types.rs
  - rust/.gitignore
  - .gitignore
autonomous: true
requirements:
  - PARSE-01
  - PARSE-02
  - PARSE-03
  - PARSE-04

must_haves:
  truths:
    - "cargo build compiles without errors or warnings in rust/ directory"
    - "cargo build --release compiles with size-optimized profile and binary size is measured and recorded"
    - "cargo tree -d shows zero duplicate tree-sitter dependency versions"
    - "All four grammar crates (tree-sitter-typescript for TS+TSX, tree-sitter-javascript for JS+JSX) are declared and resolve correctly"
  artifacts:
    - path: "rust/Cargo.toml"
      provides: "Crate manifest with grammar crates, thiserror, anyhow, and size-optimized release profile"
      contains: "tree-sitter"
    - path: "rust/src/types.rs"
      provides: "ParseResult, FunctionInfo, ParseError types with only owned data"
      contains: "pub struct ParseResult"
    - path: "rust/src/main.rs"
      provides: "Entry point stub that confirms binary runs"
      min_lines: 3
  key_links:
    - from: "rust/Cargo.toml"
      to: "tree-sitter grammar crates"
      via: "dependency declaration"
      pattern: "tree-sitter-typescript.*0\\.23"
---

<objective>
Scaffold the Rust crate in a `rust/` subdirectory with all grammar dependencies, size-optimized release profile, and core data types. Confirm grammar version alignment with zero duplicates.

Purpose: Establish the foundation for the entire Rust rewrite — grammar version mismatches and binary size profile must be resolved before any parser or metric code exists. The `rust/` subdirectory keeps Zig v1.0 untouched.
Output: Compiling Rust crate with correct dependencies, owned data types, and measured release binary size.
</objective>

<execution_context>
@/Users/benvds/.claude/get-shit-done/workflows/execute-plan.md
@/Users/benvds/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-project-setup-and-parser-foundation/17-RESEARCH.md
@.planning/research/STACK.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Rust crate with grammar dependencies, types, and release profile</name>
  <files>
    rust/Cargo.toml
    rust/src/main.rs
    rust/src/types.rs
    rust/.gitignore
    .gitignore
  </files>
  <action>
Create the `rust/` directory at the repository root.

**rust/Cargo.toml:**
```toml
[package]
name = "complexity-guard"
version = "0.8.0"
edition = "2021"
rust-version = "1.80"

[dependencies]
tree-sitter = "0.26"
tree-sitter-typescript = "0.23"
tree-sitter-javascript = "0.25"
thiserror = "2"
anyhow = "1"

[profile.release]
opt-level = "z"
lto = true
codegen-units = 1
strip = true
panic = "abort"
```

**rust/src/main.rs:**
Minimal entry point that prints version and exits. Just enough to confirm the binary compiles and runs:
```rust
fn main() {
    println!("complexity-guard v0.8.0");
}
```
Import `types` module so it is compiled: `mod types;`

**rust/src/types.rs:**
Define the core types for the parser phase. All types must contain only owned data (String, PathBuf, Vec, usize) — no references to tree-sitter Node or Tree. This is critical for later cross-thread use (Phase 20).

- `FunctionInfo` struct: `name: String`, `start_line: usize` (1-indexed), `start_column: usize` (0-indexed), `end_line: usize` (1-indexed)
- `ParseResult` struct: `path: PathBuf`, `functions: Vec<FunctionInfo>`, `source_len: usize`, `has_error: bool`
- `ParseError` enum using `#[derive(thiserror::Error, Debug)]`:
  - `UnsupportedExtension(String)` — file extension not recognized
  - `NoExtension` — file has no extension
  - `IoError(#[from] std::io::Error)` — file read failure
  - `LanguageError(String)` — tree-sitter language setup failure
  - `ParseFailed` — tree-sitter returned None from parse()

Derive `Debug, Clone` on FunctionInfo and ParseResult.

**rust/.gitignore:**
```
/target/
```

**Update root .gitignore:**
Add `rust/target/` entry if not already present, to ensure the Rust build directory is excluded.
  </action>
  <verify>
    <automated>cd /Users/benvds/code/complexity-guard/rust && cargo build 2>&1 && cargo build --release 2>&1 && echo "BUILD OK"</automated>
    <manual>Verify rust/ directory exists with Cargo.toml, src/main.rs, src/types.rs</manual>
  </verify>
  <done>
    - `cargo build` compiles without errors in rust/ directory
    - `cargo build --release` compiles with size-optimized profile
    - types.rs contains ParseResult, FunctionInfo, ParseError with only owned data (no tree-sitter references)
    - .gitignore excludes rust/target/
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify grammar version alignment and measure baseline binary size</name>
  <files>
    rust/Cargo.lock
  </files>
  <action>
Run `cargo tree -d` in the `rust/` directory. Expected output: empty (no duplicate versions). If duplicates appear for tree-sitter, add version pinning using `[patch.crates-io]` or explicit version bounds to align all grammar crates to the same tree-sitter version.

After confirming zero duplicates:
1. Run `cargo build --release` in `rust/`
2. Measure binary size: `ls -lh rust/target/release/complexity-guard`
3. Record the measured size in a brief comment at the top of `rust/Cargo.toml` as a documentation marker: `# v0.8.0 baseline binary size: X.X MB (Phase 17, macOS arm64)` (adjust platform to actual)
4. Run the binary to confirm it executes: `./rust/target/release/complexity-guard`
5. Commit `Cargo.lock` to the repo (required for binary crates)

If `cargo tree -d` shows duplicates, resolve them before proceeding. The most likely fix is adjusting the version specifier for tree-sitter in Cargo.toml to match what the grammar crates resolve to.
  </action>
  <verify>
    <automated>cd /Users/benvds/code/complexity-guard/rust && cargo tree -d 2>&1 | grep -c "tree-sitter" | xargs -I{} test {} -eq 0 && echo "NO DUPLICATES" && ls -lh target/release/complexity-guard && ./target/release/complexity-guard</automated>
    <manual>Check that Cargo.toml has binary size comment and Cargo.lock is committed</manual>
  </verify>
  <done>
    - `cargo tree -d` shows no duplicate tree-sitter versions
    - Release binary size is measured and recorded in Cargo.toml comment
    - Binary executes and prints version string
    - Cargo.lock exists and is committed
  </done>
</task>

</tasks>

<verification>
1. `cd rust && cargo build` — compiles without errors
2. `cd rust && cargo build --release` — compiles with size-optimized profile
3. `cd rust && cargo tree -d` — no duplicate tree-sitter versions
4. `cd rust && ./target/release/complexity-guard` — prints version and exits
5. `rust/src/types.rs` contains ParseResult, FunctionInfo, ParseError — grep confirms struct definitions
6. Release binary size is documented in Cargo.toml
</verification>

<success_criteria>
- Rust crate in rust/ compiles without errors on both debug and release profiles
- Zero duplicate tree-sitter dependency versions
- Core types (ParseResult, FunctionInfo, ParseError) defined with only owned data
- Release binary size measured and recorded as v0.8 baseline
- Binary executes successfully
</success_criteria>

<output>
After completion, create `.planning/phases/17-project-setup-and-parser-foundation/17-01-SUMMARY.md`
</output>
